

<!DOCTYPE html>
<html>
  <head>
    <title>
	アクセス制御とセキュリティ :: テックまとめ
</title>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="revised" content="2022-03-18T19:03:01 JST">
<meta name="description" content="備忘録用メモサイト">



<title>アクセス制御とセキュリティ :: テックまとめ</title>

<link rel="shortcut icon" href='/images/favicon.png' type="image/x-icon" />

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css">

<script src='https://code.jquery.com/jquery-3.5.1.min.js'></script>

<link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel="stylesheet">



<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/layout.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/css/style.main.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/css/style.menu.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/notice.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/tabs.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/panel.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/columns.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/children.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/attachments.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/alert.css'>
<link rel="stylesheet" type="text/css" href='/css/docport.css'>

<script src='/js/docport.js'></script>
<script type="text/javascript">
      var baseurl = "https:\/\/tanakakns.github.io\/";
</script>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-42388425-3', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
  </head>

  <body data-url="/gcp/access-control-and-security/"

  class="hidetoc hidenextpage ">

<style type="text/css">
  #debug{
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    line-height: 3.5rem;
    margin-bottom: .35rem;
    padding: 0 2rem;
    position: fixed;
    left: 0;      right: 0;     top: 0;
   
    top:0px;
    
    min-height: 150px;

    background-color: white;
    border: 3px solid red;
    z-index: 10000 ;
    word-wrap: all;
    overflow: auto;
  }
</style>
 


    
    
    <header style="">
        <div>
    
    <div class="burger ">
        <a href="javascript:void(0);" style="font-size:15px;" onclick="$('article > aside').toggleClass('responsive')">&#9776;</a>
    </div>
    

    <div>

		
	
			
		
	    	<a class='baselink' href='https://tanakakns.github.io/'>テックまとめ</a>
	  	
	</div>

</div>
    </header>
    

    <article>
      
      <aside class="">
        

		
	
			
		
	    	
	  	
	<div id="close_menu">
  <a href="javascript:void(0);" style="font-size:15px;" onclick="$('article > aside').toggleClass('responsive')">
      <i class="fa fa-lg fa-times"></i>
  </a>
</div>

<ul class="menu">

    <li data-nav-id="https://tanakakns.github.io/design/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/design/">設計</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/design/principle-practice/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/design/principle-practice/">原理原則・ベストプラクティス</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/design/api-design/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/design/api-design/">API設計</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/design/microservices/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/design/microservices/">マイクロサービス</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/design/clean-architecture/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/design/clean-architecture/">クリーンアーキテクチャ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/design/architecture/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/design/architecture/">アーキテクチャ</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/mac/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/mac/">Mac開発環境</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/mac/os-settings/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/mac/os-settings/">OSの設定</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/mac/homebrew/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/mac/homebrew/">Homebrew</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/mac/asdf/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/mac/asdf/">asdf</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/git/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/git/">Git</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/git/initial-setting/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/git/initial-setting/">初期設定</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/java/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/java/">Java</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/java/initial-setting/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/java/initial-setting/">初期設定</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/java/springframework/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/java/springframework/">Spring Framework</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/go/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/go/">Go言語</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/go/initial-setting/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/go/initial-setting/">初期設定</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/go/go-modules/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/go/go-modules/">Go Modules</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/go/grammar/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/go/grammar/">文法</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/go/naming/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/go/naming/">命名規則</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/go/pattern/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/go/pattern/">パターン</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/database/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/database/">Database</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/database/rdb/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/database/rdb/">RDB</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/aws/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/aws/">AWS</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/aws/well-architected-framework/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/well-architected-framework/">AWS Well-Architected フレームワーク</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/computing/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/computing/">コンピューティング</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/aws/computing/ec2/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/computing/ec2/">EC2</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/container/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/container/">コンテナ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/storage/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/storage/">ストレージ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/database/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/database/">データベース</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/aws/database/aurora/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/database/aurora/">Aurora</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/migration/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/migration/">移行と転送</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/networking/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/networking/">ネットワーキングとコンテンツ配信</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/aws/networking/vpc/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/networking/vpc/">VPC</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/dev-tools/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/dev-tools/">開発者用ツール</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/security/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/security/">セキュリティ</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/aws/security/iam/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/security/iam/">IAM</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/aws-cli/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/aws-cli/">AWS CLI</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/gcp/" class="dd-item parent haschildren
        item_level_$level
        ">

      
      
      
      
          <i class="fas fa-chevron-down ddexp"></i>
        
      
          <a href="/gcp/">GCP</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/gcp-aws/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/gcp-aws/">GCP と AWS の比較</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/monitoring/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/monitoring/">監視</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/tools/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/tools/">ツール</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/tools/management-tools/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/tools/management-tools/">管理ツール</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/tools/dev-tools/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/tools/dev-tools/">開発ツール</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/access-control-and-security/" class="dd-item parent active
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/access-control-and-security/">アクセス制御とセキュリティ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/">コンピューティングとホスティング</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/compute-engine/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/compute-engine/">Compute Engine</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/kubernetes-engine/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/kubernetes-engine/">Google Kubernetes Engine</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/app-engine/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/app-engine/">App Engine</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/cloud-functions/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/cloud-functions/">Cloud Functions</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/storage/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/storage/">ストレージ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/">データベース</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/bigquery/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/bigquery/">BigQuery</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/sql/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/sql/">Cloud SQL</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/memorystore/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/memorystore/">Memorystore</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/spanner/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/spanner/">Cloud Spanner</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/">ネットワーキング</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/vpc/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/vpc/">VPC</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/load-balancing/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/load-balancing/">Cloud Load Balancing</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/iap/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/iap/">Identity-Aware Proxy</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/interconnect/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/interconnect/">Cloud Interconnect</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/big-data/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/big-data/">ビッグデータ</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/big-data/pubsub/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/big-data/pubsub/">Cloud Pub/Sub</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/big-data/dataflow/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/big-data/dataflow/">Dataflow</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/machine-learning/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/machine-learning/">機械学習</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/terraform/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/terraform/">Terraform</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/terraform/basic/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/terraform/basic/">入門</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/terraform/google-cloud/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/terraform/google-cloud/">Google Cloud</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/docker/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/docker/">Docker</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/docker/basic/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/docker/basic/">入門</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/kubernetes/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/kubernetes/">Kubernetes</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/concept/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/concept/">概念整理</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/architecture/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/architecture/">アーキテクチャ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/kubectl-plugin/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/kubectl-plugin/">kubectl plugin と Krew</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/command/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/command/">コマンド</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/manifest/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/manifest/">マニフェスト</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/application-management/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/application-management/">アプリケーション管理</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/cluster-management/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/cluster-management/">クラスタ管理</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/security/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/security/">セキュリティ</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/istio/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/istio/">Istio</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/istio/basic/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/istio/basic/">入門</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/istio/concept/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/istio/concept/">概念整理</a>
      
        
      
    </li>
        </ul>
    </li>
    



</ul>

		
	
			
		
	    	
	  	
	
      </aside>
      

      <section class="page ">
      
	
		
    
    
    <nav id="ariane" aria-label="breadcrumb">
      <ol class="ariane">
        
  
  	
		
  
  	
	<li >
      <a class="text-link" href="https://tanakakns.github.io/">
        
      </a>
    </li>
	
  
    <li class="">
      <a class="text-link" href="/gcp/">
        GCP
      </a>
    </li>
	
  	
  
    <li class="active">
      
        アクセス制御とセキュリティ
      
    </li>

      </ol>
    </nav>
    
    

    
		
        
		
		
		
		
		
		
		

		
			<h1>アクセス制御とセキュリティ</h1>
        

		
										
		

		
	

	
	
	






	<div class="content">
	    <ol>
<li><a href="#1-%E3%82%B3%E3%83%B3%E3%82%BB%E3%83%97%E3%83%88">コンセプト</a></li>
<li><a href="#3-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E9%9A%8E%E5%B1%A4%E3%81%A8%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E5%88%B6%E5%BE%A1">リソース階層とアクセス制御</a></li>
<li><a href="#3-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AE%E7%AE%A1%E7%90%86">リソースの管理</a></li>
<li><a href="#4-cloud-kms">Cloud KMS</a></li>
<li><a href="#5-%E3%82%B3%E3%82%B9%E3%83%88%E7%AE%A1%E7%90%86">コスト管理</a></li>
<li><a href="#6-%E3%83%A6%E3%83%BC%E3%82%B9%E3%82%B1%E3%83%BC%E3%82%B9">ユースケース</a></li>
</ol>
<h2 ref="1-コンセプト" >1. コンセプト</h2><a class="anchor" id="1-コンセプト"></a>
<ul>
<li><a href="https://cloud.google.com/compute/docs/regions-zones/">リージョンとゾーン</a> ※<a href="https://cloud.google.com/docs/geography-and-regions?hl=ja">地域とリージョン</a>
<ul>
<li>一部の Compute Engine リソースは、リージョン内またはゾーン内にのみ存在する</li>
<li><strong>リージョン</strong> とはリソースを実行できる特定の地理的な場所で、各リージョンには、1 つまたは複数の <strong>ゾーン</strong>がある
<ul>
<li>たとえば、リージョン <code>us-central1</code> は米国中部を指し、ゾーン <code>us-central1-a</code>、<code>us-central1-b</code>、<code>us-central1-c</code>、<code>us-central1-f</code> が含まれる</li>
</ul>
</li>
<li>ゾーンは、リージョン内の単一の障害ドメインとみなすことができる
<ul>
<li>GCP のゾーンは、 AWS でいう AZ：アベイラビリティゾーン</li>
</ul>
</li>
</ul>
</li>
<li>リソース
<ul>
<li>リソースは大きく、 <strong>グローバルリソース</strong> （マルチリージョンリソース）、 <strong>リージョンリソース</strong> 、 <strong>ゾーンリソース</strong> の 3 つのスコープに分類され、アクセス可能なリソースが決まる（ <a href="https://cloud.google.com/compute/docs/regions-zones/global-regional-zonal-resources?hl=ja">詳細</a> ）</li>
<li>グローバルリソースには同じプロジェクトにある任意のリージョンまたはゾーンのリソースからアクセスできる</li>
<li>リージョンリソースにアクセスできるのは、同じリージョン内のリソースだけ
<ul>
<li>インスタンスに静的 IP アドレスを割り当てるには、インスタンスが静的 IP と同じリージョンに存在している必要がある</li>
</ul>
</li>
<li>ゾーンリソースにアクセスできるのは、同じゾーン内のリソースだけ
<ul>
<li>永続ディスクをインスタンスに接続するには、両リソースを同ゾーンに配置する必要がある</li>
</ul>
</li>
</ul>
</li>
<li><strong>プロジェクト</strong>
<ul>
<li>リソースと課金を管理する単位
<ul>
<li>請求先アカウントをリンクすることで課金が有効</li>
<li><a href="https://cloud.google.com/products/calculator?hl=ja">Pricing Calculator</a>（コスト見積のための Web UI）</li>
</ul>
</li>
<li>すべての GCP リソースは 1 つのプロジェクトに関連付けられる</li>
<li>各種設定と権限も含まれており、これを使用して、セキュリティルールとどのアカウントがどのリソースにアクセスできるかが指定される
<ul>
<li><a href="https://cloud.google.com/vpc/docs/shared-vpc?hl=ja">共有 VPC</a> または <a href="https://cloud.google.com/vpc/docs/vpc-peering?hl=ja">VPC ネットワークピアリング</a>を使用しない限り、あるプロジェクトが別のプロジェクトのリソースにアクセスすることはできない</li>
</ul>
</li>
<li>複数のプロジェクトを束ねて管理するには <a href="https://cloud.google.com/resource-manager/docs/creating-managing-organization?hl=ja">組織</a> を使う</li>
<li>プロジェクトは <strong>プロジェクト名</strong> （任意のプロジェクト表示名）、 <strong>プロジェクトID</strong> （カスタマイズ可能な識別子）、 <strong>プロジェクト番号</strong> （GCPから割り当てられる識別子）からなる</li>
</ul>
</li>
</ul>
<h2 ref="2-リソース階層とアクセス制御" >2. リソース階層とアクセス制御</h2><a class="anchor" id="2-リソース階層とアクセス制御"></a>
<ul>
<li><a href="https://cloud.google.com/iam/docs/overview?hl=ja">ここの説明</a> が全て</li>
<li>理解の補足
<ul>
<li><a href="https://medium.com/google-cloud-jp/gcp-iam-beginner-b2e1ef7ad9c2">GCP の IAM をおさらいしよう</a></li>
<li><a href="https://medium.com/google-cloud-jp/google-cloud-access-management-40963bea0dfc">Google Cloud のアクセス管理をおさらいしよう 2020アップデート版</a></li>
</ul>
</li>
<li>関係無いけど読むといいかも記事
<ul>
<li><a href="https://medium.com/google-cloud-jp/google-cloud-japan-customer-engineer-advent-calendar-2020-1c78e07e1871">Google Cloud Japan Customer Engineer Advent Calendar 2020</a></li>
<li><a href="https://medium.com/google-cloud-jp/gcp-ce-advent-calendar-2019-1aeb8ebda7b1">Google Cloud Japan Customer Engineer Advent Calendar 2019</a></li>
</ul>
</li>
</ul>
<h3 ref="21-cloud-identity-and-access-managementcloud-iam" >2.1. Cloud Identity and Access Management（Cloud IAM）</h3><a class="anchor" id="21-cloud-identity-and-access-managementcloud-iam"></a>
<p><a href="https://cloud.google.com/iam/docs/how-to?hl=ja">Cloud Identity and Access Management（Cloud IAM）</a> は、「誰が」「どういう操作を」「何に対して」行う権限を持つかを管理するサービス。<br>
キーワードとしては以下のように整理できる。</p>
<ul>
<li><strong>メンバー</strong>
<ul>
<li>「誰が」</li>
</ul>
</li>
<li><strong>ロール</strong>
<ul>
<li>「どういう操作を」「何に対して」</li>
<li>権限のコレクションであり、権限によってリソースに対して許可されているオペレーションが決まる</li>
<li>メンバーに対して付与する</li>
</ul>
</li>
<li><strong>ポリシー</strong> / IAM ポリシー
<ul>
<li>1 つ以上のメンバーを 1 つのロールにバインドした一覧（「誰が」「どういう操作を」「何に対して」全て含まれる）</li>
<li>IAM ポリシーは IAM Policy オブジェクトによって表現され、バインディング リストで構成され（ <code>Binding</code> は、<code>members</code> のリストを <code>role</code> にバインドする）</li>
<li>このポリシーを <strong>組織</strong> ・ <strong>フォルダ</strong> ・ <strong>プロジェクト</strong> に設定する</li>
</ul>
</li>
</ul>
<p>Cloud Console の 「サイドメニュー」-&gt;「 IAM と管理」-&gt;「 IAM 」から利用できる。</p>
<h3 ref="22-メンバー" >2.2. メンバー</h3><a class="anchor" id="22-メンバー"></a>
<p>リソースへのアクセスが許可される主体（「誰が」）には以下がある。</p>
<ul>
<li><strong>Google アカウント</strong> （ <code>user:xxxx</code> の形式）
<ul>
<li>Gmail アカウント（ <code>@gmail.com</code> ）や Google アカウントに関連づけられているメールアドレス</li>
<li>あまり知られていないが、任意のメールアドレスを <a href="https://accounts.google.com/signup?hl=ja">Google アカウント登録ページ</a>から Google アカウントとして登録できる
<ul>
<li>つまり、 <code>@gmail.com</code> じゃなくてもいい</li>
</ul>
</li>
</ul>
</li>
<li><strong>サービスアカウント</strong> （ <code>serviceAccount:xxxx</code> の形式）
<ul>
<li>個々のエンドユーザではなく、アプリケーションのアカウント</li>
<li><code>[サービスアカウント]@[プロジェクトID].iam.gserviceaccount.com</code></li>
</ul>
</li>
<li><strong>Google グループ</strong> （ <code>group:xxxx</code> の形式）
<ul>
<li>Google アカウントとサービスアカウントの名前付きコレクション</li>
<li>グループ固有のメールアドレスが関連付けられている（ <a href="https://groups.google.com/?hl=ja">Google グループ</a> ）</li>
</ul>
</li>
<li><strong>Google Workspace ドメイン</strong> （ <code>domain:xxxx</code> の形式）
<ul>
<li><a href="https://workspace.google.com/?hl=ja">Google Workspace</a> （旧 G Suite）で作成された <strong>組織</strong> のインターネットドメイン（ <code>example.com</code> など ）</li>
<li>Google Workspace ドメインにユーザーを追加すると、この <strong>組織</strong> のドメインでユーザアカウントが作成できる（ <code>username@example.com</code> など）</li>
<li>そしてこれが  Google アカウントの仮想グループとなる</li>
</ul>
</li>
<li><strong>Cloud Identity ドメイン</strong> （ <code>domain:xxxx</code> の形式）
<ul>
<li>Google Workspace ドメインに似ているが、 Drive、Meet、Docs といった Google Workspace のツール類は利用できない</li>
<li>アカウント管理（ <code>username@example.com</code> など）や仮想グループ（ <code>example.com</code> など ）だけ</li>
</ul>
</li>
<li><strong>認証済みのすべてのユーザー</strong>
<ul>
<li>すべてのサービス アカウント、および Google アカウントで認証されたユーザー全員を表す特殊な識別子 <code>allAuthenticatedUsers</code></li>
</ul>
</li>
<li><strong>全ユーザー</strong>
<ul>
<li>認証されたユーザーと認証されていないユーザーの両方を含めて、インターネット上のユーザーを表す特殊な識別子 <code>allUsers</code></li>
</ul>
</li>
</ul>
<p><strong>Google アカウント</strong> は <strong>個人管理</strong> と <strong>企業管理</strong> のものがある。<br>
前者は個人の Gmail アカウントや任意のメールアドレスを個人利用の Google アカウントとして登録したもの。<br>
後者は会社が Google Workspace を導入している場合、そのユーザアカウントをそのまま利用できる。社外のユーザが GCP 環境にアクセスする場合は Cloud Identity を利用してユーザ管理することもできる。</p>
<p><img src="./img/google_account.png" alt="google_account"></p>
<p>サービスアカウントについて以下で補足する。</p>
<ul>
<li>アプリケーションやサーバのための ID</li>
<li><code>gcloud iam service-accounts create SERVICE_ACCOUNT_ID</code> でサービスアカウントを作成する</li>
<li>サービスアカウントによって使われるキーは自動的に管理され、ユーザがキーを作成・ダウンロードすることも可能</li>
<li>サービスアカウント自体もリソースで、人が「サービスアカウントとして実行」もできる
<ul>
<li>JSONをダウンロードして <code>gcloud auth activate-service-account --key-file credentials.json</code> する？</li>
</ul>
</li>
</ul>
<h3 ref="23-権限とロール" >2.3. 権限とロール</h3><a class="anchor" id="23-権限とロール"></a>
<h4 ref="231-権限" >2.3.1. 権限</h4><a class="anchor" id="231-権限"></a>
<p>リソースに対する操作の <strong>権限</strong> は以下の命名規則で表現される。（多くの場合、権限は REST API メソッドと 1 対 1 で対応している）<br>
リソースの例として、プロジェクト、Compute Engine インスタンス、Cloud Storage バケットなどがある。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&lt;サービス名&gt;.&lt;リソース&gt;.&lt;動詞&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>例
</span></span><span style="display:flex;"><span>compute.instance.delete
</span></span><span style="display:flex;"><span>compute.instance.start
</span></span><span style="display:flex;"><span>compute.instance.setMachineType
</span></span></code></pre></div><h4 ref="231-ロール" >2.3.1. ロール</h4><a class="anchor" id="231-ロール"></a>
<p><strong>ロール</strong> は権限のコレクション。<br>
<code>roles/service.roleName</code> の形式で指定し、たとえば、Cloud Storage には <code>roles/storage.objectAdmin</code> 、 <code>roles/storage.objectCreator</code> 、 <code>roles/storage.objectViewer</code> などのロールがある。<br>
ロールには以下の種類がある。（ <a href="https://cloud.google.com/iam/docs/understanding-roles/#primitive%5C_roles">詳細</a> ）</p>
<ul>
<li><strong>基本ロール</strong>
<ul>
<li><strong>プロジェクト</strong> リソースに対する権限のコレクション</li>
<li>「オーナー」「編集者」「閲覧者」「参照者」がある</li>
<li>基本ロールには、すべての Google Cloud サービスにかかわる何千もの権限が含まれるため、基本的には付与しない
<ul>
<li>代わりに、ニーズに合わせて最も制限された 事前定義ロール または カスタムロール を付与すること</li>
</ul>
</li>
</ul>
</li>
<li><strong>事前定義ロール</strong>
<ul>
<li>1 つの <strong>サービス</strong> リソースに対する権限コレクション</li>
<li>「&lt;サービス名&gt;オーナー」「&lt;サービス名&gt;編集者」「&lt;サービス名&gt;閲覧者」のような名前のがある</li>
<li>たとえば、Pub/Sub パブリッシャーの事前定義ロールは <code>roles/pubsub.publisher</code></li>
</ul>
</li>
<li><strong>カスタムロール</strong>
<ul>
<li>自作する権限のコレクション</li>
<li>バケット一覧は取得できないが、特定のバケットには書き込める、とか自由</li>
</ul>
</li>
</ul>
<p>権限付与には <strong>最小権限の原則</strong> （より細かいロールで必要最低限の権限のみ付与する） を適用すること。<br>
また、異なる権限を必要とする複数のサービスがある場合は、サービス毎に個別のサービスアカウントを作成し、各サービスアカウントに必要な権限のみ付与すること。<br>
なお、基本ロールのそれぞれの権限は以下の通り。</p>
<table>
<thead>
<tr>
<th style="text-align:left">ロール名</th>
<th style="text-align:left">権限</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">オーナー（ <code>roles/owner</code> ）</td>
<td style="text-align:left">全リソースへの完全なアクセス権。プロジェクトの課金情報を設定する。</td>
</tr>
<tr>
<td style="text-align:left">編集者（ <code>roles/editor</code> ）</td>
<td style="text-align:left">全リソースへの編集アクセス権。閲覧者権限と既存のリソースに対する変更の権限。</td>
</tr>
<tr>
<td style="text-align:left">閲覧者（ <code>roles/viewer</code> ）</td>
<td style="text-align:left">全リソースへの読み取りアクセス権。状態に影響しない読み取り専用アクションに必要な権限。</td>
</tr>
<tr>
<td style="text-align:left">参照者（ <code>roles/browser</code> ）</td>
<td style="text-align:left">GCP リソースを参照するためのアクセス権。プロジェクトのリソースを表示する権限はない。</td>
</tr>
</tbody>
</table>
<p>Identity and Access Management API または gcloud コマンドライン ツールを使用して、プロジェクトのメンバーにオーナーロールを付与することはできない。オーナーは、 <strong>Cloud Console を使用することによってのみ</strong> プロジェクトに追加できます。</p>
<p>事前定義ロールおよびカスタムロールのメタデータを確認する場合、 <code>gcloud iam roles describe ROLE_ID</code> コマンドで確認する。<br>
<a href="https://cloud.google.com/iam/docs/understanding-roles?hl=ja#predefined_roles">事前定義ロールの一覧</a></p>
<h3 ref="24-リソース階層" >2.4. リソース階層</h3><a class="anchor" id="24-リソース階層"></a>
<p><a href="https://cloud.google.com/billing/docs/concepts#resource_overview">リソース</a> は「 <strong>組織 &gt; フォルダ &gt; プロジェクト &gt; リソース</strong> 」のような階層構造に <strong>まとめる</strong> ことができる。</p>
<ul>
<li>組織
<ul>
<li>Google Cloud リソース階層のルートノード</li>
<li>組織に適用されるポリシーは、組織のすべてのリソースの階層全体に適用される</li>
<li>組織管理者はすべてのリソースを集中てきに管理する</li>
</ul>
</li>
<li>フォルダ
<ul>
<li>プロジェクトをグループ化し、まとめて管理</li>
<li>フォルダ内にはプロジェクトや他のフォルダを作成できる</li>
<li>組織構造に合わせて使用できる</li>
</ul>
</li>
<li>プロジェクト
<ul>
<li>ポリシーは基本的にプロジェクト以上の階層に割り当てる</li>
<li>そして、上位に設定されたポリシーは下位に継承される</li>
</ul>
</li>
<li>各サービスのリソース
<ul>
<li>（省略）</li>
</ul>
</li>
</ul>
<p><img src="./img/policy-inheritance.svg" alt="リソース階層"></p>
<p>上位階層のリソースに関する権限付与について例を出すと、『「アカウント A に compute.instances.get 権限を付与したポリシー」を 組織 X に対して付与』すると、『アカウント A は 組織 X に含まれる全てのフォルダの全てのプロジェクトの VM インスタンス情報を取得できる』ようになる。</p>
<p>リソースは <a href="https://cloud.google.com/resource-manager?hl=ja">Resource Manager</a> API を利用することで管理できる。</p>
<h3 ref="25-ポリシー" >2.5. ポリシー</h3><a class="anchor" id="25-ポリシー"></a>
<p>IAM ポリシーは前述した通り、バインディング リストで構成され（ <code>Binding</code> は、<code>members</code> のリストを <code>role</code> にバインドする）、 JSON で表現すると以下のようになる。</p>
<pre tabindex="0"><code>{
  &#34;bindings&#34;: [
    {
      &#34;role&#34;: &#34;roles/storage.objectAdmin&#34;,
       &#34;members&#34;: [
         &#34;user:ali@example.com&#34;,
         &#34;serviceAccount:my-other-app@appspot.gserviceaccount.com&#34;,
         &#34;group:admins@example.com&#34;,
         &#34;domain:google.com&#34;
       ]
    },
    {
      &#34;role&#34;: &#34;roles/storage.objectViewer&#34;,
      &#34;members&#34;: [
        &#34;user:maria@example.com&#34;
      ]
    }
  ]
}
</code></pre><p>IAM ポリシーは、リソース階層の任意のレベル（組織レベル、フォルダレベル、プロジェクト レベル、リソースレベル）で設定でる。<br>
リソースは親リソースのポリシーをすべて継承する。<br>
特定のリソースに対して有効なポリシーは、そのリソースに設定されたポリシーとリソース階層の上位から継承されるポリシーを組み合わせたものとなる。<br>
例えば、組織に「 ユーザ <code>user:hoge@example.com</code> のロールは <code>roles/storage.objectViewer</code> 」というポリシーが設定されていたとすると、その下のフォルダ、さらにその下のプロジェクトでも有効になる。</p>
<h3 ref="26-アクセス制御のベストプラクティス" >2.6. アクセス制御のベストプラクティス</h3><a class="anchor" id="26-アクセス制御のベストプラクティス"></a>
<p><a href="https://cloud.google.com/iam/docs/resource-hierarchy-access-control?hl=ja#best_practices">ベストプラクティス</a></p>
<ul>
<li><strong>最小権限の原則</strong> （より細かいロールで必要最低限の権限のみ付与する）に従って Cloud IAM のロールを付与する</li>
<li><strong>事前定義ロール</strong> を使用する（適切な事前定義ロールがない場合のみ <strong>カスタムロール</strong> を使用する）</li>
<li>リソースレベルではなく、 <strong>組織またはプロジェクト</strong> レベルでポリシーを設定する</li>
<li>個々のユーザではなく、 <strong>グループ</strong> にロールを付与する
<ul>
<li><code>gcloud iam roles copy</code> コマンドを利用して既存プロジェクトのロールをグループにコピーして使ったりする</li>
</ul>
</li>
<li>ラベルを使って、リソースにアノテーションをつけ、グループ化・フィルタリングを行う</li>
<li>異なる権限を必要とする複数サービスがある場合は、サービス毎に個別のサービスアカウントを作成し、必要な権限のみ付与する</li>
</ul>
<h3 ref="27-リソースへのアクセス権の付与変更取り消しhttpscloudgooglecomiamdocsgranting-changing-revoking-accesshlja" >2.7. <a href="https://cloud.google.com/iam/docs/granting-changing-revoking-access?hl=ja">リソースへのアクセス権の付与、変更、取り消し</a></h3><a class="anchor" id="27-リソースへのアクセス権の付与変更取り消しhttpscloudgooglecomiamdocsgranting-changing-revoking-accesshlja"></a>
<p><code>gcloud</code> コマンドによるメンバのリソースに対するロールの付与について記載する。<br>
以降のパラメータについては下記の通り。</p>
<ul>
<li>GROUP： <code>projects</code> または <code>organizations</code> 。</li>
<li>RESOURCE：対象リソースの名前。</li>
<li>MEMBER：ロールを付与する対象となるメンバの識別子。 <code>member-type:id</code> の形式。（例： <code>user:my-user@example.com</code> ）</li>
<li>ROLE_ID：ロールの名前。（ <a href="https://cloud.google.com/iam/docs/understanding-roles?hl=ja#basic">基本ロール</a> 、 <a href="https://cloud.google.com/iam/docs/understanding-roles?hl=ja#predefined_roles">事前定義ロール</a> ）</li>
<li>FORMAT：json か yaml 。</li>
<li>FILE_PATH：ファイルのパス。</li>
<li>PROJECT_ID：プロジェクト ID 。</li>
</ul>
<h4 ref="271-メンバにロールを付与する" >2.7.1. メンバにロールを付与する</h4><a class="anchor" id="271-メンバにロールを付与する"></a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcloud GROUP add-iam-policy-binding RESOURCE --member<span style="color:#f92672">=</span>MEMBER --role<span style="color:#f92672">=</span>ROLE_ID
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 例：プロジェクト my-project のユーザー my-user@example.com に閲覧者の役割を付与する</span>
</span></span><span style="display:flex;"><span>$ gcloud projects add-iam-policy-binding my-project --member<span style="color:#f92672">=</span>user:my-user@example.com --role<span style="color:#f92672">=</span>roles/viewer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 例：組織 my-organization のユーザー my-user@example.com に閲覧者の役割を付与する</span>
</span></span><span style="display:flex;"><span>$ gcloud organizations add-iam-policy-binding my-organization --member<span style="color:#f92672">=</span>user:my-user@example.com --role<span style="color:#f92672">=</span>roles/viewer
</span></span></code></pre></div><h4 ref="272-メンバからロールを削除する" >2.7.2. メンバからロールを削除する</h4><a class="anchor" id="272-メンバからロールを削除する"></a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcloud GROUP remove-iam-policy-binding RESOURCE --member<span style="color:#f92672">=</span>MEMBER --role<span style="color:#f92672">=</span>ROLE_ID
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 例：プロジェクト my-project のユーザー my-user@example.com から閲覧者のロールを取り消す</span>
</span></span><span style="display:flex;"><span>$ gcloud projects remove-iam-policy-binding my-project --member<span style="color:#f92672">=</span>user:my-user@example.com --role<span style="color:#f92672">=</span>roles/viewer
</span></span></code></pre></div><h4 ref="273-ポリシーの取得" >2.7.3. ポリシーの取得</h4><a class="anchor" id="273-ポリシーの取得"></a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcloud projects get-iam-policy PROJECT_ID --format<span style="color:#f92672">=</span>FORMAT &gt; FILE_PATH
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 例</span>
</span></span><span style="display:flex;"><span>$ gcloud projects get-iam-policy my-project --format json &gt; ~/policy.json
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;bindings&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;role&#34;</span>: <span style="color:#e6db74">&#34;roles/owner&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;members&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;user:fatima@example.com&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;role&#34;</span>: <span style="color:#e6db74">&#34;roles/editor&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;members&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;serviceAccount:service-account-13@appspot.gserviceaccount.com&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;user:wei@example.com&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;etag&#34;</span>: <span style="color:#e6db74">&#34;BwUjMhCsNvY=&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;version&#34;</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>例の通り、ロールとそのロールが付与されたメンバの配列で表現される。</p>
<h4 ref="274-ポリシーの設定" >2.7.4. ポリシーの設定</h4><a class="anchor" id="274-ポリシーの設定"></a>
<p><code>gcloud projects get-iam-policy</code> で取得したポリシーの JSON/YAML を編集するなどして、以下のコマンドでポリシーを更新することができる。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcloud projects set-iam-policy PROJECT_ID FILE_PATH
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ファイル例</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;bindings&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;role&#34;</span>: <span style="color:#e6db74">&#34;roles/owner&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;members&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;user:fatima@example.com&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;role&#34;</span>: <span style="color:#e6db74">&#34;roles/editor&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;members&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;serviceAccount:service-account-13@appspot.gserviceaccount.com&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;user:wei@example.com&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 ref="28-カスタムロールの作成と管理httpscloudgooglecomiamdocscreating-custom-roleshlja" >2.8. <a href="https://cloud.google.com/iam/docs/creating-custom-roles?hl=ja">カスタムロールの作成と管理</a></h3><a class="anchor" id="28-カスタムロールの作成と管理httpscloudgooglecomiamdocscreating-custom-roleshlja"></a>
<p>ToDo</p>
<p>カスタムロールは以下のようにリソースレベルで作成する。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 組織レベルの場合</span>
</span></span><span style="display:flex;"><span>$ gcloud iam roles create role-id --organization<span style="color:#f92672">=</span>organization-id <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --file<span style="color:#f92672">=</span>yaml-file-path
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># プロジェクトレベルの場合</span>
</span></span><span style="display:flex;"><span>$ gcloud iam roles create role-id --project<span style="color:#f92672">=</span>project-id <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --file<span style="color:#f92672">=</span>yaml-file-path
</span></span></code></pre></div><p>なお、インプットとなる YAML ファイルは以下の形式。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">title</span>: <span style="color:#ae81ff">role-title</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">description</span>: <span style="color:#ae81ff">role-description</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">stage</span>: <span style="color:#ae81ff">launch-stage</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">includedPermissions</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#ae81ff">permission-1</span>
</span></span><span style="display:flex;"><span>- <span style="color:#ae81ff">permission-2</span>
</span></span></code></pre></div><p>YAML ファイルを利用しないで、すべてコマンドで作成することも可能。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 組織レベルの場合</span>
</span></span><span style="display:flex;"><span>$ gcloud iam roles create role-id --organization<span style="color:#f92672">=</span>organization-id <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --title<span style="color:#f92672">=</span>role-title --description<span style="color:#f92672">=</span>role-description <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --permissions<span style="color:#f92672">=</span>permissions-list --stage<span style="color:#f92672">=</span>launch-stage
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># プロジェクトレベルの場合</span>
</span></span><span style="display:flex;"><span>$ gcloud iam roles create role-id --project<span style="color:#f92672">=</span>project-id <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --title<span style="color:#f92672">=</span>role-title --description<span style="color:#f92672">=</span>role-description <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --permissions<span style="color:#f92672">=</span>permissions-list --stage<span style="color:#f92672">=</span>launch-stage
</span></span></code></pre></div><p>なお、 <code>gcloud iam roles update</code> コマンドを利用することで既存のカスタムロールを編集可能。（ <code>--stage=DISABLED</code> オプションで無効化することも）<br>
<code>gcloud iam roles delete</code> コマンドで削除。 <code>gcloud iam roles undelete</code> コマンドで削除の取り消し。</p>
<h2 ref="3-リソースの管理" >3. リソースの管理</h2><a class="anchor" id="3-リソースの管理"></a>
<p>ここまでで出たリソースを管理してみる。<br>
基本 <code>gcloud</code> コマンドでの管理とする。</p>
<h3 ref="31-プロジェクト" >3.1. プロジェクト</h3><a class="anchor" id="31-プロジェクト"></a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcloud projects COMMAND <span style="color:#f92672">[</span>GCLOUD_WIDE_FLAG ...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ gcloud projects --help <span style="color:#75715e"># コマンドの help</span>
</span></span></code></pre></div><p><code>gcloud projects</code> コマンドには「プロジェクトに対する CRUD」と「プロジェクトの IAMに関する操作」を実施できる。<br>
<a href="https://www.qwiklabs.com/focuses/2794?parent=catalog">Qwiklabs と Google Cloud の概要</a> のラボ環境 Cloud Shell などを利用して実際に実行してみる。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># プロジェクトの作成</span>
</span></span><span style="display:flex;"><span>$ gcloud projects create <span style="color:#f92672">[</span>PROJECT_ID<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># プロジェクトの一覧を取得 # プロジェクトが作成されていることを確認する</span>
</span></span><span style="display:flex;"><span>$ gcloud projects list
</span></span><span style="display:flex;"><span>PROJECT_ID                    NAME                          PROJECT_NUMBER
</span></span><span style="display:flex;"><span>qwiklabs-gcp-02-eac86d9938ef  qwiklabs-gcp-02-eac86d9938ef  <span style="color:#ae81ff">264608401336</span> <span style="color:#75715e"># これが作成したプロジェクトとする</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># プロジェクトの IAM ポリシーを取得 # 権限毎にユーザ・グループ・サービスアカウントが表示される</span>
</span></span><span style="display:flex;"><span>$ gcloud projects get-iam-policy qwiklabs-gcp-02-eac86d9938ef
</span></span><span style="display:flex;"><span>bindings:
</span></span><span style="display:flex;"><span>- members:
</span></span><span style="display:flex;"><span>  - serviceAccount:qwiklabs-gcp-02-eac86d9938ef@qwiklabs-gcp-02-eac86d9938ef.iam.gserviceaccount.com
</span></span><span style="display:flex;"><span>  - user:student-02-843d65d5d79e@qwiklabs.net <span style="color:#75715e"># 現在のユーザ</span>
</span></span><span style="display:flex;"><span>  role: roles/editor
</span></span><span style="display:flex;"><span>- members:
</span></span><span style="display:flex;"><span>  - serviceAccount:qwiklabs-gcp-02-eac86d9938ef@qwiklabs-gcp-02-eac86d9938ef.iam.gserviceaccount.com
</span></span><span style="display:flex;"><span>  role: roles/owner
</span></span><span style="display:flex;"><span>- members:
</span></span><span style="display:flex;"><span>  - serviceAccount:qwiklabs-gcp-02-eac86d9938ef@qwiklabs-gcp-02-eac86d9938ef.iam.gserviceaccount.com
</span></span><span style="display:flex;"><span>  - user:student-02-843d65d5d79e@qwiklabs.net <span style="color:#75715e"># 現在のユーザ</span>
</span></span><span style="display:flex;"><span>  role: roles/viewer
</span></span><span style="display:flex;"><span>etag: BwW_ToiGehg<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>version: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># メンバーにプロジェクトの権限を付与する # なお、リソースはプロジェクトなのでロールは基本ロールの「&#39;roles/browser&#39;」「&#39;roles/editor&#39;」「&#39;roles/owner&#39;」のみ</span>
</span></span><span style="display:flex;"><span>gcloud projects add-iam-policy-binding <span style="color:#f92672">[</span>PROJECT_ID<span style="color:#f92672">]</span> --member<span style="color:#f92672">=</span>MEMBER --role<span style="color:#f92672">=</span>ROLE
</span></span></code></pre></div><h2 ref="4-cloud-kms" >4. Cloud KMS</h2><a class="anchor" id="4-cloud-kms"></a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ BUCKET_NAME<span style="color:#f92672">=</span>pepese_enron_corpus
</span></span><span style="display:flex;"><span>$ gsutil mb gs://<span style="color:#e6db74">${</span>BUCKET_NAME<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gsutil cp gs://enron_emails/allen-p/inbox/1. .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Cloud KMS を有効にする</span>
</span></span><span style="display:flex;"><span>$ gcloud services enable cloudkms.googleapis.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># データを暗号化するには、キーリングと暗号鍵を作成する必要がある</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># キーリングは鍵をグループ化する際に役立ち、鍵は環境別（テスト、ステージング、本番など）、またはその他の概念別にグループ化できる</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ここでは、キーリングの名前は test、暗号鍵の名前は qwiklab </span>
</span></span><span style="display:flex;"><span>$ KEYRING_NAME<span style="color:#f92672">=</span>test CRYPTOKEY_NAME<span style="color:#f92672">=</span>qwiklab
</span></span><span style="display:flex;"><span><span style="color:#75715e"># キーリングの作成</span>
</span></span><span style="display:flex;"><span>$ gcloud kms keyrings create $KEYRING_NAME --location global
</span></span><span style="display:flex;"><span><span style="color:#75715e"># キーリングをしようして暗号鍵の作成</span>
</span></span><span style="display:flex;"><span>$ gcloud kms keys create $CRYPTOKEY_NAME --location global <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --keyring $KEYRING_NAME <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --purpose encryption
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># メールの base64 エンコード（Base-64 エンコードを行うと、バイナリデータであってもプレーンテキストとして扱うことができる）</span>
</span></span><span style="display:flex;"><span>$ PLAINTEXT<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>cat 1. | base64 -w0<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 暗号化</span>
</span></span><span style="display:flex;"><span>$ curl -v <span style="color:#e6db74">&#34;https://cloudkms.googleapis.com/v1/projects/</span>$DEVSHELL_PROJECT_ID<span style="color:#e6db74">/locations/global/keyRings/</span>$KEYRING_NAME<span style="color:#e6db74">/cryptoKeys/</span>$CRYPTOKEY_NAME<span style="color:#e6db74">:encrypt&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -d <span style="color:#e6db74">&#34;{\&#34;plaintext\&#34;:\&#34;</span>$PLAINTEXT<span style="color:#e6db74">\&#34;}&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Authorization:Bearer </span><span style="color:#66d9ef">$(</span>gcloud auth application-default print-access-token<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span>
</span></span><span style="display:flex;"><span>* Connected to cloudkms.googleapis.com <span style="color:#f92672">(</span>64.233.187.95<span style="color:#f92672">)</span> port <span style="color:#ae81ff">443</span> <span style="color:#f92672">(</span><span style="color:#75715e">#0)</span>
</span></span><span style="display:flex;"><span>* ALPN, offering h2
</span></span><span style="display:flex;"><span>* ALPN, offering http/1.1
</span></span><span style="display:flex;"><span>* successfully set certificate verify locations:
</span></span><span style="display:flex;"><span>*   CAfile: none
</span></span><span style="display:flex;"><span>  CApath: /etc/ssl/certs
</span></span><span style="display:flex;"><span>* TLSv1.3 <span style="color:#f92672">(</span>OUT<span style="color:#f92672">)</span>, TLS handshake, Client hello <span style="color:#f92672">(</span>1<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>* TLSv1.3 <span style="color:#f92672">(</span>IN<span style="color:#f92672">)</span>, TLS handshake, Server hello <span style="color:#f92672">(</span>2<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>* TLSv1.3 <span style="color:#f92672">(</span>IN<span style="color:#f92672">)</span>, TLS handshake, Encrypted Extensions <span style="color:#f92672">(</span>8<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>* TLSv1.3 <span style="color:#f92672">(</span>IN<span style="color:#f92672">)</span>, TLS handshake, Certificate <span style="color:#f92672">(</span>11<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>* TLSv1.3 <span style="color:#f92672">(</span>IN<span style="color:#f92672">)</span>, TLS handshake, CERT verify <span style="color:#f92672">(</span>15<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>* TLSv1.3 <span style="color:#f92672">(</span>IN<span style="color:#f92672">)</span>, TLS handshake, Finished <span style="color:#f92672">(</span>20<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>* TLSv1.3 <span style="color:#f92672">(</span>OUT<span style="color:#f92672">)</span>, TLS change cipher, Change cipher spec <span style="color:#f92672">(</span>1<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>* TLSv1.3 <span style="color:#f92672">(</span>OUT<span style="color:#f92672">)</span>, TLS handshake, Finished <span style="color:#f92672">(</span>20<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>* SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384
</span></span><span style="display:flex;"><span>* ALPN, server accepted to use h2
</span></span><span style="display:flex;"><span>* Server certificate:
</span></span><span style="display:flex;"><span>*  subject: C<span style="color:#f92672">=</span>US; ST<span style="color:#f92672">=</span>California; L<span style="color:#f92672">=</span>Mountain View; O<span style="color:#f92672">=</span>Google LLC; CN<span style="color:#f92672">=</span>upload.video.google.com
</span></span><span style="display:flex;"><span>*  start date: Apr <span style="color:#ae81ff">13</span> 10:16:07 <span style="color:#ae81ff">2021</span> GMT
</span></span><span style="display:flex;"><span>*  expire date: Jul  <span style="color:#ae81ff">6</span> 10:16:06 <span style="color:#ae81ff">2021</span> GMT
</span></span><span style="display:flex;"><span>*  subjectAltName: host <span style="color:#e6db74">&#34;cloudkms.googleapis.com&#34;</span> matched cert<span style="color:#960050;background-color:#1e0010">&#39;</span>s <span style="color:#e6db74">&#34;*.googleapis.com&#34;</span>
</span></span><span style="display:flex;"><span>*  issuer: C<span style="color:#f92672">=</span>US; O<span style="color:#f92672">=</span>Google Trust Services; CN<span style="color:#f92672">=</span>GTS CA 1O1
</span></span><span style="display:flex;"><span>*  SSL certificate verify ok.
</span></span><span style="display:flex;"><span>* Using HTTP2, server supports multi-use
</span></span><span style="display:flex;"><span>* Connection state changed <span style="color:#f92672">(</span>HTTP/2 confirmed<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>* Copying HTTP/2 data in stream buffer to connection buffer after upgrade: len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>* Using Stream ID: <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>easy handle 0x563024fbefb0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt; POST /v1/projects/qwiklabs-gcp-02-b49ebfd3b4b8/locations/global/keyRings/test/cryptoKeys/qwiklab:encrypt HTTP/2
</span></span><span style="display:flex;"><span>&gt; Host: cloudkms.googleapis.com
</span></span><span style="display:flex;"><span>&gt; User-Agent: curl/7.64.0
</span></span><span style="display:flex;"><span>&gt; Accept: */*
</span></span><span style="display:flex;"><span>&gt; Authorization:Bearer ya29.a0AfH6SMB-LBTO6PGarRHEadU4ULHrPMT5yYFmIoTZD1clCWU9TapTOUMXgIuGjyfyBCMFQS6m4_CsMCnixMMTEpJWhVg5wFbUiAy_LyaI5rXj5v53a_6P4wDFDXWrkkopWWMex1oXMNTYqOR6XZBQOlhCDSDI_Dqd9DjR1KADeHSj7_PCFekQRbGs-5hNAxOIZj7O_zLtvfEE-5ONOHhWUhOqXbbc49ibOOGnweOXfQeYqWLY789gdfubPPFMtr6jP9QiNw
</span></span><span style="display:flex;"><span>&gt; Content-Type: application/json
</span></span><span style="display:flex;"><span>&gt; Content-Length: <span style="color:#ae81ff">2384</span>
</span></span><span style="display:flex;"><span>&gt;
</span></span><span style="display:flex;"><span>* Connection state changed <span style="color:#f92672">(</span>MAX_CONCURRENT_STREAMS <span style="color:#f92672">==</span> 100<span style="color:#f92672">)</span>!
</span></span><span style="display:flex;"><span>* We are completely uploaded and fine
</span></span><span style="display:flex;"><span>&lt; HTTP/2 <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>&lt; content-type: application/json; charset<span style="color:#f92672">=</span>UTF-8
</span></span><span style="display:flex;"><span>&lt; vary: X-Origin
</span></span><span style="display:flex;"><span>&lt; vary: Referer
</span></span><span style="display:flex;"><span>&lt; vary: Origin,Accept-Encoding
</span></span><span style="display:flex;"><span>&lt; date: Wed, <span style="color:#ae81ff">19</span> May <span style="color:#ae81ff">2021</span> 11:40:29 GMT
</span></span><span style="display:flex;"><span>&lt; server: ESF
</span></span><span style="display:flex;"><span>&lt; cache-control: private
</span></span><span style="display:flex;"><span>&lt; x-xss-protection: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>&lt; x-frame-options: SAMEORIGIN
</span></span><span style="display:flex;"><span>&lt; x-content-type-options: nosniff
</span></span><span style="display:flex;"><span>&lt; accept-ranges: none
</span></span><span style="display:flex;"><span>&lt;
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;projects/qwiklabs-gcp-02-b49ebfd3b4b8/locations/global/keyRings/test/cryptoKeys/qwiklab/cryptoKeyVersions/1&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;ciphertext&#34;</span>: <span style="color:#e6db74">&#34;CiQAPf2F4KxBEXLJ7mMPZZc2UIUrL1VWG8BQjxJslgnqH7MIi1cSmQ4ABtJuq1/nd6d0qw84pcMhVW+h2Wp11h6MFR1F2nnCBVtQJ/yxYvSZnOREbgDmbL7+Iaf040iMuv+9eg5EojWnwltibPEoLOuDLV46jQzAUIIpJoHlfW1s+2gWzGX71gybgVol1X1o/UBY1Vlbdm7+YWP6L0baYTl6PsCknLorcgr+NTIueNIa31NktGIipPO5X3V4dVZjdc8eHSPK8YQuSs+fiAeUw2JipSnSk3K/jFiiC5lKVw178ySPBTuIpRZR2HYD2bRpGAbBNb/RMFkic8yxnQQ5YDWPgpLAxnegCLY4ShgREXGwHPePCl8HvY0zClW/T99BGuzMcMLSbzUyhum4DkC5G++B1AQi0nCUgDF6E8R07q4CiH23j0hB4La+CvulQYfZ7Gf3x/xZ0cTx44KPHDufZS5odKFY3i1ZpEvzJEDbUFcPu4WSCPaoSTk9aDHZGFOoXiEQRdvGzqsbZT0176WX5AX8YPX4FH+pAwkMnsbQP+XbONBGz1UYnxz/S1tbmxymvwozZ2ol8PWeNh0JxRxXGVQ1eDaKhPkbshaLF6O1O0j5eKvtTFgujwQgzYZGffjej1nwW/pWocsSWDM9KJmCRxa5uTe93JGk8FvFMS/VoxSCR+6yhBlYhyUlyAfErPsslcKJ1wu1y/C3oZBsHZHg22LLijgulSZEeGjW5t6Ejdu73b+hG0c/mki7GbBoRj3w6ovipJAEvkvjbYpMODG4B4w1NcMbsN+6u6bHCf8T3nZWxNvCrIPFgh7g8Z4khpLGBMjnia3aQH6+/bOEdNqOQc9AC4ZUKxPZyD0q5EUDZyqZIpEfB8s74OKdsjblK//E4zZoQIGehn9w7WTfd7OHRf1FZo2WzhV0hzTf/aEW4z+apQZYyiq4SsKTcp1aVjgB9xrW6iIC2Ii+I3v6kxVupSfYh8Vahun3qYfMj4fB9kNLeb8eRVE7yM77nD16gfK+3CN7yxm90uhW0gizleY3aMBCfNC7UYqTAu2dsms/7kjC1QgyD37xkj124AIHg13InqubAlrYadZEcHEeeQ772J8nmNpobAvzANKZWTQ2aXKaz+O9cQQ6PTjvIMi/l0lzCvMqHTn7x+G13kRWQPWaaCpoaTrDg87hpDOG2UDNjhpb0xtoQptsaiFwjG/Jj7FV/kJ43L6pEqA2DF1GCcBdL5NOd4qmVqXckDhAXbQYHuflTRxnxbtxR9zPLEkyIxCkG1mjtYmlll9sfZk/X5LtxCJZY8Boo2/ArGvL51e8IdoAMck08+kjTgY+ZN1lj0q/oy0vh8n1aBBbN7pYrD6dBrsymhzxUggBbskJEQbzgK3vgBEnTUmKK3SnhyKiWSBTjbyeNe2//D2X+vvSApp+rCkYO5vgQTslVEB63eZaNpU9kHD5m4I7YkoSNAqwle+X96W92l0fOAgVeiJkOUzipMQDvCSnZsdGIzw//Rj5NhJ/8jttHSJsPpcxief3XaM2+0uUT6VgmqJTv2AYphTEjA8HbfwtQo+VhqkH+BsLpdD5jnFP0gYlxVs5G4uEug2qyjlHKMSSXLuZ3PNeFJHPv0BSIjQHZKhkeax65xuPPkMoi8FSPefqZUUUS6Q4t72kNifri6HDc7xtXkMBX8s1FEgf0U+noBOf1UXWCaXiJ3xJRAUP06DrAC0uYRs6/I0bu5ALS7xkEZRI2fIC6AoPjREjF1y1iLKWQGGmqf57fK8L0dGze27R/iKatUNRJsoosPjKo36Hml1BWdXflx7VOyQkztyARI9xGM0di0ZjvAvOQsioPowvWJ6+QnjLPKzFPC1YO/sm9C8MrM3M4m6gdiStPMxoJSYgl+vCVJUTPP+ayGRjcTM9uEz0vmsq4GEF1lAxM8qvZ9ERYnDvq63+AyarXVw5O9xgegcB6dfMB0AHJlwk+/gfTHu8/n51G38Iy2pQcGMx2eySPQ9fRa2i+0GG1C+w+wO4ZkN3J9GxWFpLpiM0OQFuJWc+eYzyvjRbjHoKyCRBb81jf6HdDCUD9iSp3KWATWs4oZkfo0fxTO7HOoVTsRzVMe8Re2jYr0LROMcNstr67c/22wOBxC3L8lII4m3vWLS2gw4rbmjVkVru8zMvS/6rNDVSWJqtVxYFq5Oi49qaZTegLgL0q2hnrUP6r+eknioUzrsy9Bre1LM1R+oCHzngbsgW81kElcvm7e3kuNcMEjv8r+mvluTadL+HPAJ66OMBGPfPBIJyZcgv73vPi7Su35bORKMjvTsyHLxoi3u0K5EO1E7sU1Oz0EZ/Xkwwah3U9mGLRPnqndVdo+Vx263WV4KXpJR8WqM0qWqTNziDGWnyGfgcByuvhgu6CZIeAZIwMVzyrMwflrwoQAZX3+U4HQYWGb/DNcclP1AAK4XyWX2fEwfdVL832BJbDQSKtXh58aiH5eWsT6symA==&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;ciphertextCrc32c&#34;</span>: <span style="color:#e6db74">&#34;4146537015&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;protectionLevel&#34;</span>: <span style="color:#e6db74">&#34;SOFTWARE&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>* Connection <span style="color:#75715e">#0 to host cloudkms.googleapis.com left intact</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 上記は長いので暗号化部分のみ取り出す</span>
</span></span><span style="display:flex;"><span>$ curl -v <span style="color:#e6db74">&#34;https://cloudkms.googleapis.com/v1/projects/</span>$DEVSHELL_PROJECT_ID<span style="color:#e6db74">/locations/global/keyRings/</span>$KEYRING_NAME<span style="color:#e6db74">/cryptoKeys/</span>$CRYPTOKEY_NAME<span style="color:#e6db74">:encrypt&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -d <span style="color:#e6db74">&#34;{\&#34;plaintext\&#34;:\&#34;</span>$PLAINTEXT<span style="color:#e6db74">\&#34;}&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Authorization:Bearer </span><span style="color:#66d9ef">$(</span>gcloud auth application-default print-access-token<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Content-Type:application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| jq .ciphertext -r &gt; 1.encrypted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 暗号化されたデータが複合化可能か確認</span>
</span></span><span style="display:flex;"><span>$ curl -v <span style="color:#e6db74">&#34;https://cloudkms.googleapis.com/v1/projects/</span>$DEVSHELL_PROJECT_ID<span style="color:#e6db74">/locations/global/keyRings/</span>$KEYRING_NAME<span style="color:#e6db74">/cryptoKeys/</span>$CRYPTOKEY_NAME<span style="color:#e6db74">:decrypt&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -d <span style="color:#e6db74">&#34;{\&#34;ciphertext\&#34;:\&#34;</span><span style="color:#66d9ef">$(</span>cat 1.encrypted<span style="color:#66d9ef">)</span><span style="color:#e6db74">\&#34;}&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Authorization:Bearer </span><span style="color:#66d9ef">$(</span>gcloud auth application-default print-access-token<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Content-Type:application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| jq .plaintext -r | base64 -d
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 暗号化されたデータを Cloud Storage バケットへアップロード</span>
</span></span><span style="display:flex;"><span>$ gsutil cp 1.encrypted gs://<span style="color:#e6db74">${</span>BUCKET_NAME<span style="color:#e6db74">}</span>
</span></span></code></pre></div><p>鍵を管理する権限は <code>cloudkms.admin</code> で、この権限を持つすべてのユーザーがキーリングを作成し、暗号鍵を作成、変更、無効化、破壊できる。<br>
暗号化および復号する権限は <code>cloudkms.cryptoKeyEncrypterDecrypter</code> で、暗号化および復号 API エンドポイントを呼び出すために使用される。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcloud kms keyrings add-iam-policy-binding $KEYRING_NAME <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --location global <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --member user:$USER_EMAIL <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --role roles/cloudkms.admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ gcloud kms keyrings add-iam-policy-binding $KEYRING_NAME <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --location global <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --member user:$USER_EMAIL <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --role roles/cloudkms.cryptoKeyEncrypterDecrypter
</span></span></code></pre></div><h2 ref="5-コスト管理" >5. コスト管理</h2><a class="anchor" id="5-コスト管理"></a>
<h3 ref="51-コスト算出" >5.1. コスト算出</h3><a class="anchor" id="51-コスト算出"></a>
<p><a href="https://cloud.google.com/products/calculator/?hl=ja">Google Cloud Pricing Calculator</a> で各サービスに適した算出が可能。<br>
ただし、 BigQuery など一部特殊なものもある。<br>
請求データの分析は <a href="https://cloud.google.com/billing/docs/how-to/export-data-bigquery?hl=ja#differences_between_exported_data_and_invoices">Cloud Billing データを BigQuery にエクスポートする</a> を参照。</p>
<h3 ref="52-請求" >5.2. 請求</h3><a class="anchor" id="52-請求"></a>
<p>請求先アカウントのリンク（紐付け）を更新するためには、 <strong>請求先アカウント管理者</strong> および <strong>プロジェクト支払い管理者</strong> の権限が必要になる。</p>
<ul>
<li><a href="https://cloud.google.com/billing/docs/concepts?hl=ja#billing_account">Cloud Billing のコンセプト</a></li>
<li><a href="https://cloud.google.com/billing/docs/how-to/modify-project">プロジェクトの請求設定の変更</a></li>
</ul>
<h2 ref="6-ユースケース" >6. ユースケース</h2><a class="anchor" id="6-ユースケース"></a>
<ol>
<li><a href="#61-%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88">サービスアカウント</a></li>
</ol>
<h3 ref="61-サービスアカウント" >6.1. サービスアカウント</h3><a class="anchor" id="61-サービスアカウント"></a>
<p>サービスアカウントを作成して、ネットワーク管理者とセキュリティ管理者のロールの権限を確認する。<br>
以下の手順で確認する。</p>
<ul>
<li>ゾーン <code>us-central1-a</code> の default ネットワーク環境を利用</li>
<li>VM インスタンス blue を作成する
<ul>
<li>nginx</li>
<li>ネットワークタグ <code>web-server</code> を付与</li>
<li><code>/var/www/html/index.nginx-debian.html</code> の <code>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</code> 行を <code>&lt;h1&gt;Welcome to the blue server!&lt;/h1&gt;</code> に編集</li>
</ul>
</li>
<li>VM インスタンス green を作成する
<ul>
<li>nginx</li>
<li><code>/var/www/html/index.nginx-debian.html</code> の <code>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</code> 行を <code>&lt;h1&gt;Welcome to the green server!&lt;/h1&gt;</code> に編集</li>
</ul>
</li>
<li>ファイアウォールルール <code>allow-http-web-server</code> を作成する
<ul>
<li>ターゲットタグ <code>web-server</code> に対してインターネットからの HTTP アクセスを許可</li>
</ul>
</li>
<li>VM インスタンス test-vm を作成する
<ul>
<li>ここから blue と green を操作し、ネットワーク管理者とセキュリティ管理者のロールの権限を確認する</li>
</ul>
</li>
<li>新規にサービスアカウント <code>Network-admin</code> を作成して、 test-vm から権限を確認しつつ操作する</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 初期設定</span>
</span></span><span style="display:flex;"><span>$ gcloud config set compute/region us-central1
</span></span><span style="display:flex;"><span>$ gcloud config set compute/zone us-central1-a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># VM インスタンス blue を作成</span>
</span></span><span style="display:flex;"><span>$ gcloud compute instances create blue <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   --tags<span style="color:#f92672">=</span>web-server <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   --metadata<span style="color:#f92672">=</span>startup-script<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;#! /bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     apt-get update
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     sudo apt-get install nginx-light -y&#39;</span>
</span></span><span style="display:flex;"><span>Created <span style="color:#f92672">[</span>https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-02-4e1179b11a90/zones/us-central1-a/instances/blue<span style="color:#f92672">]</span>.
</span></span><span style="display:flex;"><span>NAME  ZONE           MACHINE_TYPE   PREEMPTIBLE  INTERNAL_IP  EXTERNAL_IP     STATUS
</span></span><span style="display:flex;"><span>blue  us-central1-a  n1-standard-1               10.128.0.2   104.198.156.96  RUNNING
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># VM インスタンス green を作成</span>
</span></span><span style="display:flex;"><span>$ gcloud compute instances create green <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   --metadata<span style="color:#f92672">=</span>startup-script<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;#! /bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     apt-get update
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     sudo apt-get install nginx-light -y&#39;</span>
</span></span><span style="display:flex;"><span>Created <span style="color:#f92672">[</span>https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-02-4e1179b11a90/zones/us-central1-a/instances/green<span style="color:#f92672">]</span>.
</span></span><span style="display:flex;"><span>NAME   ZONE           MACHINE_TYPE   PREEMPTIBLE  INTERNAL_IP  EXTERNAL_IP    STATUS
</span></span><span style="display:flex;"><span>green  us-central1-a  n1-standard-1               10.128.0.3   34.123.63.156  RUNNING
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># VM インスタンス test-vm を作成</span>
</span></span><span style="display:flex;"><span>$ gcloud compute instances create test-vm --machine-type<span style="color:#f92672">=</span>f1-micro
</span></span><span style="display:flex;"><span>Created <span style="color:#f92672">[</span>https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-02-4e1179b11a90/zones/us-central1-a/instances/test-vm<span style="color:#f92672">]</span>.
</span></span><span style="display:flex;"><span>NAME     ZONE           MACHINE_TYPE  PREEMPTIBLE  INTERNAL_IP  EXTERNAL_IP    STATUS
</span></span><span style="display:flex;"><span>test-vm  us-central1-a  f1-micro                   10.128.0.4   35.232.124.24  RUNNING
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Cloud Console の Compute Engine ページから blue 、 green にログインして `/var/www/html/index.nginx-debian.html` を編集する。</span>
</span></span><span style="display:flex;"><span>$ gcloud compute ssh blue
</span></span><span style="display:flex;"><span>$ sudo vi /var/www/html/index.nginx-debian.html
</span></span><span style="display:flex;"><span>$ exit
</span></span><span style="display:flex;"><span>$ gcloud compute ssh green
</span></span><span style="display:flex;"><span>$ sudo vi /var/www/html/index.nginx-debian.html
</span></span><span style="display:flex;"><span>$ exit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ファイアウォールルール allow-http-web-server を作成</span>
</span></span><span style="display:flex;"><span>$ gcloud compute firewall-rules create allow-http-web-server <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --action<span style="color:#f92672">=</span>allow <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --direction<span style="color:#f92672">=</span>ingress <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --source-ranges<span style="color:#f92672">=</span>0.0.0.0/0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --target-tags<span style="color:#f92672">=</span>web-server <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --rules<span style="color:#f92672">=</span>tcp:80,icmp
</span></span></code></pre></div><p>ここまで作成したら、test-vm に SSH して、blue と green を疎通してみる。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcloud compute ssh test-vm
</span></span><span style="display:flex;"><span>$ curl http://10.128.0.2     <span style="color:#75715e"># blue の内部 IP -&gt; アクセス可能</span>
</span></span><span style="display:flex;"><span>$ curl http://10.128.0.3     <span style="color:#75715e"># green の内部 IP -&gt; アクセス可能</span>
</span></span><span style="display:flex;"><span>$ curl http://104.198.156.96 <span style="color:#75715e"># blue の外部 IP -&gt; アクセス可能</span>
</span></span><span style="display:flex;"><span>$ curl http://34.123.63.156  <span style="color:#75715e"># green の外部 IP -&gt; アクセス不可能！</span>
</span></span><span style="display:flex;"><span>$ exit
</span></span></code></pre></div><p>ネットワークタグ <code>web-server</code> を付与していない green は外部から HTTP アクセスできないことが確認できる。<br>
ここからはサービスアカウントを作成して、そのサービスアカウントにネットワーク管理者とセキュリティ管理者のロールを付与することによってどのようにアクセス制御されるのかをみてみる。</p>
<ul>
<li>ネットワーク管理者: ネットワーキング リソース（ファイアウォール ルールと SSL 証明書を除く）を作成、変更、削除するための権限。</li>
<li>セキュリティ管理者: ファイアウォール ルールと SSL 証明書を作成、変更、削除するための権限。</li>
</ul>
<p>デフォルトのサービスアカウントが付与されている test-vm に SSH して上記の権限を確認してみる。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcloud compute ssh test-vm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ gcloud compute firewall-rules list
</span></span><span style="display:flex;"><span>ERROR: <span style="color:#f92672">(</span>gcloud.compute.firewall-rules.list<span style="color:#f92672">)</span> Some requests did not succeed:
</span></span><span style="display:flex;"><span> - Request had insufficient authentication scopes.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ gcloud compute firewall-rules delete allow-http-web-server
</span></span><span style="display:flex;"><span>ERROR: <span style="color:#f92672">(</span>gcloud.compute.firewall-rules.delete<span style="color:#f92672">)</span> Could not fetch resource:
</span></span><span style="display:flex;"><span> - Request had insufficient authentication scopes.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ exit
</span></span></code></pre></div><p>デフォルトのサービスアカウントでは権限が不足しているため、エラーが発生する。<br>
新規でサービスアカウントを作成して、権限を付与してみる。</p>
<ol>
<li>Cloud Platform Console で、ナビゲーション メニュー（mainmenu.png）&gt; [IAM と管理者] &gt; [サービス アカウント] に移動します。</li>
<li>[サービス アカウントを作成] をクリックします。</li>
<li>[サービス アカウント名] に「Network-admin」と入力し、[作成] をクリックします。</li>
<li>[ロールを選択] で、[Compute Engine] &gt; [Compute ネットワーク管理者] を選択し、[完了] をクリックします。</li>
<li>一覧から 「Network-admin」 を選択して、 [鍵の管理] をクリック</li>
<li>[鍵の追加] -&gt; [新しい鍵] -&gt; [JSON] を選択し、 [作成]</li>
<li>JSON ファイルがローカルにダウンロードされるので <code>credentials.json</code> にリネーム</li>
</ol>
<p>test-vm に SSH して、作成したサービスアカウント権限で操作してみる。</p>
<ol>
<li>Cloud Console から test-vm インスタンスに SSH してターミナルを開く</li>
<li>SSH VM ターミナル右上の隅にある歯車アイコンをクリックして、[ファイルをアップロード] をクリックして <code>credentials.json</code> をアップロード</li>
<li>アップロードした認証情報を使用して VM に許可を与える
<ul>
<li><code>gcloud auth activate-service-account --key-file credentials.json</code></li>
</ul>
</li>
</ol>
<p>以上で、サービスアカウント <code>Network-admin</code> の権限が付与された。<br>
この状態で操作してみる。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcloud compute firewall-rules list
</span></span><span style="display:flex;"><span>NAME                    NETWORK  DIRECTION  PRIORITY  ALLOW                         DENY  DISABLED
</span></span><span style="display:flex;"><span>allow-http-web-server   default  INGRESS    <span style="color:#ae81ff">1000</span>      tcp:80,icmp                         False
</span></span><span style="display:flex;"><span>default-allow-icmp      default  INGRESS    <span style="color:#ae81ff">65534</span>     icmp                                False
</span></span><span style="display:flex;"><span>default-allow-internal  default  INGRESS    <span style="color:#ae81ff">65534</span>     tcp:0-65535,udp:0-65535,icmp        False
</span></span><span style="display:flex;"><span>default-allow-rdp       default  INGRESS    <span style="color:#ae81ff">65534</span>     tcp:3389                            False
</span></span><span style="display:flex;"><span>default-allow-ssh       default  INGRESS    <span style="color:#ae81ff">65534</span>     tcp:22                              False
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ gcloud compute firewall-rules delete allow-http-web-server
</span></span><span style="display:flex;"><span>ERROR: <span style="color:#f92672">(</span>gcloud.compute.firewall-rules.delete<span style="color:#f92672">)</span> Could not fetch resource:
</span></span><span style="display:flex;"><span> - Required <span style="color:#e6db74">&#39;compute.firewalls.delete&#39;</span> permission <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;projects/qwiklabs-gcp-02-4e1179b11a90/global/firewalls/allow
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-http-web-server&#39;</span>
</span></span></code></pre></div><p><strong>ネットワーク管理者</strong> の権限があるためファイアウォールルールの一覧を確認できたが、 <strong>セキュリティ管理者</strong> の権限が無いためファイアウォールルールの削除はできなかった。<br>
なので、サービスアカウント <code>Network-admin</code> に <strong>セキュリティ管理者</strong> の権限を付与してみる。</p>
<ol>
<li>Cloud Platform Console で、ナビゲーション メニュー &gt; [IAM と管理] &gt; [IAM] に移動</li>
<li>Network-admin アカウントを見つけます。このアカウントは [名前] 列で特定</li>
<li>Network-admin アカウントの鉛筆アイコンをクリック</li>
<li>[ロール] を [Compute Engine] &gt; [Compute セキュリティ管理者] に変更して [保存]</li>
</ol>
<p><strong>セキュリティ管理者</strong> の権限に変更できたので、もう一度 <code>gcloud compute firewall-rules delete allow-http-web-server</code> を実行してみると今度はエラーなく実行できることを確認できる。</p>
		</div>






	
	

      </section>

      
      
    </article>
    
    
    <footer>
      

		
	
			
		
	    	
	  	
	
    </footer>
    



  </body>
</html>
