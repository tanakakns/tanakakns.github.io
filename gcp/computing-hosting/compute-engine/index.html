

<!DOCTYPE html>
<html>
  <head>
    <title>
	Compute Engine :: テックまとめ
</title>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="revised" content="2022-04-11T15:39:18 JST">
<meta name="description" content="備忘録用メモサイト">



<title>Compute Engine :: テックまとめ</title>

<link rel="shortcut icon" href='/images/favicon.png' type="image/x-icon" />

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css">

<script src='https://code.jquery.com/jquery-3.5.1.min.js'></script>

<link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel="stylesheet">



<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/layout.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/css/style.main.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/css/style.menu.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/notice.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/tabs.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/panel.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/columns.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/children.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/attachments.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/alert.css'>
<link rel="stylesheet" type="text/css" href='/css/docport.css'>

<script src='/js/docport.js'></script>
<script type="text/javascript">
      var baseurl = "https:\/\/tanakakns.github.io\/";
</script>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-42388425-3', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
  </head>

  <body data-url="/gcp/computing-hosting/compute-engine/"

  class="hidetoc hidenextpage ">

<style type="text/css">
  #debug{
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    line-height: 3.5rem;
    margin-bottom: .35rem;
    padding: 0 2rem;
    position: fixed;
    left: 0;      right: 0;     top: 0;
   
    top:0px;
    
    min-height: 150px;

    background-color: white;
    border: 3px solid red;
    z-index: 10000 ;
    word-wrap: all;
    overflow: auto;
  }
</style>
 


    
    
    <header style="">
        <div>
    
    <div class="burger ">
        <a href="javascript:void(0);" style="font-size:15px;" onclick="$('article > aside').toggleClass('responsive')">&#9776;</a>
    </div>
    

    <div>

		
	
			
		
	    	<a class='baselink' href='https://tanakakns.github.io/'>テックまとめ</a>
	  	
	</div>

</div>
    </header>
    

    <article>
      
      <aside class="">
        

		
	
			
		
	    	
	  	
	<div id="close_menu">
  <a href="javascript:void(0);" style="font-size:15px;" onclick="$('article > aside').toggleClass('responsive')">
      <i class="fa fa-lg fa-times"></i>
  </a>
</div>

<ul class="menu">

    <li data-nav-id="https://tanakakns.github.io/design/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/design/">設計</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/design/principle-practice/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/design/principle-practice/">原理原則・ベストプラクティス</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/design/api-design/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/design/api-design/">API設計</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/design/microservices/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/design/microservices/">マイクロサービス</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/design/clean-architecture/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/design/clean-architecture/">クリーンアーキテクチャ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/design/architecture/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/design/architecture/">アーキテクチャ</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/database/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/database/">Database</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/database/rdb/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/database/rdb/">RDB</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/aws/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/aws/">AWS</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/aws/well-architected-framework/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/well-architected-framework/">AWS Well-Architected フレームワーク</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/computing/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/computing/">コンピューティング</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/aws/computing/ec2/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/computing/ec2/">EC2</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/container/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/container/">コンテナ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/storage/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/storage/">ストレージ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/database/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/database/">データベース</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/aws/database/aurora/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/database/aurora/">Aurora</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/migration/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/migration/">移行と転送</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/dev-tools/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/dev-tools/">開発者用ツール</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/security/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/security/">セキュリティ</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/aws/security/iam/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/security/iam/">IAM</a>
      
        
      
    </li>
        </ul>
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/gcp/" class="dd-item parent haschildren
        item_level_$level
        ">

      
      
      
      
          <i class="fas fa-chevron-down ddexp"></i>
        
      
          <a href="/gcp/">GCP</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/gcp-aws/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/gcp-aws/">GCP と AWS の比較</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/monitoring/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/monitoring/">監視</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/tools/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/tools/">ツール</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/tools/management-tools/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/tools/management-tools/">管理ツール</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/tools/dev-tools/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/tools/dev-tools/">開発ツール</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/access-control-and-security/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/access-control-and-security/">アクセス制御とセキュリティ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/" class="dd-item parent haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/">コンピューティングとホスティング</a>
      
          <i class="fas fa-chevron-down ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/compute-engine/" class="dd-item parent active
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/compute-engine/">Compute Engine</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/kubernetes-engine/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/kubernetes-engine/">Google Kubernetes Engine</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/app-engine/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/app-engine/">App Engine</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/cloud-functions/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/cloud-functions/">Cloud Functions</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/storage/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/storage/">ストレージ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/">データベース</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/bigquery/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/bigquery/">BigQuery</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/sql/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/sql/">Cloud SQL</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/memorystore/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/memorystore/">Memorystore</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/spanner/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/spanner/">Cloud Spanner</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/">ネットワーキング</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/vpc/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/vpc/">VPC</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/load-balancing/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/load-balancing/">Cloud Load Balancing</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/iap/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/iap/">Identity-Aware Proxy</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/interconnect/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/interconnect/">Cloud Interconnect</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/big-data/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/big-data/">ビッグデータ</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/big-data/pubsub/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/big-data/pubsub/">Cloud Pub/Sub</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/big-data/dataflow/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/big-data/dataflow/">Dataflow</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/machine-learning/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/machine-learning/">機械学習</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/kubernetes/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/kubernetes/">Kubernetes</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/concept/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/concept/">概念整理</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/architecture/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/architecture/">アーキテクチャ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/kubectl-plugin/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/kubectl-plugin/">kubectl plugin と Krew</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/command/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/command/">コマンド</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/manifest/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/manifest/">マニフェスト</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/application-management/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/application-management/">アプリケーション管理</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/cluster-management/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/cluster-management/">クラスタ管理</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/security/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/security/">セキュリティ</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/istio/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/istio/">Istio</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/istio/basic/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/istio/basic/">入門</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/istio/concept/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/istio/concept/">概念整理</a>
      
        
      
    </li>
        </ul>
    </li>
    



</ul>

		
	
			
		
	    	
	  	
	
      </aside>
      

      <section class="page ">
      
	
		
    
    
    <nav id="ariane" aria-label="breadcrumb">
      <ol class="ariane">
        
  
  	
		
  
  	
		
  
  	
	<li >
      <a class="text-link" href="https://tanakakns.github.io/">
        
      </a>
    </li>
	
  
    <li class="">
      <a class="text-link" href="/gcp/">
        GCP
      </a>
    </li>
	
  	
  
    <li class="">
      <a class="text-link" href="/gcp/computing-hosting/">
        コンピューティングとホスティング
      </a>
    </li>
	
  	
  
    <li class="active">
      
        Compute Engine
      
    </li>

      </ol>
    </nav>
    
    

    
		
        
		
		
		
		
		
		
		

		
			<h1>Compute Engine</h1>
        

		
										
		

		
	

	
	
	






	<div class="content">
	    <p><strong>Compute Engine</strong> は Google のインフラストラクチャ上に仮想マシンを構築するサービス。</p>
<ol>
<li><a href="#1-%E3%82%B3%E3%83%B3%E3%82%BB%E3%83%97%E3%83%88">コンセプト</a></li>
<li><a href="#2-%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E4%BD%9C%E6%88%90">インスタンス作成</a></li>
<li><a href="#3-%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%81%AE%E4%BD%9C%E6%88%90%E3%81%A8%E3%82%A2%E3%82%BF%E3%83%83%E3%83%81">ディスクの作成とアタッチ</a></li>
<li><a href="#4-%E3%83%95%E3%82%A1%E3%82%A4%E3%82%A2%E3%82%A6%E3%82%A9%E3%83%BC%E3%83%AB%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E4%BD%9C%E6%88%90">ファイアウォールルールの作成</a></li>
<li><a href="#5-%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9">ネットワークインターフェース</a></li>
<li><a href="#6-%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%81%B8%E3%81%AE%E6%8E%A5%E7%B6%9A">インスタンスへの接続</a></li>
<li><a href="#7-cloud-monitoring--cloud-logging-%E9%80%A3%E6%90%BA">Cloud Monitoring / Cloud Logging 連携</a></li>
<li><a href="#8-%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88">サービスアカウント</a></li>
<li><a href="#9-%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97">アクセススコープ</a></li>
<li><a href="#9-%E3%82%B1%E3%83%BC%E3%82%B9%E3%82%B9%E3%82%BF%E3%83%87%E3%82%A3">ケーススタディ</a></li>
</ol>
<ul>
<li><a href="https://cloud.google.com/compute/docs/how-to?hl=ja">公式ガイド</a></li>
<li><a href="https://cloud.google.com/solutions/best-practices-compute-engine-region-selection?hl=ja">Compute Engine のリージョン選択に関するベスト プラクティス</a></li>
</ul>
<h2 ref="1-コンセプト" >1. コンセプト</h2><a class="anchor" id="1-コンセプト"></a>
<ol>
<li><a href="#11-vm-%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9">VM インスタンス</a></li>
<li><a href="#12-%E3%83%9E%E3%82%B7%E3%83%B3%E3%82%BF%E3%82%A4%E3%83%97">マシンタイプ</a></li>
<li><a href="#13-%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3">ストレージオプション</a></li>
<li><a href="#14-%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8">イメージ</a></li>
<li><a href="#15-%E3%82%B9%E3%83%8A%E3%83%83%E3%83%97%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88">スナップショット</a></li>
<li><a href="#16-%E3%82%B2%E3%82%B9%E3%83%88%E7%92%B0%E5%A2%83">ゲスト環境</a></li>
<li><a href="#17-%E3%83%A1%E3%82%BF%E3%83%87%E3%83%BC%E3%82%BF%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC">メタデータサーバー</a></li>
<li><a href="#18-%E3%83%A9%E3%82%A4%E3%83%97%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3">ライブマイグレーション</a></li>
<li><a href="#19-%E3%83%A9%E3%83%99%E3%83%AB">ラベル</a></li>
</ol>
<h3 ref="11-vm-インスタンス" >1.1. VM インスタンス</h3><a class="anchor" id="11-vm-インスタンス"></a>
<p>マシンタイプとストレージからなる。<br>
VM オプションとして「可用性ポリシー」「サービスアカウント」「プリエンプティブル VM」「Shield VM」がある。</p>
<ul>
<li>可用性ポリシー
<ul>
<li>メンテナンスイベントやクラッシュ発生時のインスタンスの動作を設定できる</li>
<li>メンテナンスイベント発生時の動作
<ul>
<li>移行：ライブマイグレーションされる（推奨）</li>
<li>終了：シャットダウン信号を受信して停止する</li>
</ul>
</li>
<li>クラッシュ発生時の動作
<ul>
<li>自動再起動オン：ユーザ操作意外でインスタンスが終了した場合に自動再起動する（推奨）</li>
<li>自動再起動オフ：自動再起動しない</li>
</ul>
</li>
</ul>
</li>
<li>サービスアカウント
<ul>
<li>インスタンスまたはアプリケーションが API リクエストをユーザの代わりに実行できるようにするための ID</li>
<li>デフォルトでは「プロジェクト編集者」の権限をもつサービスアカウントが付与されるため、適宜ユーザ定義したサービスアカウントを作成・付与する</li>
</ul>
</li>
<li><a href="https://cloud.google.com/compute/docs/instances/preemptible?hl=ja">プリエンプティブル VM</a>
<ul>
<li>通常より遥かに低価格である代わりに以下の制約をうけるインスタンス
<ul>
<li>システムイベントにより、いつでも停止する可能性がある</li>
<li>24 時間実行した後、必ず停止</li>
<li>有限の Compute Engine リソースなので、常に利用できるわけではない</li>
<li>ライブ マイグレーションできない</li>
<li>サービスレベル契約（ SLA ）の非対象（ <a href="https://cloud.google.com/compute/sla?hl=ja">Compute Engine SLA</a> ）</li>
<li>Google Cloud の無料枠に適用されない</li>
</ul>
</li>
<li>バッチやフォールトトレラント（リトライ処理など強制終了に対応できる）なワークロードに適用する</li>
</ul>
</li>
<li><a href="https://cloud.google.com/security/shielded-cloud/shielded-vm?hl=ja">Shielded VM</a>
<ul>
<li>以下の 3 つの機能をすべて有効にしたインスタンス
<ul>
<li><a href="https://cloud.google.com/security/shielded-cloud/shielded-vm?hl=ja#vtpm">仮想トラステッド プラットフォーム モジュール（vTPM）</a></li>
<li><a href="https://cloud.google.com/security/shielded-cloud/shielded-vm?hl=ja#integrity-monitoring">整合性モニタリング</a></li>
<li><a href="https://cloud.google.com/security/shielded-cloud/shielded-vm?hl=ja#secure-boot">セキュアブート</a></li>
</ul>
</li>
<li>インスタンスを起動した後、<a href="https://cloud.google.com/compute/docs/instances/modifying-shielded-vm?hl=ja">Shielded VM のオプションを変更</a> するには、インスタンスを停止する必要がある</li>
</ul>
</li>
</ul>
<h4 ref="111-インスタンステンプレート" >1.1.1. インスタンステンプレート</h4><a class="anchor" id="111-インスタンステンプレート"></a>
<p><a href="https://cloud.google.com/compute/docs/instance-templates?hl=ja">インスタンステンプレート</a> は、VM インスタンスと MIG を作成する際にテンプレートとして利用できるリソース。<br>
インスタンステンプレートで、マシンタイプ、イメージ、ラベルなどを定義できる。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcloud compute instance-templates create example-template-custom <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --machine-type e2-standard-4 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --image-family debian-9 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --image-project debian-cloud <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --boot-disk-size 250GB
</span></span></code></pre></div><p><a href="https://cloud.google.com/compute/docs/instance-templates/create-instance-templates?hl=ja">その他のユースケース</a></p>
<h4 ref="112-マネージドインスタンスグループ-mig-" >1.1.2. マネージドインスタンスグループ（ MIG ）</h4><a class="anchor" id="112-マネージドインスタンスグループ-mig-"></a>
<p>インスタンステンプレートからインスタンスを起動・グループ化することにより、負荷分散やオートスケール、ヘルスチェックによる自動復旧を可能にする。<br>
なお、 MIG には <strong>ゾーン MIG</strong> と <strong>リージョン（マルチゾーン） MIG</strong> の 2 種類あり、可用性の観点から後者にすることが推奨される。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcloud compute instance-groups managed create <span style="color:#f92672">[</span>インスタンスグループ名<span style="color:#f92672">]</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --base-instance-name<span style="color:#f92672">=[</span>作成されるインスタンス名<span style="color:#f92672">]</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --size<span style="color:#f92672">=[</span>インスタンス数<span style="color:#f92672">]</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --template<span style="color:#f92672">=[</span>インスタンステンプレート名<span style="color:#f92672">]</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --zome<span style="color:#f92672">=[</span>ゾーン名<span style="color:#f92672">]</span> <span style="color:#ae81ff">\ </span><span style="color:#75715e"># カンマ区切りで複数指定した場合、マルチゾーン MIG になる</span>
</span></span><span style="display:flex;"><span>    --region<span style="color:#f92672">=[</span>リージョン名<span style="color:#f92672">]</span> <span style="color:#ae81ff">\ </span><span style="color:#75715e"># リージョン（マルチゾーン） MIG になる</span>
</span></span></code></pre></div><ul>
<li>自動スケール（スケールイン・アウト）
<ul>
<li><a href="https://cloud.google.com/compute/docs/autoscaler?hl=ja#cool_down_period">クールダウン期間</a> （初期化期間）
<ul>
<li>新しく作成されたインスタンスを自動スケーリングの判断に含めない時間</li>
<li>インスタンスが起動しても、サービスが起動していなければヘルスチェック NG になるため、このご検知を発生させないために設定（アプリの初期化時間をテストすることを推奨）</li>
<li>スケールアップの判定を遅らせ、必要以上に多くのインスタンスが作成されないようにするために設定する</li>
</ul>
</li>
<li><a href="https://cloud.google.com/compute/docs/autoscaler?hl=ja#stabilization_period">安定化期間</a>
<ul>
<li>スケールインの判定のため、オートスケーラは直近10分間におけるピーク負荷に基づいてターゲットサイズを計算する（この 10 分を安定化期間という）</li>
<li>ピーク負荷後のスケールダウンに10分の余裕を持たせることで、頻繁なスケールアップ/ダウンの繰り返しを回避する</li>
</ul>
</li>
<li><a href="https://cloud.google.com/compute/docs/autoscaler/understanding-autoscaler-decisions?hl=ja">オートスケーラーによる判断の理解</a></li>
</ul>
</li>
<li>ヘルスチェック（自動修復のための）
<ul>
<li>初期遅延
<ul>
<li>自動修復のためのヘルスチェックが新しく作成したインスタンスを対象にしない時間</li>
<li>初期化完了前にUnhealthyと判断され、無駄な再作成を防ぐ目的で設定する</li>
</ul>
</li>
<li><a href="https://cloud.google.com/compute/docs/instance-groups/autohealing-instances-in-migs?hl=ja">ヘルスチェックと自動修復の設定</a></li>
</ul>
</li>
<li><a href="https://cloud.google.com/compute/docs/instance-groups/rolling-out-updates-to-managed-instance-groups">ローリングアップデート</a></li>
</ul>
<h3 ref="12-マシンタイプ" >1.2. マシンタイプ</h3><a class="anchor" id="12-マシンタイプ"></a>
<ul>
<li>ざっくり CPU と メモリのセット</li>
<li>汎用（E2/N2/N2D/N1）、メモリ最適化（M1/M2）、コンピューティング最適化（C2）、アクセラレータ最適化（A2）など</li>
<li>割と自由に設定できる カスタムタイプ もある</li>
</ul>
<p>提供されているマシンタイプは以下のコマンドで一覧取得できる。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcloud compute machine-types list
</span></span><span style="display:flex;"><span>WARNING: The following filter keys were not present in any resource : deprecated.state
</span></span><span style="display:flex;"><span>NAME              ZONE                       CPUS  MEMORY_GB  DEPRECATED
</span></span><span style="display:flex;"><span>a2-highgpu-1g     us-central1-a              <span style="color:#ae81ff">12</span>    85.00
</span></span><span style="display:flex;"><span>a2-highgpu-2g     us-central1-a              <span style="color:#ae81ff">24</span>    170.00
</span></span><span style="display:flex;"><span>a2-highgpu-4g     us-central1-a              <span style="color:#ae81ff">48</span>    340.00
</span></span><span style="display:flex;"><span>（省略）
</span></span></code></pre></div><h3 ref="13-ストレージオプション" >1.3. ストレージオプション</h3><a class="anchor" id="13-ストレージオプション"></a>
<p>VM インスタンスからマウントして利用できるストレージには以下の種類がある。</p>
<ul>
<li><strong>ゾーン永続ディスク</strong> : 効率的で信頼性の高い ブロックストレージ。</li>
<li><strong>リージョン永続ディスク</strong> : 2 つのゾーンに複製されたリージョン ブロックストレージ。</li>
<li><strong>ローカル SSD</strong> : 高パフォーマンスかつ一時的なローカル ブロックストレージ。</li>
<li><strong>Cloud Storage バケット</strong> : 手頃な料金のオブジェクトストレージ。</li>
<li><strong>Filestore</strong> : Google Cloud ユーザー向けの高性能ファイルストレージ。</li>
</ul>
<p>永続ディスク、ローカル SSD はブロックストレージで ディスク としての扱いになる。<br>
さらに永続ディスクには以下の種類がある。</p>
<ul>
<li><strong>標準永続ディスク</strong>（pd-standard）：標準のハードディスク ドライブ（HDD）</li>
<li><strong>バランス永続ディスク</strong>（pd-balanced）：ソリッド ステート ドライブ（SSD）、SSD 永続ディスクに比べ低コスト・低パフォーマンス</li>
<li><strong>SSD 永続ディスク</strong>（pd-ssd）：ソリッド ステート ドライブ（SSD）</li>
</ul>
<p>永続ディスクは <strong>ブートディスク</strong> （OS イメージをインストールした起動ディスク）として利用することができ、 <strong>スナップショット</strong> もまた永続ディスクのみ対応する。（その他は無理）<br>
大まかな違いは以下。</p>
<table>
<thead>
<tr>
<th style="text-align:left">ストレージ</th>
<th style="text-align:left">ユースケース</th>
<th style="text-align:left">パフォーマンス</th>
<th style="text-align:left">冗長性</th>
<th style="text-align:left">スナップショット</th>
<th style="text-align:left">バージョニング</th>
<th style="text-align:left">ブートディスク</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">永続ディスク</td>
<td style="text-align:left">汎用</td>
<td style="text-align:left">中</td>
<td style="text-align:left">あり</td>
<td style="text-align:left">あり</td>
<td style="text-align:left">なし</td>
<td style="text-align:left">○</td>
</tr>
<tr>
<td style="text-align:left">ローカルSSD</td>
<td style="text-align:left">高IOPS、低レイテンシ</td>
<td style="text-align:left">高</td>
<td style="text-align:left">なし</td>
<td style="text-align:left">なし</td>
<td style="text-align:left">なし</td>
<td style="text-align:left">×</td>
</tr>
<tr>
<td style="text-align:left">Cloud Storage バケット</td>
<td style="text-align:left">低コスト、ゾーン間共有</td>
<td style="text-align:left">低</td>
<td style="text-align:left">あり</td>
<td style="text-align:left">なし</td>
<td style="text-align:left">あり</td>
<td style="text-align:left">×</td>
</tr>
</tbody>
</table>
<h3 ref="14-イメージ" >1.4. イメージ</h3><a class="anchor" id="14-イメージ"></a>
<ul>
<li>イメージファミリーとそれに属する OS イメージからなる</li>
<li>インスタンステンプレートや マネージドインスタンスグループ（ MIG ）から起動できる</li>
</ul>
<p>イメージには以下の 2 種類ある。</p>
<ul>
<li><strong>公開イメージ</strong>
<ul>
<li>Google、オープンソース コミュニティ、サードパーティ ベンダーによって提供され、保守されるブートディスクイメージ</li>
</ul>
</li>
<li><strong>カスタムイメージ</strong>
<ul>
<li>ユーザーが所有し、アクセスを制御するブートディスクイメージ</li>
<li><a href="https://cloud.google.com/compute/docs/images/create-delete-deprecate-private-images?hl=ja">カスタム イメージの作成、削除、廃止</a></li>
</ul>
</li>
</ul>
<p>公開 OS イメージの情報は、以下のコマンドで取得可能。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-zsh" data-lang="zsh"><span style="display:flex;"><span>% gcloud compute images list
</span></span><span style="display:flex;"><span>NAME                              PROJECT       FAMILY         DEPRECATED  STATUS
</span></span><span style="display:flex;"><span>centos-6-v20181011                centos-cloud  centos-6                   READY
</span></span><span style="display:flex;"><span>centos-7-v20181011                centos-cloud  centos-7                   READY
</span></span><span style="display:flex;"><span>coreos-alpha-1953-0-0-v20181106   coreos-cloud  coreos-alpha               READY
</span></span><span style="display:flex;"><span>coreos-beta-1939-1-0-v20181106    coreos-cloud  coreos-beta                READY
</span></span><span style="display:flex;"><span>coreos-stable-1911-3-0-v20181106  coreos-cloud  coreos-stable              READY
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>略<span style="color:#f92672">)</span>
</span></span></code></pre></div><h3 ref="15-スナップショット" >1.5. スナップショット</h3><a class="anchor" id="15-スナップショット"></a>
<ul>
<li>イメージより低コストで保存でき、バックアップに適する</li>
<li>ディスクデータを複製できる点でイメージと似ているが、 <strong>インスタンステンプレートからは起動できない</strong></li>
</ul>
<h3 ref="16-ゲスト環境" >1.6. ゲスト環境</h3><a class="anchor" id="16-ゲスト環境"></a>
<ul>
<li>インスタンスを起動すると、ゲスト環境が自動的に VM インスタンスにインストールされる</li>
<li>Compute Engine で VM を適切に実行するために、 <strong>メタデータサーバー</strong> のコンテンツを読み取る一連のスクリプト、デーモン、バイナリから構成される</li>
</ul>
<h3 ref="17-メタデータサーバー" >1.7. メタデータサーバー</h3><a class="anchor" id="17-メタデータサーバー"></a>
<ul>
<li>クライアントからゲストオペレーティングシステムに情報を転送する通信チャネル</li>
<li>すべてのインスタンスはメタデータをメタデータサーバーに保存（ <code>key-value</code> 形式）</li>
<li>メタデータサーバーに対して、インスタンス内からも Compute Engine API からも、プログラムでクエリを実行できる</li>
<li><a href="https://cloud.google.com/compute/docs/metadata/default-metadata-values">デフォルトの VM メタデータ値</a></li>
</ul>
<h3 ref="18-ライブマイグレーション" >1.8. ライブマイグレーション</h3><a class="anchor" id="18-ライブマイグレーション"></a>
<ul>
<li>Compute Engine では、ホストシステムでソフトウェアやハードウェアの更新などのイベントが発生しても、インスタンスの実行を継続できるように、ライブマイグレーションを提供している</li>
<li>ユーザーが VM を再起動しなくても、実行中のインスタンスを同じゾーンの別のホストに移行できる</li>
<li>ただし、以下および以下を含むインスタンスはライブマイグレーションできない
<ul>
<li><a href="https://cloud.google.com/compute/confidential-vm/docs/creating-cvm-instance">Confidential VMs</a>、GPU、<a href="https://cloud.google.com/tpu/docs/tpus">Cloud TPU</a>、<a href="https://cloud.google.com/compute/docs/instances/preemptible">プリエンプティブル インスタンス</a></li>
</ul>
</li>
</ul>
<h3 ref="19-ラベル" >1.9. ラベル</h3><a class="anchor" id="19-ラベル"></a>
<p>Compute の各リソースには <a href="https://cloud.google.com/compute/docs/labeling-resources">リソースのラベル付け</a> を行うことができ、これにより簡単にリソースをグループ化することができる。</p>
<h2 ref="2-インスタンス作成" >2. インスタンス作成</h2><a class="anchor" id="2-インスタンス作成"></a>
<ol>
<li><a href="#21-gcloud-%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%AE%E8%A8%AD%E5%AE%9A">gcloud コマンドの設定</a></li>
<li><a href="#22-%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E4%BD%9C%E6%88%90">インスタンス作成</a></li>
<li><a href="#23-%E8%B5%B7%E5%8B%95%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88">起動スクリプト</a></li>
<li><a href="#24-%E5%8D%98%E4%B8%80%E3%83%86%E3%83%8A%E3%83%B3%E3%83%88%E3%83%8E%E3%83%BC%E3%83%89%E3%81%AB%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E4%BD%9C%E6%88%90">単一テナントノードにインスタンス作成</a></li>
</ol>
<h3 ref="21-gcloud-コマンドの設定" >2.1. gcloud コマンドの設定</h3><a class="anchor" id="21-gcloud-コマンドの設定"></a>
<p>gcloud コマンドの設定情報の確認と変更について記載する。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 設定情報の確認（値が設定されている情報のみ）</span>
</span></span><span style="display:flex;"><span>$ gcloud config list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 設定情報の確認（ unset も含めてすべて）</span>
</span></span><span style="display:flex;"><span>$ gcloud config list --all
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 特定の設定情報の確認</span>
</span></span><span style="display:flex;"><span>$ gcloud config list compute/region
</span></span><span style="display:flex;"><span>$ gcloud config list core/project
</span></span><span style="display:flex;"><span>$ gcloud config list project
</span></span><span style="display:flex;"><span>$ gcloud config get-value project
</span></span></code></pre></div><p>なお、特定の設定情報を取得する場合、 <code>SECTION/PROPERTY</code> （たとえば <code>compute/region</code> ）の形式で指定するのだが、<code>SECTION</code> が <code>core</code> の場合は <code>core/</code> を省略できる。<br>
その他、 <code>SECTION/PROPERTY</code> に関する情報は <a href="https://cloud.google.com/sdk/gcloud/reference/config/set?hl=ja"><code>gcloud config set</code></a> を参照。<br>
情報の設定は <code>gcloud config set</code> コマンドを利用する。<br>
以下は、 gcloud コマンドで多用する情報のため、ターミナルセッション開始時に設定することを推奨する。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># `--project` オプションを省略可能にする</span>
</span></span><span style="display:flex;"><span>$ gcloud config set project &lt;PROJECT ID&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># `--region` オプションを省略可能にする</span>
</span></span><span style="display:flex;"><span>$ gcloud config set compute/region &lt;REGION&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># `--zone` オプションを省略可能にする</span>
</span></span><span style="display:flex;"><span>$ gcloud config set compute/zone &lt;ZONE&gt;
</span></span></code></pre></div><p><code>gcloud</code> コマンドで設定したデフォルト値は <code>bq</code> や <code>gsutil</code> などの <strong>Cloud SDK で共有される</strong> 。（全てかどうかはわからない、、、）<br>
なお、PROJECT 、 REGION 、 ZONE の選択肢となる一覧情報は以下のコマンドで取得可能。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># プロジェクト一覧</span>
</span></span><span style="display:flex;"><span>$ gcloud projects list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># リージョン一覧</span>
</span></span><span style="display:flex;"><span>$ gcloud compute regions list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ゾーン一覧</span>
</span></span><span style="display:flex;"><span>$ gcloud compute zones list
</span></span></code></pre></div><p>また、 <code>gcloud compute</code> ではメタデータを持っており、 <code>project-info</code> で参照できる。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcloud compute project-info describe --project &lt;PROJECT ID&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 例えば、以下のようなメタデータを持っている（持っていないときもある）</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># リージョン情報：google-compute-default-region</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ゾーン情報　　：google-compute-default-zone</span>
</span></span></code></pre></div><p>また、コマンドでの設定ではなく環境変数を利用してもいい。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ export PROJECT_ID<span style="color:#f92672">=</span>&lt;your_project_ID&gt;
</span></span><span style="display:flex;"><span>$ export ZONE<span style="color:#f92672">=</span>&lt;your_zone&gt;
</span></span></code></pre></div><h3 ref="22-インスタンス作成" >2.2. インスタンス作成</h3><a class="anchor" id="22-インスタンス作成"></a>
<p><a href="https://cloud.google.com/sdk/gcloud/reference/compute/instances/create?hl=ja">gcloud compute instances create</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcloud compute instances create INSTANCE_NAME --machine-type n1-standard-2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Created <span style="color:#f92672">[</span>https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-03-7b6d0cd2d87a/zones/us-central1-c/instances/gcelab2<span style="color:#f92672">]</span>.
</span></span><span style="display:flex;"><span>NAME           ZONE           MACHINE_TYPE   PREEMPTIBLE  INTERNAL_IP  EXTERNAL_IP   STATUS
</span></span><span style="display:flex;"><span>INSTANCE_NAME  us-central1-c  n1-standard-2               10.128.0.3   34.70.76.162  RUNNING
</span></span></code></pre></div><ul>
<li>イメージ（ <code>--image=IMAGE</code> | <code>--image-family=IMAGE_FAMILY</code> ）
<ul>
<li>イメージもしくはイメージファミリを指定する必要があり、両方省略した場合はイメージファミリのデフォルト値「Debian 10 (buster) 」が適用される</li>
<li>イメージファミリのみ指定された場合は、ファミリ内の非推奨でない最新のイメージが的ようされる</li>
</ul>
</li>
<li>ブートディスク
<ul>
<li>インスタンスと同じ名前のブートディスク（ 10 GB のバランス永続ディスク）が自動的に作成され組み込まれる</li>
<li>なお、デフォルトではインスタンスを削除するとブートディスクも削除される</li>
</ul>
</li>
</ul>
<p>上記コマンドで作成したら、下記コマンドで確認する。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-zsh" data-lang="zsh"><span style="display:flex;"><span>% gcloud compute instances describe INSTANCE_NAME
</span></span></code></pre></div><p>なお、プロジェクト毎に <code>default</code> という名前のデフォルト VPC ネットワークが作成されており、ネットワークの詳細を指定せずに VM を作成すると、デフォルト VPC ネットワークと同じリージョンにあるサブネットにインスタンスが作成される。<br>
以下のオプションを指定することで、対象のネットワークにインスタンスが作成される。</p>
<ul>
<li><code>--subnet=SUBNET_NAME</code>: サブネットの名前。 VPC は指定したサブネットから推測される。</li>
<li><code>--zone=ZONE_NAME</code>: VM を作成するゾーン（ <code>europe-west1-b</code> など）。リージョンは指定したゾーンから推測される。</li>
</ul>
<p>また、以下のようなオプションもある。</p>
<ul>
<li><strong>Shielded VM インスタンス</strong> で作成： <code>--shielded-secure-boot</code> オプション</li>
<li><strong>プリエンプティブルインスタンス</strong> で作成： <code>--preemptible</code> オプション</li>
</ul>
<h3 ref="23-起動スクリプト" >2.3. 起動スクリプト</h3><a class="anchor" id="23-起動スクリプト"></a>
<p>メタデータ（ <code>--metadata</code> オプション）に起動スクリプトの情報を付与して起動時に実行させることができる。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcloud compute instances create www1 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --image-family debian-9 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --image-project debian-cloud <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --zone us-central1-a <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --tags network-lb-tag <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --metadata startup-script<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;#! /bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sudo apt-get update
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sudo apt-get install apache2 -y
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sudo service apache2 restart
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    echo &#39;&lt;!doctype html&gt;&lt;html&gt;&lt;body&gt;&lt;h1&gt;www1&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#39; | tee /var/www/html/index.html&#34;</span>
</span></span></code></pre></div><p>起動スクリプトが長いなどと行った場合、 Cloud Storage バケットに配置してあるスクリプトを実行することも可能。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Cloud Storage バケットの作成</span>
</span></span><span style="display:flex;"><span>$ gsutil mb -c regional -l us-central1 gs://challenge-quest-12345
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Cloud Console でスクリプトをアップロード</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># インスタンスの作成</span>
</span></span><span style="display:flex;"><span>$ gcloud compute instances create apache --scopes storage-ro <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --metadata startup-script-url<span style="color:#f92672">=</span>gs://challenge-quest-12345/resources-install-web.sh
</span></span></code></pre></div><p><code>--scopes storage-ro</code> オプションを付与することで、インスタンスのサービスアカウントに Cloud Storage へのアクセス権を付与できる。</p>
<h3 ref="24-単一テナントノードにインスタンス作成" >2.4. 単一テナントノードにインスタンス作成</h3><a class="anchor" id="24-単一テナントノードにインスタンス作成"></a>
<p><a href="https://cloud.google.com/compute/docs/nodes/provisioning-sole-tenant-vms?hl=ja">https://cloud.google.com/compute/docs/nodes/provisioning-sole-tenant-vms?hl=ja</a></p>
<h4 ref="241-単一テナントノード-テンプレートを作成" >2.4.1. 単一テナントノード テンプレートを作成</h4><a class="anchor" id="241-単一テナントノード-テンプレートを作成"></a>
<p><a href="https://cloud.google.com/compute/docs/nodes/sole-tenant-nodes?hl=ja">単一テナントノード</a> のテンプレートを作成する。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-zsh" data-lang="zsh"><span style="display:flex;"><span>% gcloud compute sole-tenancy node-templates create TEMPLATE_NAME <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --node-type<span style="color:#f92672">=</span>NODE_TYPE <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  <span style="color:#f92672">[</span>--node-affinity-labels<span style="color:#f92672">=</span>AFFINITY_LABELS <span style="color:#ae81ff">\]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[</span>--region<span style="color:#f92672">=</span>REGION <span style="color:#ae81ff">\]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[</span>--accelerator type<span style="color:#f92672">=</span>GPU_TYPE,count<span style="color:#f92672">=</span>GPU_COUNT <span style="color:#ae81ff">\]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[</span>--disk type<span style="color:#f92672">=</span>local-ssd,count<span style="color:#f92672">=</span>DISK_COUNT,size<span style="color:#f92672">=</span>DISK_SIZE<span style="color:#f92672">]</span>
</span></span></code></pre></div><h4 ref="242-単一ノードグループの自動スケーリング" >2.4.2. 単一ノードグループの自動スケーリング</h4><a class="anchor" id="242-単一ノードグループの自動スケーリング"></a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-zsh" data-lang="zsh"><span style="display:flex;"><span>% gcloud compute sole-tenancy node-groups create group-name <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --node-template template-name <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --target-size size <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --maintenance-policy maintenance-policy <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --zone zone <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --autoscaler-mode mode <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --max-nodes max-nodes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --min-nodes min-nodes
</span></span></code></pre></div><h2 ref="3-ディスクの作成とアタッチ" >3. ディスクの作成とアタッチ</h2><a class="anchor" id="3-ディスクの作成とアタッチ"></a>
<ul>
<li><a href="https://cloud.google.com/compute/docs/disks/add-persistent-disk">ディスクの作成とアタッチ</a></li>
</ul>
<p>ディスクの作成は以下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcloud compute disks create DISK_NAME --size DISK_SIZE --type DISK_TYPE
</span></span></code></pre></div><p>作成したディスクは以下でインスタンスにアタッチする。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcloud compute instances attach-disk INSTANCE_NAME --disk DISK_NAME
</span></span></code></pre></div><p>なお、アタッチしたディスクはマウントしないと利用できないことに注意。<br>
また、インスタンス作成時（ <code>gcloud compute instances create</code> ）にディスクをアタッチした状態で起動するには以下の方法がある。</p>
<ul>
<li>作成済みのディスクをアタッチして起動（ <a href="https://cloud.google.com/sdk/gcloud/reference/compute/instances/create#--disk">参考</a> ）
<ul>
<li>オプション <code>--disk=[auto-delete=AUTO-DELETE],[boot=BOOT],[device-name=DEVICE-NAME],[mode=MODE],[name=NAME],[scope=SCOPE]</code></li>
</ul>
</li>
<li>ディスクを作成・アタッチして起動（ <a href="https://cloud.google.com/sdk/gcloud/reference/compute/instances/create#--create-disk">参考</a> ）
<ul>
<li>オプション <code>--create-disk=[PROPERTY=VALUE,…]</code></li>
</ul>
</li>
</ul>
<h3 ref="31-永続ディスクの操作" >3.1. 永続ディスクの操作</h3><a class="anchor" id="31-永続ディスクの操作"></a>
<p>永続ディスクは、インスタンスを停止することなく <a href="https://cloud.google.com/compute/docs/disks/working-with-persistent-disks#resize_pd">サイズを変更</a> することができる。<br>
以下の手順で行う。</p>
<ol>
<li>ディスクのサイズ変更：<code>gcloud compute disks resize DISK_NAME --size DISK_SIZE</code></li>
<li>ディスクのバックアップ</li>
<li>ファイルシステムとパーティションのサイズの変更（ <code>resize2fs</code> / <code>xfs_growfs</code> によって OS にサイズを再認識させる必要あり ）</li>
</ol>
<h3 ref="32-スナップショット" >3.2. スナップショット</h3><a class="anchor" id="32-スナップショット"></a>
<p><a href="https://cloud.google.com/compute/docs/disks/create-snapshots">スナップショット</a> を作成すると、以下のパターンでディスクとして復元できる。</p>
<ul>
<li>スナップショットから新しい永続ディスクを作成
<ul>
<li>新しいディスクを作成して、スナップショットをソースとして選択</li>
</ul>
</li>
<li>スナップショットから新しいインスタンスを作成
<ul>
<li>新しいインスタンスを作成するときに、スナップショットを使用してそのインスタンスのブートディスクとデータディスクを作成できる</li>
</ul>
</li>
</ul>
<h2 ref="4-ファイアウォールルールの作成" >4. ファイアウォールルールの作成</h2><a class="anchor" id="4-ファイアウォールルールの作成"></a>
<p>以下のコマンドでファイアウォールルールを作成する。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcloud compute firewall-rules create allow-http <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --action<span style="color:#f92672">=</span>allow <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --direction<span style="color:#f92672">=</span>ingress <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --source-ranges<span style="color:#f92672">=</span>0.0.0.0/0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --target-tags<span style="color:#f92672">=</span>http-server <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --rules<span style="color:#f92672">=</span>tcp:80
</span></span></code></pre></div><p>なお、ファイアウォールルールはインスタンスに付与された <strong>ネットワークタグ</strong> や <strong>サービスアカウント</strong> によって適用され、上記の <code>--target-tags</code> や <code>--target-service-accounts</code> オプションで設定された値と対応する。<br>
インスタンス作成時（ <code>gcloud compute instances create</code> ）に <code>--tags</code> オプションを用いてネットワークタグを付与できるが、以下のコマンドで既存インスタンスにタグ付けすることもできる。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcloud compute instances add-tags INSTANCE_NAME --tags<span style="color:#f92672">=</span>http-server
</span></span></code></pre></div><p>また、ファイアウォールルールの優先度は、0〜65535の整数で表現され、値が小さいほど優先度が高くなる。（ <a href="https://cloud.google.com/vpc/docs/firewalls#priority_order_for_firewall_rules">優先度</a> ）</p>
<h2 ref="5-ネットワークインターフェース" >5. ネットワークインターフェース</h2><a class="anchor" id="5-ネットワークインターフェース"></a>
<p>ネットワークインターフェースの付与は <code>gcloud compute instances create</code> コマンド実行時の <a href="https://cloud.google.com/sdk/gcloud/reference/compute/instances/create?hl=ja#--network-interface"><code>--network-interface</code></a> オプションで実施できる。<br>
<code>--network-interface</code> オプションを省略したり、 <code>--network-interface=''</code> を指定すると <code>default</code> ネットワークに <code>nic0</code> が作成される。<br>
<code>--network-interface</code> オプションを複数指定すると、指定した数だけ、指定した順に <code>nic0</code> <code>nic1</code> &hellip; が作成される。（ <a href="https://cloud.google.com/vpc/docs/create-use-multiple-interfaces?hl=ja">複数のネットワーク インターフェースを持つインスタンスの作成</a> ）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$  gcloud compute instances create vm1 --machine-type<span style="color:#f92672">=</span>n1-standard-4 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --network-interface<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --network-interface<span style="color:#f92672">=</span>network<span style="color:#f92672">=</span>net1,subnet<span style="color:#f92672">=</span>net1-subnet-a,private-network-ip<span style="color:#f92672">=</span>10.128.0.2,address<span style="color:#f92672">=</span>my-external-address <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --network-interface<span style="color:#f92672">=</span>network<span style="color:#f92672">=</span>net2,subnet<span style="color:#f92672">=</span>net2-subnet-b,private-network-ip<span style="color:#f92672">=</span>10.129.0.2,no-address
</span></span></code></pre></div><ul>
<li><code>private-network-ip</code> を省略すると、エフェメラル（動的） 内部 IP が作成される</li>
<li><code>address</code> はあらかじめ作成した外部 IP を指定する必要があるが、 <code>address=''</code> を指定するとエフェメラル（動的）外部 IP が作成される</li>
<li><code>address</code> ではなく <code>no-address</code> を指定すると外部 IP は作成されない</li>
</ul>
<h2 ref="6-インスタンスへの接続" >6. インスタンスへの接続</h2><a class="anchor" id="6-インスタンスへの接続"></a>
<p>Cloud Console にて「サイドメニュー」-&gt;「Compute Engine」-&gt;「 VM インスタンス」と選択し、該当インスタンスのレコードで「 SSH 」をクリックするとポップアップしてターミナルが立ち上がる。<br>
もしくは、以下のコマンドを実行する。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># USEGE</span>
</span></span><span style="display:flex;"><span>$ gcloud compute ssh <span style="color:#f92672">[</span>インスタンス名<span style="color:#f92672">]</span> --project<span style="color:#f92672">=</span>PROJECT_ID --zone<span style="color:#f92672">=</span>ZONE VM_NAME
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 具体例（Pass Phrase は空でいい）</span>
</span></span><span style="display:flex;"><span>$ gcloud compute ssh gcelab2 --zone us-central1-c
</span></span></code></pre></div><p>接続できたら、以下のコマンドの管理者権限になる。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo su -
</span></span></code></pre></div><p>ちなみに Linux は SSH 、 Windows は RDP で接続する。</p>
<h2 ref="7-cloud-monitoring--cloud-logging-連携" >7. Cloud Monitoring / Cloud Logging 連携</h2><a class="anchor" id="7-cloud-monitoring--cloud-logging-連携"></a>
<p>Cloud Monitoring では、クラウドで実行されるアプリケーションのパフォーマンスや稼働時間、全体的な動作状況を確認できる。<br>
Google Cloud、Amazon Web Services、ホストされた稼働時間プローブ、アプリケーション インストゥルメンテーション、よく使われるさまざまなアプリケーション コンポーネント（Cassandra、Nginx、Apache ウェブサーバー、Elasticsearch など）から、指標、イベント、メタデータを収集する。<br>
これらのデータを取り込んでダッシュボード、グラフ、アラートを介して分析情報を提供する。<br>
Cloud Monitoring のアラート機能を Slack、PagerDuty、HipChat、Campfire などに組み込むこともできる。</p>
<p>インスタンスから情報を収集する VM に <a href="https://cloud.google.com/monitoring/agent">Monitoring エージェント</a> と <a href="https://cloud.google.com/logging/docs/agent?hl=ja">Logging エージェント</a> をインストールすることで収集可能となる。<br>
対象の VM インスタンスに SSH した後、以下のコマンドでインストールする。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Monitoring エージェントのインストール</span>
</span></span><span style="display:flex;"><span>$ curl -sSO https://dl.google.com/cloudagents/add-monitoring-agent-repo.sh
</span></span><span style="display:flex;"><span>$ sudo bash add-monitoring-agent-repo.sh
</span></span><span style="display:flex;"><span>$ sudo apt-get update
</span></span><span style="display:flex;"><span>$ sudo apt-get install stackdriver-agent
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Logging エージェント</span>
</span></span><span style="display:flex;"><span>$ curl -sSO https://dl.google.com/cloudagents/add-logging-agent-repo.sh
</span></span><span style="display:flex;"><span>$ sudo bash add-logging-agent-repo.sh
</span></span><span style="display:flex;"><span>$ sudo apt-get update
</span></span><span style="display:flex;"><span>$ sudo apt-get install google-fluentd
</span></span></code></pre></div><p>また、Monitoring ワークスペースを作成する必要がある。</p>
<ul>
<li>Cloud Console で、ナビゲーション メニュー &gt; [モニタリング] をクリックすると、ワークスペースがプロビジョニングされる</li>
<li>左側のメニューで [稼働時間チェック] をクリックし、[稼働時間チェックの作成] をクリック</li>
<li>左側のメニューで [アラート]、[Create Policy] の順にクリック</li>
<li>ナビゲーション メニュー &gt; [Logging] &gt; [ログビューア]</li>
</ul>
<h2 ref="8-サービスアカウント" >8. サービスアカウント</h2><a class="anchor" id="8-サービスアカウント"></a>
<p>VM インスタンスにサービスアカウントを付与することによってリソースへのアクセス制御を行う。<br>
サービスアカウントは以下のように作成する。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># サービスアカウントの作成</span>
</span></span><span style="display:flex;"><span>$ gcloud iam service-accounts create SERVICE_ACCOUNT_ID --display-name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;DISPLAY_NAME&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># サービスアカウントへのロールの付与</span>
</span></span><span style="display:flex;"><span>gcloud projects add-iam-policy-binding PROJECT_ID <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --member<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;serviceAccount:SERVICE_ACCOUNT_ID@PROJECT_ID.iam.gserviceaccount.com&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --role<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ROLE_NAME&#34;</span>
</span></span></code></pre></div><p>VM インスタンス作成時にサービスアカウントを付与するには以下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcloud compute instances create INSTANCE_NAME <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --service-account<span style="color:#f92672">=</span>SERVICE_ACCOUNT_EMAIL <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">[</span>--scopes<span style="color:#f92672">=[</span>SCOPES,...<span style="color:#f92672">]]</span>
</span></span></code></pre></div><p>既存の VM インスタンスにサービスアカウントを付与するのは以下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcloud compute instances set-service-account INSTANCE_NAME <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --service-account<span style="color:#f92672">=</span>SERVICE_ACCOUNT <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">[</span>--scopes<span style="color:#f92672">=[</span>SCOPE,...<span style="color:#f92672">]</span>
</span></span></code></pre></div><ul>
<li><a href="https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances?hl=ja#best_practices">ベストプラクティス</a>
<ul>
<li>Compute Engine のデフォルトのサービスアカウントを使用せずに、新しいサービスアカウントを作成</li>
<li>必要なリソースについてのみ、このサービス アカウントに IAM ロールを付与</li>
<li>このサービス アカウントとして実行するようにインスタンスを構成</li>
</ul>
</li>
</ul>
<h2 ref="9-アクセススコープ" >9. アクセススコープ</h2><a class="anchor" id="9-アクセススコープ"></a>
<p><strong>アクセススコープ</strong> は、インスタンスの権限を指定するレガシーな方法。<br>
セキュリティメカニズムではなく、gcloud ツールまたはクライアントライブラリからのリクエストで使用されるデフォルトの OAuth スコープを定義するもの。<br>
これは、gRPC や SignBlob API など、OAuth を介して認証を受けないリクエストには影響しないことに注意。<br>
<code>gcloud compute instances create</code> コマンドの <code>--scopes</code> オプションを使用して、 VM インスタンスに付与することができる。<br>
以下のようなアクセススコープがある。</p>
<ul>
<li><code>https://www.googleapis.com/auth/cloud-platform</code> ：すべての Google Cloud リソースに対する完全アクセス権</li>
<li><code>https://www.googleapis.com/auth/compute</code> ：Compute Engine メソッドに対するフル コントロール アクセス権</li>
<li><code>https://www.googleapis.com/auth/compute.readonly</code> ：Compute Engine メソッドに対する読み取り専用アクセス権</li>
<li><code>https://www.googleapis.com/auth/devstorage.read_only</code> ：Cloud Storage に対する読み取り専用アクセス権</li>
<li><code>https://www.googleapis.com/auth/logging.write</code> ：Compute Engine ログに対する書き込みアクセス権</li>
</ul>
<p>ベストプラクティスとしては、 VM インスタンスのアクセススコープに完全な権限( <code>https://www.googleapis.com/auth/cloud-platform</code> )を付与し、サービスアカウントの IAM ロールで権限を絞るのがよい。</p>
<h2 ref="10-ケーススタディ" >10. ケーススタディ</h2><a class="anchor" id="10-ケーススタディ"></a>
<ol>
<li><a href="#91-apache-%E3%81%AE-vm-%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%82%92%E4%BD%9C%E6%88%90">Apache の VM インスタンスを作成</a></li>
<li><a href="#92-%E8%B8%8F%E3%81%BF%E5%8F%B0%E7%B5%8C%E7%94%B1%E3%81%AE-rdp">踏み台経由の RDP</a></li>
</ol>
<h3 ref="101-apache-の-vm-インスタンスを作成" >10.1. Apache の VM インスタンスを作成</h3><a class="anchor" id="101-apache-の-vm-インスタンスを作成"></a>
<p>要件は以下。</p>
<ul>
<li>Linux 仮想マシン インスタンスの作成</li>
<li>VM インスタンスへの公開アクセスの有効化</li>
<li>基本的な Apache ウェブサーバーの実行</li>
<li>サーバーのテスト</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># リージョン・ゾーンの設定</span>
</span></span><span style="display:flex;"><span>$ gcloud config set compute/region us-central1
</span></span><span style="display:flex;"><span>$ gcloud config set compute/zone us-central1-a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># インスタンスの作成</span>
</span></span><span style="display:flex;"><span>$ gcloud compute instances create apache --machine-type n1-standard-2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># インスタンスへタグ追加</span>
</span></span><span style="display:flex;"><span>$ gcloud compute instances add-tags apache --tags<span style="color:#f92672">=</span>http-server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ファイアウォールルールの作成</span>
</span></span><span style="display:flex;"><span>$ gcloud compute firewall-rules create allow-http <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --action<span style="color:#f92672">=</span>allow <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --direction<span style="color:#f92672">=</span>ingress <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --source-ranges<span style="color:#f92672">=</span>0.0.0.0/0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --target-tags<span style="color:#f92672">=</span>http-server <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --rules<span style="color:#f92672">=</span>tcp:80
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># SSH して apache インストール</span>
</span></span><span style="display:flex;"><span>$ gcloud compute ssh apache
</span></span><span style="display:flex;"><span>$ sudo su -
</span></span><span style="display:flex;"><span>$ apt-get update
</span></span><span style="display:flex;"><span>$ apt-get install apache2 -y
</span></span><span style="display:flex;"><span>$ service apache2 restart
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 外部 IP に対して curl を実行し、 Apache ページが見れることを確認</span>
</span></span></code></pre></div><p>VM インスタンスへログインして Apache の設定するのは面倒なので、メタデータに設定する起動スクリプトを利用するパターンは以下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># リージョン・ゾーンの設定</span>
</span></span><span style="display:flex;"><span>$ gcloud config set compute/region us-central1
</span></span><span style="display:flex;"><span>$ gcloud config set compute/zone us-central1-a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Cloud Storage バケットの作成</span>
</span></span><span style="display:flex;"><span>$ gsutil mb -c regional -l us-central1 gs://challenge-quest-12345
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Cloud Console でスクリプト resources-install-web.sh をアップロード</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># インスタンスの作成（メタデータに Cloud Storage 上の起動スクリプトを設定し、Cloud Storage へのアクセススコープも付与）</span>
</span></span><span style="display:flex;"><span>$ gcloud compute instances create apache --scopes storage-ro <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --metadata startup-script-url<span style="color:#f92672">=</span>gs://challenge-quest-12345/resources-install-web.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ファイアウォールルールの作成</span>
</span></span><span style="display:flex;"><span>$ gcloud compute firewall-rules create allow-http <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --action<span style="color:#f92672">=</span>allow <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --direction<span style="color:#f92672">=</span>ingress <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --source-ranges<span style="color:#f92672">=</span>0.0.0.0/0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --target-tags<span style="color:#f92672">=</span>http-server <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --rules<span style="color:#f92672">=</span>tcp:80
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># インスタンスへタグ追加</span>
</span></span><span style="display:flex;"><span>$ gcloud compute instances add-tags apache --tags<span style="color:#f92672">=</span>http-server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 外部 IP に対して curl を実行し、 Apache ページが見れることを確認</span>
</span></span></code></pre></div><p>ちなみに <code>resources-install-web.sh</code> は以下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>apt-get update
</span></span><span style="display:flex;"><span>apt-get install -y apache2
</span></span></code></pre></div><h3 ref="102-踏み台経由の-rdp" >10.2. 踏み台経由の RDP</h3><a class="anchor" id="102-踏み台経由の-rdp"></a>
<p>要件は以下。</p>
<ul>
<li>環境は <code>us-central1</code> リージョン <code>us-central1-a</code> ゾーンに構築する</li>
<li><code>securenetwork</code> VPC を作成し、 <code>default</code> VPC も利用する</li>
<li><code>securenetwork</code> VPC の <code>us-central1</code> リージョンに <code>securenetwork-us</code> サブネットを作成</li>
<li>Windows Server 2016 の VM インスタンスを 2 台作成する
<ul>
<li>踏み台サーバ： <code>vm-bastionhost</code>
<ul>
<li>nic0 ： <code>securenetwork</code> VPC 、<code>us-central1</code> リージョン、<code>securenetwork-us</code> サブネット、内部 IP あり、外部 IP あり</li>
<li>nic1 ： <code>default</code> VPC 、<code>us-central1</code> リージョン、<code>default</code> サブネット、内部 IP あり、外部 IP なし</li>
</ul>
</li>
<li>セキュアサーバ： <code>vm-securehost</code>
<ul>
<li>nic0 ： <code>securenetwork</code> VPC 、<code>us-central1</code> リージョン、<code>securenetwork-us</code> サブネット、内部 IP あり、外部 IP なし</li>
<li>nic1 ： <code>default</code> VPC 、<code>us-central1</code> リージョン、<code>default</code> サブネット、内部 IP あり、外部 IP なし</li>
</ul>
</li>
</ul>
</li>
<li>RDP を許可するファイアウォールルールを <code>securenetwork</code> VPC に作成し、踏み台サーバ <code>vm-bastionhost</code> に適用する</li>
<li>各サーバのログインパスワードをリセットして、踏み台サーバ経由でセキュアサーバに RDP できることを確認する</li>
</ul>
<p>コマンドベースでの作成は以下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># リージョン・ゾーンの設定</span>
</span></span><span style="display:flex;"><span>$ gcloud config set compute/region us-central1
</span></span><span style="display:flex;"><span>$ gcloud config set compute/zone us-central1-a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># securenetwork VPC を作成</span>
</span></span><span style="display:flex;"><span>$ gcloud compute networks create securenetwork --subnet-mode<span style="color:#f92672">=</span>custom
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># securenetwork VPC の存在確認</span>
</span></span><span style="display:flex;"><span>$ gcloud compute networks list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># securenetwork-us サブネットを securenetwork VPC に作成</span>
</span></span><span style="display:flex;"><span>$ gcloud compute networks subnets create securenetwork-us --network<span style="color:#f92672">=</span>securenetwork --region<span style="color:#f92672">=</span>us-central1 --range<span style="color:#f92672">=</span>172.16.0.0/24
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># securenetwork-us サブネットの存在確認</span>
</span></span><span style="display:flex;"><span>$ gcloud compute networks subnets list --sort-by<span style="color:#f92672">=</span>NETWORK
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 外部からの RDP を許可するファイアウォールルールを securenetwork VPC に作成（ターゲットタグ：allow-rdp）</span>
</span></span><span style="display:flex;"><span>$ gcloud compute firewall-rules create securenetwork-allow-rdp --direction<span style="color:#f92672">=</span>INGRESS --priority<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span> --network<span style="color:#f92672">=</span>securenetwork --action<span style="color:#f92672">=</span>ALLOW --rules<span style="color:#f92672">=</span>tcp:3389 --source-ranges<span style="color:#f92672">=</span>0.0.0.0/0 --target-tags<span style="color:#f92672">=</span>allow-rdp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ファイアウォールルール securenetwork-allow-rdp の存在確認</span>
</span></span><span style="display:flex;"><span>$ gcloud compute firewall-rules list | grep securenetwork
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Windows サーバのイメージ検索</span>
</span></span><span style="display:flex;"><span>$ gcloud compute images list --project windows-cloud --no-standard-images
</span></span><span style="display:flex;"><span>NAME                                                  PROJECT        FAMILY                            DEPRECATED  STATUS
</span></span><span style="display:flex;"><span>windows-server-2016-dc-v20210413                      windows-cloud  windows-2016                                  READY
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 踏み台サーバ vm-bastionhost の作成</span>
</span></span><span style="display:flex;"><span>$ gcloud compute instances create vm-bastionhost <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --image<span style="color:#f92672">=</span>windows-server-2016-dc-v20210413 --image-project<span style="color:#f92672">=</span>windows-cloud <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --boot-disk-size<span style="color:#f92672">=</span>50GB --boot-disk-type<span style="color:#f92672">=</span>pd-balanced --boot-disk-device-name<span style="color:#f92672">=</span>vm-bastionhost <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --zone<span style="color:#f92672">=</span>us-central1-a <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --network-interface<span style="color:#f92672">=</span>network<span style="color:#f92672">=</span>securenetwork,subnet<span style="color:#f92672">=</span>securenetwork-us,address<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span> <span style="color:#ae81ff">\ </span><span style="color:#75715e"># nic0</span>
</span></span><span style="display:flex;"><span>    --network-interface<span style="color:#f92672">=</span>network<span style="color:#f92672">=</span>default,subnet<span style="color:#f92672">=</span>default,no-address <span style="color:#ae81ff">\ </span>               <span style="color:#75715e"># nic1</span>
</span></span><span style="display:flex;"><span>    --tags<span style="color:#f92672">=</span>allow-rdp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># セキュアサーバ vm-securehost の作成</span>
</span></span><span style="display:flex;"><span>$ gcloud compute instances create vm-securehost <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --image<span style="color:#f92672">=</span>windows-server-2016-dc-v20210413 --image-project<span style="color:#f92672">=</span>windows-cloud <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --boot-disk-size<span style="color:#f92672">=</span>50GB --boot-disk-type<span style="color:#f92672">=</span>pd-balanced --boot-disk-device-name<span style="color:#f92672">=</span>vm-securehost <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --zone<span style="color:#f92672">=</span>us-central1-a <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --network-interface<span style="color:#f92672">=</span>network<span style="color:#f92672">=</span>securenetwork,subnet<span style="color:#f92672">=</span>securenetwork-us,no-address <span style="color:#ae81ff">\ </span><span style="color:#75715e"># nic0</span>
</span></span><span style="display:flex;"><span>    --network-interface<span style="color:#f92672">=</span>network<span style="color:#f92672">=</span>default,subnet<span style="color:#f92672">=</span>default,no-address                  <span style="color:#75715e"># nic1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 作成した VM インスタンスの確認（ vm-bastionhost には外部 IP がある）</span>
</span></span><span style="display:flex;"><span>$ gcloud compute instances list
</span></span><span style="display:flex;"><span>NAME            ZONE           MACHINE_TYPE   PREEMPTIBLE  INTERNAL_IP            EXTERNAL_IP    STATUS
</span></span><span style="display:flex;"><span>vm-bastionhost  us-central1-a  n1-standard-1               172.16.0.2,10.128.0.3  35.188.38.100  RUNNING
</span></span><span style="display:flex;"><span>vm-securehost   us-central1-a  n1-standard-1               172.16.0.3,10.128.0.4                 RUNNING
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># vm-bastionhost のログインパスワードのリセット</span>
</span></span><span style="display:flex;"><span>$ gcloud compute reset-windows-password vm-bastionhost --user app_admin --zone us-central1-a
</span></span><span style="display:flex;"><span>ip_address: 35.188.38.100
</span></span><span style="display:flex;"><span>password:   8Q6;6!lTnAo$.G3
</span></span><span style="display:flex;"><span>username:   app_admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># vm-securehost のログインパスワードのリセット</span>
</span></span><span style="display:flex;"><span>$ gcloud compute reset-windows-password vm-securehost --user app_admin --zone us-central1-a
</span></span><span style="display:flex;"><span>password: <span style="color:#f92672">[</span>/3xiN<span style="color:#f92672">(</span>:uvp2CWR
</span></span><span style="display:flex;"><span>username: app_admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># vm-bastionhost の securenetwork の外部 IP で RDP して、 vm-securehost の default ネットワークの内部 IP で RPD する</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># mstsc.exe コマンド</span>
</span></span></code></pre></div>
		</div>






	
	

      </section>

      
      
    </article>
    
    
    <footer>
      

		
	
			
		
	    	
	  	
	
    </footer>
    



  </body>
</html>
