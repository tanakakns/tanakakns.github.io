

<!DOCTYPE html>
<html>
  <head>
    <title>
	BigQuery :: テックまとめ
</title>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="revised" content="2022-05-03T11:46:49 JST">
<meta name="description" content="備忘録用メモサイト">



<title>BigQuery :: テックまとめ</title>

<link rel="shortcut icon" href='/images/favicon.png' type="image/x-icon" />

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css">

<script src='https://code.jquery.com/jquery-3.5.1.min.js'></script>

<link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel="stylesheet">



<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/layout.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/css/style.main.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/css/style.menu.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/notice.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/tabs.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/panel.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/columns.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/children.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/attachments.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/alert.css'>
<link rel="stylesheet" type="text/css" href='/css/docport.css'>

<script src='/js/docport.js'></script>
<script type="text/javascript">
      var baseurl = "https:\/\/tanakakns.github.io\/";
</script>




    
  </head>

  <body data-url="/gcp/databases/bigquery/"

  class="hidetoc hidenextpage ">

<style type="text/css">
  #debug{
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    line-height: 3.5rem;
    margin-bottom: .35rem;
    padding: 0 2rem;
    position: fixed;
    left: 0;      right: 0;     top: 0;
   
    top:0px;
    
    min-height: 150px;

    background-color: white;
    border: 3px solid red;
    z-index: 10000 ;
    word-wrap: all;
    overflow: auto;
  }
</style>
 


    
    
    <header style="">
        <div>
    
    <div class="burger ">
        <a href="javascript:void(0);" style="font-size:15px;" onclick="$('article > aside').toggleClass('responsive')">&#9776;</a>
    </div>
    

    <div>

		
	
			
		
	    	<a class='baselink' href='https://tanakakns.github.io/'>テックまとめ</a>
	  	
	</div>

</div>
    </header>
    

    <article>
      
      <aside class="">
        

		
	
			
		
	    	
	  	
	<div id="close_menu">
  <a href="javascript:void(0);" style="font-size:15px;" onclick="$('article > aside').toggleClass('responsive')">
      <i class="fa fa-lg fa-times"></i>
  </a>
</div>

<ul class="menu">

    <li data-nav-id="https://tanakakns.github.io/design/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/design/">設計</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/design/principle-practice/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/design/principle-practice/">原理原則・ベストプラクティス</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/design/microservices/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/design/microservices/">マイクロサービス</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/design/clean-architecture/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/design/clean-architecture/">クリーンアーキテクチャ</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/aws/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/aws/">AWS</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/aws/well-architected-framework/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/well-architected-framework/">AWS Well-Architected フレームワーク</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/database/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/database/">データベース</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/aws/database/aurora/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/database/aurora/">Aurora</a>
      
        
      
    </li>
        </ul>
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/gcp/" class="dd-item parent haschildren
        item_level_$level
        ">

      
      
      
      
          <i class="fas fa-chevron-down ddexp"></i>
        
      
          <a href="/gcp/">GCP</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/gcp-aws/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/gcp-aws/">GCP と AWS の比較</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/monitoring/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/monitoring/">監視</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/tools/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/tools/">ツール</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/tools/management-tools/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/tools/management-tools/">管理ツール</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/tools/dev-tools/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/tools/dev-tools/">開発ツール</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/access-control-and-security/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/access-control-and-security/">アクセス制御とセキュリティ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/">コンピューティングとホスティング</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/compute-engine/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/compute-engine/">Compute Engine</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/kubernetes-engine/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/kubernetes-engine/">Google Kubernetes Engine</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/app-engine/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/app-engine/">App Engine</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/cloud-functions/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/cloud-functions/">Cloud Functions</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/storage/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/storage/">ストレージ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/" class="dd-item parent haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/">データベース</a>
      
          <i class="fas fa-chevron-down ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/bigquery/" class="dd-item parent active
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/bigquery/">BigQuery</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/sql/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/sql/">Cloud SQL</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/memorystore/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/memorystore/">Memorystore</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/spanner/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/spanner/">Cloud Spanner</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/">ネットワーキング</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/vpc/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/vpc/">VPC</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/load-balancing/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/load-balancing/">Cloud Load Balancing</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/iap/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/iap/">Identity-Aware Proxy</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/interconnect/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/interconnect/">Cloud Interconnect</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/big-data/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/big-data/">ビッグデータ</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/big-data/pubsub/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/big-data/pubsub/">Cloud Pub/Sub</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/big-data/dataflow/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/big-data/dataflow/">Dataflow</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/machine-learning/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/machine-learning/">機械学習</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/kubernetes/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/kubernetes/">Kubernetes</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/concept/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/concept/">概念整理</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/architecture/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/architecture/">アーキテクチャ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/kubectl-plugin/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/kubectl-plugin/">kubectl plugin と Krew</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/command/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/command/">コマンド</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/manifest/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/manifest/">マニフェスト</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/application-management/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/application-management/">アプリケーション管理</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/cluster-management/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/cluster-management/">クラスタ管理</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/security/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/security/">セキュリティ</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/istio/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/istio/">Istio</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/istio/basic/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/istio/basic/">入門</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/istio/concept/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/istio/concept/">概念整理</a>
      
        
      
    </li>
        </ul>
    </li>
    



</ul>

		
	
			
		
	    	
	  	
	
      </aside>
      

      <section class="page ">
      
	
		
    
    
    <nav id="ariane" aria-label="breadcrumb">
      <ol class="ariane">
        
  
  	
		
  
  	
		
  
  	
	<li >
      <a class="text-link" href="https://tanakakns.github.io/">
        
      </a>
    </li>
	
  
    <li class="">
      <a class="text-link" href="/gcp/">
        GCP
      </a>
    </li>
	
  	
  
    <li class="">
      <a class="text-link" href="/gcp/databases/">
        データベース
      </a>
    </li>
	
  	
  
    <li class="active">
      
        BigQuery
      
    </li>

      </ol>
    </nav>
    
    

    
		
        
		
		
		
		
		
		
		

		
			<h1>BigQuery</h1>
        

		
										
		

		
	

	
	
	






	<div class="content">
	    <p><a href="https://cloud.google.com/bigquery/docs">BigQuery</a> は Google Cloud Platform 上で動作する、ペタバイト規模のフルマネージド データ ウェアハウス。<br>
データ アナリストやデータ サイエンティストは、サーバーを設定、管理することなく、大規模なデータセットに対するクエリ（ SQL ）やフィルタの実行、結果の集計、複雑な操作の実行が可能。<br>
コマンドライン ツール（ <code>bq</code> ）またはウェブ コンソールを使用して、GCP プロジェクトに格納されているデータを管理、照会できる。</p>
<ol>
<li>アクセスコントロール</li>
<li>パーティション分割と有効期限</li>
<li>外部データソースに対するクエリ</li>
<li>BigQuery へのデータの読み込み</li>
<li>BiGQuery へのクエリ</li>
<li>テーブルスキーマの変更</li>
<li>コスト</li>
</ol>
<h2 ref="1-アクセスコントロール" >1. アクセスコントロール</h2><a class="anchor" id="1-アクセスコントロール"></a>
<p><a href="https://cloud.google.com/bigquery/docs/access-control#bigquery">BigQuery の IAM 事前定義ロール</a></p>
<ul>
<li>BigQuery 管理者 <code>roles/bigquery.admin</code>
<ul>
<li>全権限</li>
</ul>
</li>
<li>BigQuery データ編集者 <code>roles/bigquery.dataEditor</code>
<ul>
<li>テーブル・ビュー・データ・データセットの CRUD</li>
<li>ジョブに関する権限は無い</li>
</ul>
</li>
<li>BigQuery データオーナー <code>roles/bigquery.dataOwner</code>
<ul>
<li>BigQuery データ編集者 <code>roles/bigquery.dataEditor</code> の上位互換？</li>
<li>ジョブに関する権限は無い</li>
</ul>
</li>
<li>BigQuery データ閲覧者 <code>roles/bigquery.dataViewer</code>
<ul>
<li>テーブル・ビュー・データ・データセットの Read のみ</li>
<li>ジョブに関する権限は無い</li>
</ul>
</li>
<li>BigQuery ジョブユーザー <code>roles/bigquery.jobUser</code>
<ul>
<li>ジョブの作成・実行権限</li>
<li>ジョブを通じてのみデータへアクセスできる（直接データを閲覧sうる権限は無い）</li>
</ul>
</li>
<li>BigQuery メタデータ閲覧者 <code>roles/bigquery.metadataViewer</code>
<ul>
<li>メタデータ（テーブル・ビュー・データセット） の Read のみ</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">Capability</th>
<th style="text-align:center"><strong>dataViewer</strong></th>
<th style="text-align:center"><strong>dataEditor</strong></th>
<th style="text-align:center"><strong>dataOwner</strong></th>
<th style="text-align:center"><strong>metadataViewer</strong></th>
<th style="text-align:center"><strong>user</strong></th>
<th style="text-align:center"><strong>jobUser</strong></th>
<th style="text-align:center"><strong>admin</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">List/Get projects</td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
</tr>
<tr>
<td style="text-align:left">List tables</td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center"></td>
<td style="text-align:center">o</td>
</tr>
<tr>
<td style="text-align:left">Get table metadata</td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">o</td>
</tr>
<tr>
<td style="text-align:left">Get table data</td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">o</td>
</tr>
<tr>
<td style="text-align:left">Create tables</td>
<td style="text-align:center"></td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">o</td>
</tr>
<tr>
<td style="text-align:left">Modify/Delete tables</td>
<td style="text-align:center"></td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">o</td>
</tr>
<tr>
<td style="text-align:left">Get dataset metadata</td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center"></td>
<td style="text-align:center">o</td>
</tr>
<tr>
<td style="text-align:left">Create new datasets</td>
<td style="text-align:center"></td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center"></td>
<td style="text-align:center">o</td>
<td style="text-align:center"></td>
<td style="text-align:center">o</td>
</tr>
<tr>
<td style="text-align:left">Modify/Delete datasets</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">o</td>
<td style="text-align:center"></td>
<td style="text-align:center">Self</td>
<td style="text-align:center"></td>
<td style="text-align:center">o</td>
</tr>
<tr>
<td style="text-align:left">Create jobs/queries</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
<td style="text-align:center">o</td>
</tr>
<tr>
<td style="text-align:left">Get jobs</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">Self</td>
<td style="text-align:center">Any</td>
</tr>
<tr>
<td style="text-align:left">List jobs</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">Any</td>
<td style="text-align:center"></td>
<td style="text-align:center">Any</td>
</tr>
</tbody>
</table>
<p>なお、リソースに対する権限コントロールの最小は <strong>データセット</strong> となる。テーブル・ビュー・行・列単位の権限コントロールはできない。</p>
<h2 ref="2-パーティション分割と有効期限" >2. パーティション分割と有効期限</h2><a class="anchor" id="2-パーティション分割と有効期限"></a>
<p>BigQuery では以下のようにデータのパーティション分割と有効期限を設定できる。</p>
<ul>
<li><a href="https://cloud.google.com/bigquery/docs/partitioned-tables#ingestion_time">パーティション分割</a>
<ul>
<li>取り込み時間パーティション分割テーブル</li>
<li>日付、タイムスタンプ、日時パーティション分割テーブル</li>
</ul>
</li>
<li><a href="http://cloud.google.com/bigquery/docs/best-practices-storage#use_the_expiration_settings_to_remove_unneeded_tables_and_partitions">有効期限</a>
<ul>
<li>パーティションやテーブルデータの有効期限を設定できる</li>
</ul>
</li>
</ul>
<p><a href="https://cloud.google.com/bigquery/docs/querying-partitioned-tables?hl=ja">パーティション分割テーブルのクエリ</a> を実行したい場合、 疑似列 <code>_PARTITIONTIME</code> / <code>_PARTITIONDATE</code> が使用でき、適切にパーティションに対してクエリできる。<br>
さらに、 「From <code>bigquery-public-data.noaa_gsod.gsod*</code>」 のようなワイルドカードを利用したテーブルに対しては、 疑似列 <code>_TABLE_SUFFIX</code> を利用することでその範囲を指定できる。</p>
<h2 ref="3-外部データソースに対するクエリ" >3. 外部データソースに対するクエリ</h2><a class="anchor" id="3-外部データソースに対するクエリ"></a>
<p>BigQuery は <a href="https://cloud.google.com/bigquery/external-data-sources">外部データソース</a> に対してクエリを発行できる。</p>
<ul>
<li>Cloud SQL</li>
<li>Bigtable</li>
<li>Cloud Storage</li>
<li>Google ドライブ</li>
</ul>
<p>ただし、データの整合性が取れないなどの制約はある。<br>
外部データソースにクエリする場合でも、 <a href="https://cloud.google.com/bigquery/external-table-definition">外部データソースに対するテーブル定義ファイルの作成</a> は必要。</p>
<h2 ref="4-bigquery-へのデータの読み込み" >4. BigQuery へのデータの読み込み</h2><a class="anchor" id="4-bigquery-へのデータの読み込み"></a>
<p><a href="https://cloud.google.com/bigquery/docs/loading-data">読み込み</a> には以下の選択肢がある。</p>
<ul>
<li>バッチ読み込み
<ul>
<li>単一のバッチオペレーションでソースデータ（CSV ファイル、外部データベース、ログファイルなど）を BigQuery テーブルに読み込む</li>
<li>従来の抽出、変換、読み込み（ETL）ジョブはこのカテゴリに分類される</li>
<li>バッチ読み込みは、一回限りまたは定期的なスケジュールで行える
<ul>
<li>BigQuery Data Transfer Service の転送はスケジュールに基づいて実行</li>
<li>Cloud Composer などのオーケストレーション サービスを使用して、読み込みジョブをスケジュール</li>
<li>cron ジョブを使用して、スケジュールに従ってデータを読み込み</li>
</ul>
</li>
</ul>
</li>
<li>ストリーミング
<ul>
<li>データを一度に 1 つずつ、または一括して送信し、ストリーミング API を直接呼び出すコードを記述できる</li>
<li>あるいは、Dataflow を Apache Beam SDK で使用してストリーミング パイプラインを設定することもできる</li>
<li>ストリーミングはデータサイズによって別途 <strong>追加料金が発生</strong> することに注意（ <a href="https://cloud.google.com/bigquery/pricing#data_ingestion_pricing">参考</a> ）</li>
</ul>
</li>
<li>クエリ結果のテーブル追加・上書き
<ul>
<li>データ操作言語（DML）ステートメントを使用して、既存のテーブルへの一括挿入や、新しいテーブルでのクエリの結果の保存ができる</li>
</ul>
</li>
<li>サードパーティアプリケーションやサービスの利用
<ul>
<li>一部のサードパーティ アプリケーションやサービスでは、データを BigQuery に取り込むためのコネクタが提供されている</li>
<li><a href="https://cloud.google.com/bigquery-transfer/docs/transfer-service-overview">BigQuery Data Transfer Service</a> を利用すれば Google Analytics などの Google のサービスや一部のクラウド/SaaS のストレージ/DWHからデータをインポートできる</li>
</ul>
</li>
</ul>
<p>なお、CSV ファイルなどからデータを読み込む際、形式などに不正がありインポートに失敗するレコードが含まれる場合、BigQueryの機能で自動でどうこうすることはできない。<br>
Dataflow などで行のバリデーションを実施した上でインポートするしかない。</p>
<h2 ref="5-bigquery-へのクエリ" >5. BigQuery へのクエリ</h2><a class="anchor" id="5-bigquery-へのクエリ"></a>
<h3 ref="51-クエリの種類" >5.1. クエリの種類</h3><a class="anchor" id="51-クエリの種類"></a>
<p>BigQuery には次のようなクエリ・ジョブがある。</p>
<ul>
<li>インタラクティブ クエリ
<ul>
<li>すぐに実行されるクエリ（デフォルト）</li>
</ul>
</li>
<li>バッチ クエリ
<ul>
<li>BigQuery はユーザーに代わって各バッチクエリをキューに格納し、アイドル状態のリソースが使用可能になると直ちに（通常は数分以内に）クエリを開始する</li>
</ul>
</li>
<li>クエリジョブ
<ul>
<li>データの読み込み、データのエクスポート、データのクエリ、データのコピーなど、BigQuery がユーザーに代わって実行するアクションのこと</li>
</ul>
</li>
</ul>
<h3 ref="52-クエリの結果" >5.2. クエリの結果</h3><a class="anchor" id="52-クエリの結果"></a>
<p>すべてのクエリ結果は <strong>永続テーブル</strong> または <strong>一時テーブル</strong> に保存される。</p>
<ul>
<li>永続テーブル
<ul>
<li>ユーザーがアクセス可能なデータセットに含まれる新規または既存のテーブル</li>
</ul>
</li>
<li>一時テーブル
<ul>
<li>永続的なテーブルに書き込まれていない一時テーブルを使用してクエリ結果をキャッシュに保存する（通常 24 時間）</li>
<li><code>CURRENT_TIMESTAMP()</code> や <code>NOW()</code> といった日時関数や <code>SESSION_USER()</code> 関数など、また、ワイルドカードを利用する場合はキャッシュは機能しない</li>
<li>また、 <strong>ジョブ</strong> 構成、GCPコンソール、従来のWeb UI、コマンドライン、またはAPIで宛先テーブルが指定されている場合もクエリ結果はキャッシュされない</li>
</ul>
</li>
</ul>
<h2 ref="6-テーブルスキーマの変更" >6. テーブルスキーマの変更</h2><a class="anchor" id="6-テーブルスキーマの変更"></a>
<p><a href="https://cloud.google.com/bigquery/docs/managing-table-schemas">テーブルスキーマの変更</a> を行う際、以下の場合その変更はネイティブにサポートされている。</p>
<ul>
<li>スキーマ定義への列の追加</li>
<li>スキーマ定義からの列の削除またはドロップ</li>
<li>列のモードの REQUIRED から NULLABLE への緩和</li>
</ul>
<p>しかし以下の場合、新しいテーブルを作成して、 SELECT-INSERT してデータ移行する必要がある。</p>
<ul>
<li>列の名前の変更</li>
<li>列のデータ型の変更</li>
<li>列のモードの変更（REQUIRED 列を NULLABLE に緩和することを除く）</li>
</ul>
<h2 ref="7-承認済みのビュー" >7. 承認済みのビュー</h2><a class="anchor" id="7-承認済みのビュー"></a>
<p>データセットに表示アクセス権を設定する場合、BigQuery では <a href="https://cloud.google.com/bigquery/docs/authorized-views">承認済みのビュー</a> を作成する。<br>
承認済みビューを使用すると、元のソースデータへのアクセス権がないユーザーでも、クエリの結果を特定のユーザーやグループと共有できる。</p>
<h2 ref="7-コスト" >7. コスト</h2><a class="anchor" id="7-コスト"></a>
<p>BigQuery のコストは大きく以下の 2 つある。</p>
<ul>
<li>分析料金
<ul>
<li>クエリの処理にかかる費用</li>
<li>SQL クエリ、ユーザー定義関数、スクリプト、テーブルをスキャンする特定のデータ操作言語（DML）とデータ定義言語（DDL）のステートメントなど</li>
</ul>
</li>
<li>ストレージ料金
<ul>
<li>BigQuery に読み込むデータを保存する費用</li>
</ul>
</li>
</ul>
<p>分析料金はさらに以下に分かれる。</p>
<ul>
<li>オンデマンド料金
<ul>
<li>各クエリによって処理されたバイト数に基づいて課金</li>
<li>処理されるクエリデータは毎月 1 TB まで無料</li>
<li>クエリの見積もりは <code>bq query --dry_run</code> で読み取られるバイト数を見積もり、Google Cloud 料金計算ツール（<a href="https://cloud.google.com/products/calculator/">Google Cloud Pricing Calculator</a>）で料金を見積もる</li>
</ul>
</li>
<li>定額料金
<ul>
<li>仮想 CPU であるスロットを購入（スロットを購入すると、クエリの実行に使用できる専用の処理容量を購入したことになる）</li>
<li>スロットは以下のコミットメント プランで使用できる
<ul>
<li>Flex Slots: 最初の 60 秒分のコミットメントを購入</li>
<li>月間: 最初の 30 日分のコミットメントを購入</li>
<li>年間: 365 日分のコミットメントを購入</li>
</ul>
</li>
<li>月間プランと年間プランでは、長期的な容量コミットメントと引き換えに割引が適用される</li>
</ul>
</li>
</ul>
<p>ストレージ料金はさらに以下に分かれる。</p>
<ul>
<li>アクティブ
<ul>
<li>テーブルで、過去 90 日間で変更されたデータに対する月額料金</li>
</ul>
</li>
<li>長期
<ul>
<li>テーブルまたはパーティションで、過去 90 日間変更されていないデータに対する月額料金</li>
</ul>
</li>
</ul>
<p>また、 <a href="https://cloud.google.com/bigquery/docs/custom-quotas#controlling_query_costs_using_bigquery_custom_quotas">カスタムコスト管理</a> を利用することにより、1 日に処理されるクエリデータの量に対する上限を指定することができる。</p>
		</div>






	
	

      </section>

      
      
    </article>
    
    
    <footer>
      

		
	
			
		
	    	
	  	
	
    </footer>
    



  </body>
</html>
