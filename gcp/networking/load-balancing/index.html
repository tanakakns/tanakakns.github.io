

<!DOCTYPE html>
<html>
  <head>
    <title>
	Cloud Load Balancing :: テックまとめ
</title>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="revised" content="2021-07-05T21:58:56 JST">
<meta name="description" content="備忘録用メモサイト">



<title>Cloud Load Balancing :: テックまとめ</title>

<link rel="shortcut icon" href='/images/favicon.png' type="image/x-icon" />

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css">

<script src='https://code.jquery.com/jquery-3.5.1.min.js'></script>

<link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel="stylesheet">



<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/layout.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/css/style.main.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/css/style.menu.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/notice.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/tabs.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/panel.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/columns.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/children.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/attachments.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/alert.css'>
<link rel="stylesheet" type="text/css" href='/css/docport.css'>

<script src='/js/docport.js'></script>
<script type="text/javascript">
      var baseurl = "https:\/\/tanakakns.github.io\/";
</script>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-42388425-3', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
  </head>

  <body data-url="/gcp/networking/load-balancing/"

  class="hidetoc hidenextpage ">

<style type="text/css">
  #debug{
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    line-height: 3.5rem;
    margin-bottom: .35rem;
    padding: 0 2rem;
    position: fixed;
    left: 0;      right: 0;     top: 0;
   
    top:0px;
    
    min-height: 150px;

    background-color: white;
    border: 3px solid red;
    z-index: 10000 ;
    word-wrap: all;
    overflow: auto;
  }
</style>
 


    
    
    <header style="">
        <div>
    
    <div class="burger ">
        <a href="javascript:void(0);" style="font-size:15px;" onclick="$('article > aside').toggleClass('responsive')">&#9776;</a>
    </div>
    

    <div>

		
	
			
		
	    	<a class='baselink' href='https://tanakakns.github.io/'>テックまとめ</a>
	  	
	</div>

</div>
    </header>
    

    <article>
      
      <aside class="">
        

		
	
			
		
	    	
	  	
	<div id="close_menu">
  <a href="javascript:void(0);" style="font-size:15px;" onclick="$('article > aside').toggleClass('responsive')">
      <i class="fa fa-lg fa-times"></i>
  </a>
</div>

<ul class="menu">

    <li data-nav-id="https://tanakakns.github.io/design/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/design/">設計</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/design/architecture/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/design/architecture/">アーキテクチャ</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/mac/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/mac/">Mac開発環境</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/mac/os-settings/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/mac/os-settings/">OSの設定</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/mac/homebrew/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/mac/homebrew/">Homebrew</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/mac/asdf/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/mac/asdf/">asdf</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/git/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/git/">Git</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/git/initial-setting/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/git/initial-setting/">初期設定</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/go/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/go/">Go言語</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/go/initial-setting/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/go/initial-setting/">初期設定</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/go/grammar/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/go/grammar/">文法</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/go/naming/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/go/naming/">命名規則</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/go/pattern/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/go/pattern/">パターン</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/database/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/database/">Database</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/database/rdb/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/database/rdb/">RDB</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/aws/" class="dd-item
        item_level_$level
        ">

      
      
      
      
        
      
          <a href="/aws/">AWS</a>
      
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/gcp/" class="dd-item parent haschildren
        item_level_$level
        ">

      
      
      
      
          <i class="fas fa-chevron-down ddexp"></i>
        
      
          <a href="/gcp/">GCP</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/gcp-aws/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/gcp-aws/">GCP と AWS の比較</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/monitoring/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/monitoring/">監視</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/tools/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/tools/">ツール</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/tools/management-tools/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/tools/management-tools/">管理ツール</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/tools/dev-tools/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/tools/dev-tools/">開発ツール</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/access-control-and-security/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/access-control-and-security/">アクセス制御とセキュリティ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/">コンピューティングとホスティング</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/compute-engine/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/compute-engine/">Compute Engine</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/kubernetes-engine/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/kubernetes-engine/">Google Kubernetes Engine</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/app-engine/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/app-engine/">App Engine</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/cloud-functions/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/cloud-functions/">Cloud Functions</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/storage/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/storage/">ストレージ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/">データベース</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/bigquery/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/bigquery/">BigQuery</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/sql/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/sql/">Cloud SQL</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/memorystore/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/memorystore/">Memorystore</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/spanner/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/spanner/">Cloud Spanner</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/" class="dd-item parent haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/">ネットワーキング</a>
      
          <i class="fas fa-chevron-down ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/vpc/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/vpc/">VPC</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/load-balancing/" class="dd-item parent active
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/load-balancing/">Cloud Load Balancing</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/iap/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/iap/">Identity-Aware Proxy</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/interconnect/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/interconnect/">Cloud Interconnect</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/big-data/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/big-data/">ビッグデータ</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/big-data/pubsub/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/big-data/pubsub/">Cloud Pub/Sub</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/big-data/dataflow/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/big-data/dataflow/">Dataflow</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/machine-learning/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/machine-learning/">機械学習</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/terraform/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/terraform/">Terraform</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/terraform/basic/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/terraform/basic/">入門</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/docker/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/docker/">Docker</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/docker/basic/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/docker/basic/">入門</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/kubernetes/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/kubernetes/">Kubernetes</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/concept/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/concept/">概念整理</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/architecture/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/architecture/">アーキテクチャ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/kubectl-plugin/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/kubectl-plugin/">kubectl plugin と Krew</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/command/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/command/">コマンド</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/manifest/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/manifest/">マニフェスト</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/administration/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/administration/">クラスタ管理</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/istio/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/istio/">Istio</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/istio/basic/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/istio/basic/">入門</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/istio/concept/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/istio/concept/">概念整理</a>
      
        
      
    </li>
        </ul>
    </li>
    



</ul>

		
	
			
		
	    	
	  	
	
      </aside>
      

      <section class="page ">
      
	
		
    
    
    <nav id="ariane" aria-label="breadcrumb">
      <ol class="ariane">
        
  
  	
		
  
  	
		
  
  	
	<li >
      <a class="text-link" href="https://tanakakns.github.io/">
        
      </a>
    </li>
	
  
    <li class="">
      <a class="text-link" href="/gcp/">
        GCP
      </a>
    </li>
	
  	
  
    <li class="">
      <a class="text-link" href="/gcp/networking/">
        ネットワーキング
      </a>
    </li>
	
  	
  
    <li class="active">
      
        Cloud Load Balancing
      
    </li>

      </ol>
    </nav>
    
    

    
		
        
		
		
		
		
		
		
		

		
			<h1>Cloud Load Balancing</h1>
        

		
										
		

		
	

	
	
	






	<div class="content">
	    <p>Cloud Load Balancing</p>
<ol>
<li>種類</li>
<li>作成</li>
<li>ユースケース</li>
</ol>
<h2 ref="1-種類" >1. 種類</h2><a class="anchor" id="1-種類"></a>
<p>Cloud Load Balancing の負荷分散の種類には以下がある。</p>
<table>
<thead>
<tr>
<th style="text-align:left">種類</th>
<th style="text-align:left">内部/外部</th>
<th style="text-align:left">リージョン/グローバル</th>
<th style="text-align:left">プロキシ/パススルー</th>
<th style="text-align:left">Docs</th>
<th style="text-align:left">補足</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">内部 TCP/UDP</td>
<td style="text-align:left">内部</td>
<td style="text-align:left">リージョン限定</td>
<td style="text-align:left">パススルー</td>
<td style="text-align:left"><a href="https://cloud.google.com/load-balancing/docs/internal">内部 TCP/UDP 負荷分散の概要</a></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">内部 HTTP(S)</td>
<td style="text-align:left">内部</td>
<td style="text-align:left">リージョン限定</td>
<td style="text-align:left">プロキシ</td>
<td style="text-align:left"><a href="https://cloud.google.com/load-balancing/docs/l7-internal">内部 HTTP(S) 負荷分散</a></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">TCP/UDP ネットワーク</td>
<td style="text-align:left">外部</td>
<td style="text-align:left">リージョン限定</td>
<td style="text-align:left">パススルー</td>
<td style="text-align:left"><a href="https://cloud.google.com/load-balancing/docs/network">外部 TCP / UDP ネットワーク負荷分散</a></td>
<td style="text-align:left">ネットワークロードバランサ</td>
</tr>
<tr>
<td style="text-align:left">TCP プロキシ</td>
<td style="text-align:left">外部</td>
<td style="text-align:left">グローバル</td>
<td style="text-align:left">プロキシ</td>
<td style="text-align:left"><a href="https://cloud.google.com/load-balancing/docs/tcp">TCP プロキシ負荷分散</a></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">SSL プロキシ</td>
<td style="text-align:left">外部</td>
<td style="text-align:left">グローバル</td>
<td style="text-align:left">プロキシ</td>
<td style="text-align:left"><a href="https://cloud.google.com/load-balancing/docs/ssl">SSL プロキシ負荷分散</a></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">外部 HTTP(S)</td>
<td style="text-align:left">外部</td>
<td style="text-align:left">グローバル</td>
<td style="text-align:left">プロキシ</td>
<td style="text-align:left"><a href="https://cloud.google.com/load-balancing/docs/https">外部 HTTP(S) 負荷分散</a></td>
<td style="text-align:left">HTTP(S) ロードバランサ</td>
</tr>
</tbody>
</table>
<ul>
<li>内部/外部
<ul>
<li>外部：インターネットからのトラフィック</li>
<li>内部： VPC 内のトラフィック</li>
</ul>
</li>
<li>リージョン/グローバル
<ul>
<li>グローバル
<ul>
<li>バックエンドが複数リージョンに分散</li>
<li>単一のエニーキャスト IP アドレスを使用してアクセスを提供（ IPv6 もある）</li>
<li>「外部」かつ「プロキシ」の負荷分散</li>
</ul>
</li>
<li>リージョン
<ul>
<li>バックエンドが同一リージョン内</li>
<li>IPv4 のみ</li>
<li>「内部」または「パススルー」の負荷分散</li>
</ul>
</li>
</ul>
</li>
<li>プロキシ/パススルー
<ul>
<li>プロキシ（ NAT 型）
<ul>
<li>LB で一度接続終端する（送信元 IP が LB の内部 IP に変わる）ため、ファイアウォールルールは VPC ネットワーク内を許可する必要がある</li>
<li>バックエンド VM からのレスポンスは、ロードバランサを経由して、クライアントに送信される</li>
</ul>
</li>
<li>パススルー（ Direct Server Return : DSR 型）
<ul>
<li>接続終端しないのでクライアントの IP がそのまま届くため、ファイアウォールルールは <code>0.0.0.0/0</code> からのトラフィックを許可する必要がある</li>
<li>バックエンド VM からのレスポンスは、ロードバランサを経由せず、クライアントに直接送信される（DSR）</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>選択方法としては以下のようになる。</p>
<p><img src="./img/choose-lb.svg" alt="choose-lb"></p>
<p>ネットワークロードバランサ と HTTP(S) ロードバランサ の特徴は以下。</p>
<ul>
<li>ネットワークロードバランサ
<ul>
<li>バックエンド サービスベースのネットワーク ロードバランサ（非レガシー、ただしプレビュー版）
<ul>
<li>バックエンド サービスを使うと、レガシー ヘルスチェックではサポートされていない新しい機能が有効になる</li>
<li>非レガシー ヘルスチェック（TCP、SSL、HTTP、HTTPS、HTTP/2）のサポート、マネージド インスタンス グループによる自動スケーリング、コネクション ドレイン、構成可能なフェイルオーバー ポリシーなどが可能</li>
</ul>
</li>
<li>ターゲット プールベースのネットワーク ロードバランサ（レガシー）
<ul>
<li>以前は、ネットワーク ロードバランサの唯一の選択肢</li>
<li>ターゲット プールは、Google Cloud のネットワーク ロードバランサでサポートされているレガシー バックエンド</li>
<li>ターゲット プールは、ロードバランサから受信トラフィックを受け取るインスタンスのグループを定義している</li>
</ul>
</li>
</ul>
</li>
<li>HTTP(S) ロードバランサ
<ul>
<li>複数のバックエンド タイプをサポート
<ul>
<li>インスタンス グループ</li>
<li>ゾーン ネットワーク エンドポイント グループ（NEG）</li>
<li>サーバーレス NEG: 1 つ以上の App Engine、Cloud Run、Cloud Functions サービス</li>
<li>インターネット NEG: Google Cloud の外部にあるエンドポイント（カスタム送信元とも呼ばれる）</li>
<li>Cloud Storage のバケット</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>HTTP(S) ロードバランサ の構成イメージは以下。</p>
<p><img src="./img/https-load-balancer-diagram.svg" alt="https-load-balancer-diagram">
<img src="./img/https-load-balancer-diagram.png" alt="https-load-balancer-diagram"></p>
<h3 ref="11-負荷分散" >1.1. 負荷分散</h3><a class="anchor" id="11-負荷分散"></a>
<p>トラフィック分散には <a href="https://cloud.google.com/load-balancing/docs/backend-service#traffic_distribution">次</a>のような種類がある。</p>
<h2 ref="2-作成" >2. 作成</h2><a class="anchor" id="2-作成"></a>
<h3 ref="21-ネットワークロードバランサのコンセプト" >2.1. ネットワークロードバランサのコンセプト</h3><a class="anchor" id="21-ネットワークロードバランサのコンセプト"></a>
<ul>
<li>ターゲットプール</li>
<li>静的外部 IP アドレス</li>
<li>レガシー HTTP ヘルスチェック リソース</li>
<li>転送ルール</li>
</ul>
<h3 ref="22-ネットワークロードバランサの作成" >2.2. ネットワークロードバランサの作成</h3><a class="anchor" id="22-ネットワークロードバランサの作成"></a>
<p>デフォルトのリージョンとゾーンを設定する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gcloud config set compute/zone us-central1-a
$ gcloud config set compute/region us-central1
</code></pre></div><p>3 つの Web サーバを構築する。（インスタンス名のみ異なり、それぞれ metadata の startup-script で apache をインストール・起動している。）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gcloud compute instances create www1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --image-family debian-9 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --image-project debian-cloud <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --zone us-central1-a <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --tags network-lb-tag <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --metadata startup-script<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;#! /bin/bash
</span><span style="color:#e6db74">    sudo apt-get update
</span><span style="color:#e6db74">    sudo apt-get install apache2 -y
</span><span style="color:#e6db74">    sudo service apache2 restart
</span><span style="color:#e6db74">    echo &#39;&lt;!doctype html&gt;&lt;html&gt;&lt;body&gt;&lt;h1&gt;www1&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#39; | tee /var/www/html/index.html&#34;</span>

$ gcloud compute instances create www2 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --image-family debian-9 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --image-project debian-cloud <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --zone us-central1-a <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --tags network-lb-tag <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --metadata startup-script<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;#! /bin/bash
</span><span style="color:#e6db74">    sudo apt-get update
</span><span style="color:#e6db74">    sudo apt-get install apache2 -y
</span><span style="color:#e6db74">    sudo service apache2 restart
</span><span style="color:#e6db74">    echo &#39;&lt;!doctype html&gt;&lt;html&gt;&lt;body&gt;&lt;h1&gt;www2&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#39; | tee /var/www/html/index.html&#34;</span>

$ gcloud compute instances create www3 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --image-family debian-9 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --image-project debian-cloud <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --zone us-central1-a <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --tags network-lb-tag <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --metadata startup-script<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;#! /bin/bash
</span><span style="color:#e6db74">    sudo apt-get update
</span><span style="color:#e6db74">    sudo apt-get install apache2 -y
</span><span style="color:#e6db74">    sudo service apache2 restart
</span><span style="color:#e6db74">    echo &#39;&lt;!doctype html&gt;&lt;html&gt;&lt;body&gt;&lt;h1&gt;www3&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#39; | tee /var/www/html/index.html&#34;</span>
</code></pre></div><p>上記のインスタンスに適用するファイアウォール（ <code>network-lb-tag</code> がついたインスタンスに対して <code>80</code> ポートアクセスを許可）を作成する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gcloud compute firewall-rules create www-firewall-network-lb <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --target-tags network-lb-tag --allow tcp:80

Creating firewall...⠹Created <span style="color:#f92672">[</span>https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-02-aa3df922e690/global/firewalls/www-firewall-network-lb<span style="color:#f92672">]</span>.
Creating firewall...done.
NAME                     NETWORK  DIRECTION  PRIORITY  ALLOW   DENY  DISABLED
www-firewall-network-lb  default  INGRESS    <span style="color:#ae81ff">1000</span>      tcp:80        False
</code></pre></div><p>インスタンス一覧から「 EXTERNAL_IP 」を確認して、それぞれ <code>curl</code> で疎通する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gcloud compute instances list
NAME  ZONE           MACHINE_TYPE   PREEMPTIBLE  INTERNAL_IP  EXTERNAL_IP     STATUS
www1  us-central1-a  n1-standard-1               10.128.0.2   35.238.246.91   RUNNING
www2  us-central1-a  n1-standard-1               10.128.0.3   35.232.249.208  RUNNING
www3  us-central1-a  n1-standard-1               10.128.0.4   34.123.247.106  RUNNING

$ curl http://35.238.246.91
!doctype html&gt;&lt;html&gt;&lt;body&gt;&lt;h1&gt;www1&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;

$ curl http://35.232.249.208
!doctype html&gt;&lt;html&gt;&lt;body&gt;&lt;h1&gt;www2&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;

$ curl http://34.123.247.106
!doctype html&gt;&lt;html&gt;&lt;body&gt;&lt;h1&gt;www3&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre></div><p>ここまでが、負荷分散対象となる Web サーバ群の作成。</p>
<p>ターゲット プールベースのネットワーク ロードバランサを作成して上記 3 つの Web サーバを適用する。<br>
まずは、静的外部 IP アドレスを作成する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gcloud compute addresses create network-lb-ip-1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span> --region us-central1

Created <span style="color:#f92672">[</span>https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-02-aa3df922e690/regions/us-central1/addresses/network-lb-ip-1<span style="color:#f92672">]</span>.
</code></pre></div><p>次に、レガシー HTTP ヘルスチェック リソースを作成する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gcloud compute http-health-checks create basic-check

NAME         HOST  PORT  REQUEST_PATH
basic-check        <span style="color:#ae81ff">80</span>    /
</code></pre></div><p>次に、インスタンスと同じリージョンに <strong>ターゲットプール</strong> を追加する。<br>
ターゲットプールが機能するにはヘルスチェックが必要なため、先ほど作成した HTTP ヘルスチェックリソースを適用して作成する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ 
gcloud compute target-pools create www-pool <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --region us-central1 --http-health-check basic-check

Created <span style="color:#f92672">[</span>https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-02-aa3df922e690/regions/us-central1/targetPools/www-pool<span style="color:#f92672">]</span>.
NAME      REGION       SESSION_AFFINITY  BACKUP  HEALTH_CHECKS
www-pool  us-central1  NONE                      basic-check
</code></pre></div><p>ターゲットプールに 3 つの Web サーバインスタンスを追加する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gcloud compute target-pools add-instances www-pool <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --instances www1,www2,www3

Updated <span style="color:#f92672">[</span>https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-02-aa3df922e690/regions/us-central1/targetPools/www-pool<span style="color:#f92672">]</span>.
</code></pre></div><p>静的外部 IP アドレスに来たトラフィックを ターゲットプールに転送する <strong>転送ルール</strong> を作成する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gcloud compute forwarding-rules create www-rule <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --region us-central1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --ports <span style="color:#ae81ff">80</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --address network-lb-ip-1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --target-pool www-pool

Created <span style="color:#f92672">[</span>https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-02-aa3df922e690/regions/us-central1/forwardingRules/www-rule<span style="color:#f92672">]</span>.
</code></pre></div><p>これで、静的外部 IP にアクセスすれば、 3 つの Web サーバに負荷分散される。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gcloud compute addresses list
NAME             ADDRESS/RANGE  TYPE      PURPOSE  NETWORK  REGION       SUBNET  STATUS
network-lb-ip-1  35.232.6.132   EXTERNAL                    us-central1          IN_USE <span style="color:#75715e"># IP 確認</span>

$ gcloud compute forwarding-rules describe www-rule --region us-central1
IPAddress: 35.232.6.132 <span style="color:#75715e"># IP 確認</span>
IPProtocol: TCP
creationTimestamp: <span style="color:#e6db74">&#39;2021-04-07T05:45:21.364-07:00&#39;</span>
description: <span style="color:#e6db74">&#39;&#39;</span>
fingerprint: NinUJkv44qA<span style="color:#f92672">=</span>
id: <span style="color:#e6db74">&#39;3582287157978470286&#39;</span>
kind: compute#forwardingRule
labelFingerprint: 42WmSpB8rSM<span style="color:#f92672">=</span>
loadBalancingScheme: EXTERNAL
name: www-rule
networkTier: PREMIUM
portRange: 80-80
region: https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-02-aa3df922e690/regions/us-central1
selfLink: https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-02-aa3df922e690/regions/us-central1/forwardingRules/www-rule
target: https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-02-aa3df922e690/regions/us-central1/targetPools/www-pool

$ curl http://35.232.6.132

<span style="color:#75715e"># 連続で負荷分散の様子を確認</span>
$ <span style="color:#66d9ef">while</span> true; <span style="color:#66d9ef">do</span> curl -m1 35.232.6.132; <span style="color:#66d9ef">done</span>
<span style="color:#75715e"># www1/2/3 が不規則に出る</span>
</code></pre></div><h3 ref="23-https-ロードバランサのコンセプト" >2.3. HTTP(S) ロードバランサのコンセプト</h3><a class="anchor" id="23-https-ロードバランサのコンセプト"></a>
<ul>
<li>インスタンステンプレート
<ul>
<li>VM インスタンス や マネージドインスタンスグループ（ MIG ）を作成するために使用できるリソース</li>
<li>マシンタイプ、ブートディスク イメージまたはコンテナ イメージ、ラベル、その他のインスタンス プロパティを定義できる</li>
</ul>
</li>
<li><a href="https://cloud.google.com/compute/docs/instance-groups?hl=ja">マネージドインスタンスグループ（ MIG ）</a>
<ul>
<li>単一のエンティティとして管理できる VM インスタンスのグループ</li>
<li>自動スケーリング、自動修復、リージョン（マルチゾーン）デプロイメント、自動更新などの自動化 MIG サービスを活用できる</li>
<li>負荷分散のためヘルスチェック ではなく、 マネージド インスタンス グループのヘルスチェック があり、自動修復の基準となる</li>
<li><code>gcloud compute instance-groups managed create</code></li>
</ul>
</li>
<li>グローバル静的外部 IP アドレス</li>
<li>ヘルスチェエク</li>
<li>バックエンドサービス</li>
<li>URL マップ</li>
<li>ターゲット HTTP プロキシ</li>
<li>グローバル転送ルール</li>
</ul>
<h3 ref="324-https-ロードバランサの作成" >3.2.4. HTTP(S) ロードバランサの作成</h3><a class="anchor" id="324-https-ロードバランサの作成"></a>
<p>外部 HTTP(S) ロードバランサの構成要素は以下の通り。</p>
<ul>
<li>グローバル外部 IP アドレス（ <code>addresses --global</code> ）：OSI 参照モデル第4層 - ネットワーク層：IP アドレス</li>
<li>グローバル転送ルール（ <code>forwarding-rules</code> ）
<ul>
<li>IP アドレスが受信したトラフィックをプロキシへ転送する</li>
</ul>
</li>
<li>HTTP プロキシ（ <code>target-http-proxies</code> ）： OSI 参照モデル第4層 - トランスポート層：TCP</li>
<li>URL マップ（ <code>url-maps</code> ）： OSI 参照モデル第7層 - アプリケーション層：HTTP
<ul>
<li>ホストとパスに基づいてトラフィックを1つ以上の宛先に転送</li>
</ul>
</li>
<li>バックエンドサービス（ backend-services ）
<ul>
<li>ヘルスチェック（　health-checks ）</li>
</ul>
</li>
</ul>
<p>負荷分散ターゲットの基となる インスタンステーンプレート　を作成する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gcloud compute instance-templates create lb-backend-template <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --region<span style="color:#f92672">=</span>us-central1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --network<span style="color:#f92672">=</span>default <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --subnet<span style="color:#f92672">=</span>default <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --tags<span style="color:#f92672">=</span>allow-health-check <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --image-family<span style="color:#f92672">=</span>debian-9 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --image-project<span style="color:#f92672">=</span>debian-cloud <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --metadata<span style="color:#f92672">=</span>startup-script<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;#! /bin/bash
</span><span style="color:#e6db74">     apt-get update
</span><span style="color:#e6db74">     apt-get install apache2 -y
</span><span style="color:#e6db74">     a2ensite default-ssl
</span><span style="color:#e6db74">     a2enmod ssl
</span><span style="color:#e6db74">     vm_hostname=&#34;$(curl -H &#34;Metadata-Flavor:Google&#34; \
</span><span style="color:#e6db74">     http://169.254.169.254/computeMetadata/v1/instance/name)&#34;
</span><span style="color:#e6db74">     echo &#34;Page served from: $vm_hostname&#34; | \
</span><span style="color:#e6db74">     tee /var/www/html/index.html
</span><span style="color:#e6db74">     systemctl restart apache2&#39;</span>

Created <span style="color:#f92672">[</span>https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-02-aa3df922e690/global/instanceTemplates/lb-backend-template<span style="color:#f92672">]</span>.
NAME                 MACHINE_TYPE   PREEMPTIBLE  CREATION_TIMESTAMP
lb-backend-template  n1-standard-1               2021-04-07T06:01:46.131-07:00
</code></pre></div><p>作成したテンプレートに基づいて、マネージドインスタンスグループ（ MIG ）を作成する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gcloud compute instance-groups managed create lb-backend-group <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --template<span style="color:#f92672">=</span>lb-backend-template --size<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> --zone<span style="color:#f92672">=</span>us-central1-a

Created <span style="color:#f92672">[</span>https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-02-aa3df922e690/zones/us-central1-a/instanceGroupManagers/lb-backend-group<span style="color:#f92672">]</span>.
NAME              LOCATION       SCOPE  BASE_INSTANCE_NAME  SIZE  TARGET_SIZE  INSTANCE_TEMPLATE    AUTOSCALED
lb-backend-group  us-central1-a  zone   lb-backend-group    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">2</span>            lb-backend-template  no
</code></pre></div><p><code>fw-allow-health-check</code> ファイアウォール ルールを作成する。<br>
これは、Google Cloud ヘルスチェック システム（130.211.0.0/22 と 35.191.0.0/16）からのトラフィックを許可する上り（内向き）ルール。（ <a href="https://cloud.google.com/load-balancing/docs/health-check-concepts?hl=ja#ip-ranges">プローブ IP 範囲とファイアウォール ルール</a> ）<br>
ターゲットタグ <code>allow-health-check</code> を使用して VM が識別される。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gcloud compute firewall-rules create fw-allow-health-check <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --network<span style="color:#f92672">=</span>default <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --action<span style="color:#f92672">=</span>allow <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --direction<span style="color:#f92672">=</span>ingress <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --source-ranges<span style="color:#f92672">=</span>130.211.0.0/22,35.191.0.0/16 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --target-tags<span style="color:#f92672">=</span>allow-health-check <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --rules<span style="color:#f92672">=</span>tcp:80

Creating firewall...⠹Created <span style="color:#f92672">[</span>https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-02-aa3df922e690/global/firewalls/fw-allow-health-check<span style="color:#f92672">]</span>.
Creating firewall...done.
NAME                   NETWORK  DIRECTION  PRIORITY  ALLOW   DENY  DISABLED
fw-allow-health-check  default  INGRESS    <span style="color:#ae81ff">1000</span>      tcp:80        False
</code></pre></div><p>ロードバランサにユーザーが接続する際に使用するグローバル静的外部 IP アドレスを作成する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gcloud compute addresses create lb-ipv4-1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --ip-version<span style="color:#f92672">=</span>IPV4 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --global

Created <span style="color:#f92672">[</span>https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-02-aa3df922e690/global/addresses/lb-ipv4-1<span style="color:#f92672">]</span>.    

<span style="color:#75715e"># 作成した IP のアドレスを確認</span>
$ gcloud compute addresses describe lb-ipv4-1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get(address)&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --global
34.120.128.63
</code></pre></div><p>ロードバランサのヘルスチェックを作成。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gcloud compute health-checks create http http-basic-check --port <span style="color:#ae81ff">80</span>

Created <span style="color:#f92672">[</span>https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-02-aa3df922e690/global/healthChecks/http-basic-check<span style="color:#f92672">]</span>.
NAME              PROTOCOL
http-basic-check  HTTP
</code></pre></div><p>ヘルスチェックを適用した <strong>バックエンドサービス</strong> を作成。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gcloud compute backend-services create web-backend-service <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --protocol<span style="color:#f92672">=</span>HTTP <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --port-name<span style="color:#f92672">=</span>http <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --health-checks<span style="color:#f92672">=</span>http-basic-check <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --global

Created <span style="color:#f92672">[</span>https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-02-aa3df922e690/global/backendServices/web-backend-service<span style="color:#f92672">]</span>.
NAME                 BACKENDS  PROTOCOL
web-backend-service            HTTP
</code></pre></div><p>MIG をバックエンドとしてバックエンドサービスに追加。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gcloud compute backend-services add-backend web-backend-service <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --instance-group<span style="color:#f92672">=</span>lb-backend-group <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --instance-group-zone<span style="color:#f92672">=</span>us-central1-a <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --global

Updated <span style="color:#f92672">[</span>https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-02-aa3df922e690/global/backendServices/web-backend-service<span style="color:#f92672">]</span>.
</code></pre></div><p>デフォルトの バックエンドサービス に受信リクエストをルーティングする URL マップを作成。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gcloud compute url-maps create web-map-http <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --default-service web-backend-service

Created <span style="color:#f92672">[</span>https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-02-aa3df922e690/global/urlMaps/web-map-http<span style="color:#f92672">]</span>.
NAME          DEFAULT_SERVICE
web-map-http  backendServices/web-backend-service
</code></pre></div><p>作成した URL マップにリクエストをルーティングするターゲット HTTP プロキシを作成。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gcloud compute target-http-proxies create http-lb-proxy <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --url-map web-map-http

Created <span style="color:#f92672">[</span>https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-02-aa3df922e690/global/targetHttpProxies/http-lb-proxy<span style="color:#f92672">]</span>.
NAME           URL_MAP
http-lb-proxy  web-map-http
</code></pre></div><p>受信リクエストをプロキシにルーティングするグローバル転送ルールを作成。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gcloud compute forwarding-rules create http-content-rule <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --address<span style="color:#f92672">=</span>lb-ipv4-1<span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --global <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --target-http-proxy<span style="color:#f92672">=</span>http-lb-proxy <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --ports<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span>

Created <span style="color:#f92672">[</span>https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-02-aa3df922e690/global/forwardingRules/http-content-rule<span style="color:#f92672">]</span>.
</code></pre></div><p>Cloud Console のナビゲーション メニューで、[ネットワーク サービス] &gt; [Cloud Load Balancing] に移動して、作成したロードバランサ（web-map-http）をクリック。<br>
[バックエンド] セクションでバックエンドの名前をクリックして、VM が正常であることを確認。<br>
ブラウザで「http://34.120.128.63」にアクセスして動確（リロードしまくり）。「lb-backend-group-xxxx」の「xxxx」が変わることで、 MIG 内の別インスタンスに負荷分散されていることがわかる。</p>
<h2 ref="3-ユースケース" >3. ユースケース</h2><a class="anchor" id="3-ユースケース"></a>
<h3 ref="31-cloud-armor" >3.1. Cloud Armor</h3><a class="anchor" id="31-cloud-armor"></a>
<p>外部 HTTP ロードバランサを作成し、　Cloud Armor を使用して DoS 対策を行う。<br>
まず、HTTP とヘルスチェックのファイアウォール ルールを構成する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># HTTP ファイアウォールルール default-allow-http を作成</span>
$ gcloud compute firewall-rules create default-allow-http <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --action<span style="color:#f92672">=</span>allow <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --direction<span style="color:#f92672">=</span>ingress <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --source-ranges<span style="color:#f92672">=</span>0.0.0.0/0 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --target-tags<span style="color:#f92672">=</span>http-server <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --rules<span style="color:#f92672">=</span>tcp:80

<span style="color:#75715e"># ヘルスチェックのファイアウォールルール default-allow-health-check を作成</span>
$ gcloud compute firewall-rules create default-allow-health-check <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --action<span style="color:#f92672">=</span>allow <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --direction<span style="color:#f92672">=</span>ingress <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --source-ranges<span style="color:#f92672">=</span>130.211.0.0/22,35.191.0.0/16 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --target-tags<span style="color:#f92672">=</span>http-server <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --rules<span style="color:#f92672">=</span>tcp
</code></pre></div><p>インスタンス テンプレートを構成し、インスタンス グループを作成する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#####</span>
<span style="color:#75715e"># us-east1</span>
<span style="color:#75715e">#####</span>
<span style="color:#75715e"># インスタンス テンプレート us-east1-template を作成</span>
$ gcloud compute instance-templates create us-east1-template <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --region<span style="color:#f92672">=</span>us-east1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --network<span style="color:#f92672">=</span>default <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --subnet<span style="color:#f92672">=</span>default <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --tags<span style="color:#f92672">=</span>http-server <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --scopes default <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --metadata startup-script-url<span style="color:#f92672">=</span>gs://cloud-training/gcpnet/httplb/startup.sh

<span style="color:#75715e"># インスタンス テンプレート us-east1-template から MIG us-east1-mig を作成</span>
$ gcloud compute instance-groups managed create us-east1-mig <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --region<span style="color:#f92672">=</span>us-east1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --template<span style="color:#f92672">=</span>us-east1-template <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>

<span style="color:#75715e"># MIG us-east1-mig に CPU 使用率に基づくスケーリングを設定</span>
$ gcloud compute instance-groups managed set-autoscaling us-east1-mig <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --region<span style="color:#f92672">=</span>us-east1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --target-cpu-utilization 0.80 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --min-num-replicas <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --max-num-replicas <span style="color:#ae81ff">5</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --cool-down-period <span style="color:#ae81ff">45</span>

<span style="color:#75715e">#####</span>
<span style="color:#75715e"># europe-west1</span>
<span style="color:#75715e">#####</span>

<span style="color:#75715e"># インスタンス テンプレート europe-west1-template を作成</span>
$ gcloud compute instance-templates create europe-west1-template <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --region<span style="color:#f92672">=</span>europe-west1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --network<span style="color:#f92672">=</span>default <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --subnet<span style="color:#f92672">=</span>default <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --tags<span style="color:#f92672">=</span>http-server <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --scopes default <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --metadata startup-script-url<span style="color:#f92672">=</span>gs://cloud-training/gcpnet/httplb/startup.sh

<span style="color:#75715e"># インスタンス テンプレート europe-west1-template から MIG europe-west1-mig を作成</span>
$ gcloud compute instance-groups managed create europe-west1-mig <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --region<span style="color:#f92672">=</span>europe-west1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --template<span style="color:#f92672">=</span>europe-west1-template <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>

<span style="color:#75715e"># MIG europe-west1-mig に CPU 使用率に基づくスケーリングを設定</span>
$ gcloud compute instance-groups managed set-autoscaling europe-west1-mig <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --region<span style="color:#f92672">=</span>europe-west1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --target-cpu-utilization 0.80 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --min-num-replicas <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --max-num-replicas <span style="color:#ae81ff">5</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --cool-down-period <span style="color:#ae81ff">45</span>
</code></pre></div><p>HTTP ロードバランサを構成する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ヘルスチェックを作成</span>
$ gcloud compute health-checks create http http-health-check <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --port <span style="color:#ae81ff">80</span>

<span style="color:#75715e"># ヘルスチェックを構成したバックエンドサービスを作成（ロギングを有効化し、サンプリングレート1.0）</span>
$ gcloud compute backend-services create http-backend <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --protocol<span style="color:#f92672">=</span>HTTP <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --port-name<span style="color:#f92672">=</span>http <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --health-checks<span style="color:#f92672">=</span>http-health-check <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --enable-logging <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --logging-sample-rate<span style="color:#f92672">=</span>1.0 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --global

<span style="color:#75715e"># MIG をバックエンドに追加</span>
$ gcloud compute backend-services add-backend http-backend <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --instance-group<span style="color:#f92672">=</span>us-east1-mig <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --instance-group-region<span style="color:#f92672">=</span>us-east1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --balancing-mode<span style="color:#f92672">=</span>RATE <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --max-rate<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --capacity-scaler<span style="color:#f92672">=</span>1.0 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --global
$ gcloud compute backend-services add-backend http-backend <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --instance-group<span style="color:#f92672">=</span>europe-west1-mig <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --instance-group-region<span style="color:#f92672">=</span>europe-west1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --balancing-mode<span style="color:#f92672">=</span>UTILIZATION <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --max-utilization<span style="color:#f92672">=</span>0.80 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --capacity-scaler<span style="color:#f92672">=</span>1.0 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --global

<span style="color:#75715e"># フロントエンドを構成</span>
<span style="color:#75715e"># IP アドレスを作成</span>
$ gcloud compute addresses create http-lb-ipv4 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --ip-version<span style="color:#f92672">=</span>IPV4 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --global
$ gcloud compute addresses create http-lb-ipv6 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --ip-version<span style="color:#f92672">=</span>IPV6 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --global

<span style="color:#75715e"># URL マップを作成（ URL マップが ロードバランサの名前に該当する、ここでは http-lb ）</span>
$ gcloud compute url-maps create http-lb <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --default-service http-backend <span style="color:#75715e"># バックエンドサービスは http-backend</span>

<span style="color:#75715e"># URL マップにリクエストをルーティングするターゲット HTTP プロキシを作成</span>
$ gcloud compute target-http-proxies create http-lb-proxy <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --url-map http-lb

<span style="color:#75715e"># 受信リクエストをプロキシにルーティングするグローバル転送ルールを作成</span>
$ gcloud compute forwarding-rules create http-ipv4-rule <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --address<span style="color:#f92672">=</span>http-lb-ipv4 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --global <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --target-http-proxy<span style="color:#f92672">=</span>http-lb-proxy <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --ports<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span>
$ gcloud compute forwarding-rules create http-ipv6-rule <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --address<span style="color:#f92672">=</span>http-lb-ipv6 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --global <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --target-http-proxy<span style="color:#f92672">=</span>http-lb-proxy <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --ports<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span>
</code></pre></div><p>HTTP ロードバランサをテストする。</p>
<ul>
<li>ブラウザで <code>http://[LB_IP_v4]</code> にアクセス</li>
</ul>
<p>HTTP ロードバランサのストレステストを実施する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ストレステスト用の VM インスタンス を作成</span>
$ gcloud compute instances create siege-vm --zone<span style="color:#f92672">=</span>us-west1-c
Created <span style="color:#f92672">[</span>https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-04-c77142eb9067/zones/us-west1-c/instances/siege-vm<span style="color:#f92672">]</span>.
NAME      ZONE        MACHINE_TYPE   PREEMPTIBLE  INTERNAL_IP  EXTERNAL_IP    STATUS
siege-vm  us-west1-c  n1-standard-1               10.138.0.2   34.105.25.106  RUNNING

<span style="color:#75715e"># siege-vm に SSH して設定</span>
$ gcloud compute ssh siege-vm --zone<span style="color:#f92672">=</span>us-west1-c
$ sudo apt-get -y install siege
$ export LB_IP<span style="color:#f92672">=</span>34.98.93.118 <span style="color:#75715e"># LB の IPV4</span>
$ siege -c <span style="color:#ae81ff">250</span> http://$LB_IP
$ exit
</code></pre></div><p>siege-vm をブラックリストに登録する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># siege-vm の外部 IP を確認</span>
$ gcloud compute instances describe siege-vm
</code></pre></div><p>Google Cloud Armor を構成し、 VM インスタンス siege-vm からのリクエストを遮断する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Google Cloud Armor セキュリティ ポリシーを作成</span>
$ gcloud compute security-policies create denylist-siege

<span style="color:#75715e"># セキュリティ ポリシーに対するデフォルトのルールを更新し、トラフィックを許可</span>
$ gcloud compute security-policies rules create <span style="color:#ae81ff">2147483647</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --action<span style="color:#f92672">=</span>allow <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --src-ip-ranges<span style="color:#f92672">=</span><span style="color:#ae81ff">\*</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --security-policy<span style="color:#f92672">=</span>denylist-siege

<span style="color:#75715e"># セキュリティ ポリシーにルールを追加し、siege-vm からのリクエストを拒否</span>
$ gcloud compute security-policies rules create <span style="color:#ae81ff">1000</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --action<span style="color:#f92672">=</span>deny<span style="color:#ae81ff">\(</span>403<span style="color:#ae81ff">\)</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --src-ip-ranges<span style="color:#f92672">=</span>34.105.25.106 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --security-policy<span style="color:#f92672">=</span>denylist-siege

<span style="color:#75715e"># セキュリティ ポリシーをバックエンド サービスに接続</span>
$ gcloud compute backend-services update http-backend <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --security-policy<span style="color:#f92672">=</span>denylist-siege
</code></pre></div><p>VM インスタンス siege-vm に SSH して接続が拒否されるのを確認する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gcloud compute ssh siege-vm --zone<span style="color:#f92672">=</span>us-west1-c
$ export LB_IP<span style="color:#f92672">=</span>34.98.93.118 <span style="color:#75715e"># LB の IPV4</span>
$ curl http://$LB_IP
&lt;!doctype html&gt;&lt;meta charset<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>&gt;&lt;meta name<span style="color:#f92672">=</span>viewport content<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;width=device-width, initial-scale=1&#34;</span>&gt;&lt;title&gt;403&lt;/title&gt;403 Forbidden
</code></pre></div><h3 ref="32-内部ロードバランサの作成" >3.2. 内部ロードバランサの作成</h3><a class="anchor" id="32-内部ロードバランサの作成"></a>
<p>TCP/UDP トラフィックの内部負荷分散機能を作成する。<br>
内部負荷分散により、内部仮想（VM）マシンのインスタンスのみにアクセス可能なプライベート負荷分散 IP アドレスの背後でサービスを実行、スケーリングする。<br>
まず、HTTP とヘルスチェックのファイアウォール ルールを構成する。<br>
なお、<code>us-central1</code> リージョン内に <code>subnet-a</code> と <code>subnet-b</code> を備えたネットワーク <code>my-internal-app</code> があらかじめ構成されている。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># HTTP ファイアウォールルール app-allow-http を作成</span>
$ gcloud compute firewall-rules create app-allow-http <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --network<span style="color:#f92672">=</span>my-internal-app <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --action<span style="color:#f92672">=</span>allow <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --direction<span style="color:#f92672">=</span>ingress <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --source-ranges<span style="color:#f92672">=</span>0.0.0.0/0 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --target-tags<span style="color:#f92672">=</span>lb-backend <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --rules<span style="color:#f92672">=</span>tcp:80

<span style="color:#75715e"># ヘルスチェックのファイアウォールルール app-allow-health-check を作成</span>
$ gcloud compute firewall-rules create app-allow-health-check <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --action<span style="color:#f92672">=</span>allow <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --direction<span style="color:#f92672">=</span>ingress <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --source-ranges<span style="color:#f92672">=</span>130.211.0.0/22,35.191.0.0/16 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --target-tags<span style="color:#f92672">=</span>lb-backend <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --rules<span style="color:#f92672">=</span>tcp
</code></pre></div><p>上記のファイアウォールはネットワークタグによって確実に適用される。<br>
インスタンス テンプレートを構成し、インスタンス グループを作成する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#####</span>
<span style="color:#75715e"># subnet-a</span>
<span style="color:#75715e">#####</span>
<span style="color:#75715e"># インスタンス テンプレート instance-template-1 を作成</span>
$ gcloud compute instance-templates create instance-template-1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --region<span style="color:#f92672">=</span>us-central1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --network<span style="color:#f92672">=</span>my-internal-app <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --subnet<span style="color:#f92672">=</span>subnet-a <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --tags<span style="color:#f92672">=</span>lb-backend <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --scopes<span style="color:#f92672">=</span>default <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --metadata<span style="color:#f92672">=</span>startup-script-url<span style="color:#f92672">=</span>gs://cloud-training/gcpnet/ilb/startup.sh

<span style="color:#75715e"># インスタンス テンプレート instance-template-1 から MIG instance-group-1 を作成</span>
$ gcloud compute instance-groups managed create instance-group-1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --zone<span style="color:#f92672">=</span>us-central1-a <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --template<span style="color:#f92672">=</span>instance-template-1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>

<span style="color:#75715e"># MIG instance-group-1 に CPU 使用率に基づくスケーリングを設定</span>
$ gcloud compute instance-groups managed set-autoscaling instance-group-1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --zone<span style="color:#f92672">=</span>us-central1-a <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --target-cpu-utilization 0.80 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --min-num-replicas <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --max-num-replicas <span style="color:#ae81ff">5</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --cool-down-period <span style="color:#ae81ff">45</span>

<span style="color:#75715e">#####</span>
<span style="color:#75715e"># subnet-b</span>
<span style="color:#75715e">#####</span>

<span style="color:#75715e"># インスタンス テンプレート instance-template-2 を作成</span>
$ gcloud compute instance-templates create instance-template-2 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --region<span style="color:#f92672">=</span>us-central1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --network<span style="color:#f92672">=</span>my-internal-app <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --subnet<span style="color:#f92672">=</span>subnet-b <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --tags<span style="color:#f92672">=</span>lb-backend <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --scopes<span style="color:#f92672">=</span>default <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --metadata<span style="color:#f92672">=</span>startup-script-url<span style="color:#f92672">=</span>gs://cloud-training/gcpnet/ilb/startup.sh

<span style="color:#75715e"># インスタンス テンプレート instance-template-2 から MIG instance-group-2 を作成</span>
$ gcloud compute instance-groups managed create instance-group-2 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --zone<span style="color:#f92672">=</span>us-central1-b <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --template<span style="color:#f92672">=</span>instance-template-2 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>

<span style="color:#75715e"># MIG instance-group-2 に CPU 使用率に基づくスケーリングを設定</span>
$ gcloud compute instance-groups managed set-autoscaling instance-group-2 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --zone<span style="color:#f92672">=</span>us-central1-b <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --target-cpu-utilization 0.80 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --min-num-replicas <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --max-num-replicas <span style="color:#ae81ff">5</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --cool-down-period <span style="color:#ae81ff">45</span>
</code></pre></div><p>疎通用の VM インスタンス <code>utility-vm</code> を作成する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 疎通用 VM インスタンス作成</span>
$ gcloud compute instances create utility-vm <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --zone<span style="color:#f92672">=</span>us-central1-f <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --machine-type<span style="color:#f92672">=</span>f1-micro <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --network-interface<span style="color:#f92672">=</span>network<span style="color:#f92672">=</span>my-internal-app,subnet<span style="color:#f92672">=</span>subnet-a,private-network-ip<span style="color:#f92672">=</span>10.10.20.50,no-address

<span style="color:#75715e"># SSH</span>
$ gcloud compute ssh utility-vm --zone<span style="color:#f92672">=</span>us-central1-f
<span style="color:#75715e"># instance-group-1-xxxx のスタートページを確認</span>
$ curl 10.10.20.2
&lt;h1&gt;Internal Load Balancing Lab&lt;/h1&gt;&lt;h2&gt;Client IP&lt;/h2&gt;Your IP address : 10.10.20.50&lt;h2&gt;Hostname&lt;/h2&gt;Server Hostname: instance-group-1-zx46&lt;h2&gt;Server Location&lt;/h2&gt;Region and Zone: us-central1-a
<span style="color:#75715e"># instance-group-2-xxxx のスタートページを確認</span>
$ curl 10.10.30.2
&lt;h1&gt;Internal Load Balancing Lab&lt;/h1&gt;&lt;h2&gt;Client IP&lt;/h2&gt;Your IP address : 10.10.20.50&lt;h2&gt;Hostname&lt;/h2&gt;Server Hostname: instance-group-2-095r&lt;h2&gt;Server Location&lt;/h2&gt;Region and Zone: us-central1-b
$ exit
</code></pre></div><p>疎通する。<br>
リージョン バックエンド サービスを構成する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ヘルスチェックを作成</span>
$ gcloud compute health-checks create http my-ilb-health-check <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --region<span style="color:#f92672">=</span>us-central1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --port <span style="color:#ae81ff">80</span>

<span style="color:#75715e"># ヘルスチェックを構成したバックエンドサービスを作成</span>
$ gcloud compute backend-services create http-backend <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --load-balancing-scheme<span style="color:#f92672">=</span>internal <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --protocol<span style="color:#f92672">=</span>tcp <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --region<span style="color:#f92672">=</span>us-central1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --health-checks<span style="color:#f92672">=</span>my-ilb-health-check <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --health-checks-region<span style="color:#f92672">=</span>us-central1

<span style="color:#75715e"># MIG をバックエンドに追加</span>
$ gcloud compute backend-services add-backend http-backend <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --region<span style="color:#f92672">=</span>us-central1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --instance-group<span style="color:#f92672">=</span>instance-group-1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --instance-group-zone<span style="color:#f92672">=</span>us-central1-a
$ gcloud compute backend-services add-backend http-backend <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --region<span style="color:#f92672">=</span>us-central1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --instance-group<span style="color:#f92672">=</span>instance-group-2 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --instance-group-zone<span style="color:#f92672">=</span>us-central1-b

<span style="color:#75715e"># フロントエンドを構成（内部 LB の場合、 URL マップ・プロキシは不要で、 IP アドレス・転送ルール のみでよい）</span>
<span style="color:#75715e"># IP アドレスを作成</span>
$ gcloud compute addresses create my-ilb-ip <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --region<span style="color:#f92672">=</span>us-central1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --subnet<span style="color:#f92672">=</span>subnet-b <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --addresses<span style="color:#f92672">=</span>10.10.30.5

<span style="color:#75715e"># 転送ルール（内部の場合、これが LB 名？）</span>
$ gcloud compute forwarding-rules create my-ilb <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --region<span style="color:#f92672">=</span>us-central1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --load-balancing-scheme<span style="color:#f92672">=</span>internal <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --network<span style="color:#f92672">=</span>my-internal-app <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --subnet<span style="color:#f92672">=</span>subnet-b <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --address<span style="color:#f92672">=</span>my-ilb-ip <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --ip-protocol<span style="color:#f92672">=</span>TCP <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --ports<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --backend-service<span style="color:#f92672">=</span>http-backend <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --backend-service-region<span style="color:#f92672">=</span>us-central1








<span style="color:#75715e"># IP アドレスを作成：いらん</span>
$ gcloud compute addresses create http-lb-ipv4 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --ip-version<span style="color:#f92672">=</span>IPV4

<span style="color:#75715e"># URL マップを作成（ URL マップが ロードバランサの名前に該当する、ここでは http-lb ）：いらん</span>
$ gcloud compute url-maps create http-lb <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --default-service http-backend <span style="color:#75715e"># バックエンドサービスは http-backend</span>

<span style="color:#75715e"># URL マップにリクエストをルーティングするターゲット HTTP プロキシを作成：いらん</span>
$ gcloud compute target-http-proxies create http-lb-proxy <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --url-map http-lb

<span style="color:#75715e"># 受信リクエストをプロキシにルーティングするグローバル転送ルールを作成：内部の場合、これが LB 名？</span>
$ gcloud compute forwarding-rules create http-ipv4-rule <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --address<span style="color:#f92672">=</span>http-lb-ipv4 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --global <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --target-http-proxy<span style="color:#f92672">=</span>http-lb-proxy <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --ports<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span>
</code></pre></div><p>疎通用 VM インスタンスに SSH して何回か curl を叩いて、 instance-group-1も2も反応するかテストする。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># SSH</span>
$ gcloud compute ssh utility-vm --zone<span style="color:#f92672">=</span>us-central1-f

<span style="color:#75715e"># テスト</span>
$ curl 10.10.30.5
</code></pre></div>
		</div>






	
	

      </section>

      
      
    </article>
    
    
    <footer>
      

		
	
			
		
	    	
	  	
	
    </footer>
    



  </body>
</html>
