

<!DOCTYPE html>
<html>
  <head>
    <title>
	セキュリティ :: テックまとめ
</title>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="revised" content="2022-04-10T10:02:30 JST">
<meta name="description" content="備忘録用メモサイト">



<title>セキュリティ :: テックまとめ</title>

<link rel="shortcut icon" href='/images/favicon.png' type="image/x-icon" />

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css">

<script src='https://code.jquery.com/jquery-3.5.1.min.js'></script>

<link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel="stylesheet">



<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/layout.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/css/style.main.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/css/style.menu.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/notice.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/tabs.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/panel.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/columns.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/children.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/attachments.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/alert.css'>
<link rel="stylesheet" type="text/css" href='/css/docport.css'>

<script src='/js/docport.js'></script>
<script type="text/javascript">
      var baseurl = "https:\/\/tanakakns.github.io\/";
</script>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-42388425-3', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
  </head>

  <body data-url="/kubernetes/security/"

  class="hidetoc hidenextpage ">

<style type="text/css">
  #debug{
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    line-height: 3.5rem;
    margin-bottom: .35rem;
    padding: 0 2rem;
    position: fixed;
    left: 0;      right: 0;     top: 0;
   
    top:0px;
    
    min-height: 150px;

    background-color: white;
    border: 3px solid red;
    z-index: 10000 ;
    word-wrap: all;
    overflow: auto;
  }
</style>
 


    
    
    <header style="">
        <div>
    
    <div class="burger ">
        <a href="javascript:void(0);" style="font-size:15px;" onclick="$('article > aside').toggleClass('responsive')">&#9776;</a>
    </div>
    

    <div>

		
	
			
		
	    	<a class='baselink' href='https://tanakakns.github.io/'>テックまとめ</a>
	  	
	</div>

</div>
    </header>
    

    <article>
      
      <aside class="">
        

		
	
			
		
	    	
	  	
	<div id="close_menu">
  <a href="javascript:void(0);" style="font-size:15px;" onclick="$('article > aside').toggleClass('responsive')">
      <i class="fa fa-lg fa-times"></i>
  </a>
</div>

<ul class="menu">

    <li data-nav-id="https://tanakakns.github.io/design/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/design/">設計</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/design/principle-practice/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/design/principle-practice/">原理原則・ベストプラクティス</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/design/api-design/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/design/api-design/">API設計</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/design/microservices/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/design/microservices/">マイクロサービス</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/design/clean-architecture/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/design/clean-architecture/">クリーンアーキテクチャ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/design/architecture/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/design/architecture/">アーキテクチャ</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/java/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/java/">Java</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/java/springframework/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/java/springframework/">Spring Framework</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/database/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/database/">Database</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/database/rdb/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/database/rdb/">RDB</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/aws/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/aws/">AWS</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/aws/well-architected-framework/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/well-architected-framework/">AWS Well-Architected フレームワーク</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/computing/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/computing/">コンピューティング</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/aws/computing/ec2/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/computing/ec2/">EC2</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/container/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/container/">コンテナ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/storage/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/storage/">ストレージ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/database/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/database/">データベース</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/aws/database/aurora/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/database/aurora/">Aurora</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/migration/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/migration/">移行と転送</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/networking/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/networking/">ネットワーキングとコンテンツ配信</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/aws/networking/vpc/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/networking/vpc/">VPC</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/dev-tools/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/dev-tools/">開発者用ツール</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/aws/security/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/security/">セキュリティ</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/aws/security/iam/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/aws/security/iam/">IAM</a>
      
        
      
    </li>
        </ul>
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/gcp/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/gcp/">GCP</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/gcp-aws/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/gcp-aws/">GCP と AWS の比較</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/monitoring/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/monitoring/">監視</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/tools/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/tools/">ツール</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/tools/management-tools/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/tools/management-tools/">管理ツール</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/tools/dev-tools/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/tools/dev-tools/">開発ツール</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/access-control-and-security/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/access-control-and-security/">アクセス制御とセキュリティ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/">コンピューティングとホスティング</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/compute-engine/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/compute-engine/">Compute Engine</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/kubernetes-engine/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/kubernetes-engine/">Google Kubernetes Engine</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/app-engine/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/app-engine/">App Engine</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/cloud-functions/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/cloud-functions/">Cloud Functions</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/storage/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/storage/">ストレージ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/">データベース</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/bigquery/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/bigquery/">BigQuery</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/sql/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/sql/">Cloud SQL</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/memorystore/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/memorystore/">Memorystore</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/spanner/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/spanner/">Cloud Spanner</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/">ネットワーキング</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/vpc/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/vpc/">VPC</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/load-balancing/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/load-balancing/">Cloud Load Balancing</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/iap/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/iap/">Identity-Aware Proxy</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/interconnect/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/interconnect/">Cloud Interconnect</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/big-data/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/big-data/">ビッグデータ</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/big-data/pubsub/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/big-data/pubsub/">Cloud Pub/Sub</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/big-data/dataflow/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/big-data/dataflow/">Dataflow</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/machine-learning/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/machine-learning/">機械学習</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/terraform/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/terraform/">Terraform</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/terraform/basic/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/terraform/basic/">入門</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/terraform/google-cloud/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/terraform/google-cloud/">Google Cloud</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/docker/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/docker/">Docker</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/docker/basic/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/docker/basic/">入門</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/kubernetes/" class="dd-item parent haschildren
        item_level_$level
        ">

      
      
      
      
          <i class="fas fa-chevron-down ddexp"></i>
        
      
          <a href="/kubernetes/">Kubernetes</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/concept/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/concept/">概念整理</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/architecture/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/architecture/">アーキテクチャ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/kubectl-plugin/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/kubectl-plugin/">kubectl plugin と Krew</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/command/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/command/">コマンド</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/manifest/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/manifest/">マニフェスト</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/application-management/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/application-management/">アプリケーション管理</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/cluster-management/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/cluster-management/">クラスタ管理</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/security/" class="dd-item parent active
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/security/">セキュリティ</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/istio/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/istio/">Istio</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/istio/basic/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/istio/basic/">入門</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/istio/concept/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/istio/concept/">概念整理</a>
      
        
      
    </li>
        </ul>
    </li>
    



</ul>

		
	
			
		
	    	
	  	
	
      </aside>
      

      <section class="page ">
      
	
		
    
    
    <nav id="ariane" aria-label="breadcrumb">
      <ol class="ariane">
        
  
  	
		
  
  	
	<li >
      <a class="text-link" href="https://tanakakns.github.io/">
        
      </a>
    </li>
	
  
    <li class="">
      <a class="text-link" href="/kubernetes/">
        Kubernetes
      </a>
    </li>
	
  	
  
    <li class="active">
      
        セキュリティ
      
    </li>

      </ol>
    </nav>
    
    

    
		
        
		
		
		
		
		
		
		

		
			<h1>セキュリティ</h1>
        

		
										
		

		
	

	
	
	






	<div class="content">
	    <ol>
<li>Authentication / 認証</li>
</ol>
<h2 ref="4-セキュリティ" >4. セキュリティ</h2><a class="anchor" id="4-セキュリティ"></a>
<p><code>kube-apiserver</code> に <code>kubectl</code> でアクセスする際は以下のセキュリティ事項がある。</p>
<ul>
<li>誰がアクセスするのか -&gt; Authentication / 認証
<ul>
<li>以下のような方法がある
<ul>
<li>Username / Password</li>
<li>Username / Token</li>
<li>Certificates</li>
<li>ID Providor や LDAP</li>
<li>Service Accounts</li>
</ul>
</li>
</ul>
</li>
<li>何を実行するのか  -&gt; Authorization / 認可・承認
<ul>
<li>以下のような方法がある
<ul>
<li>RBAC Authorization ( Role Based Access Control)</li>
<li>ABAC Authorization ( Attribute Based Access Control)</li>
<li>Node Authorization</li>
<li>Webhook Mode</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 ref="41-authentication--認証" >4.1. Authentication / 認証</h3><a class="anchor" id="41-authentication--認証"></a>
<p><strong>Account</strong> には以下の 2 種類がある。</p>
<ul>
<li><strong>User</strong>
<ul>
<li>管理者、開発者</li>
<li>Kubernetes は User を管理しない</li>
</ul>
</li>
<li><strong>Service Accounts</strong>
<ul>
<li>Bots など</li>
<li>Kubernetes は Service Accounts を管理する
<ul>
<li><code>kubectl create serviceaccount sa1</code></li>
<li><code>kubectl get serviceacceount</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 ref="411-パスワードトークン認証" >4.1.1. パスワード・トークン認証</h4><a class="anchor" id="411-パスワードトークン認証"></a>
<p><code>kube-apiserver</code> が 静的ファイルを用いてユーザ認証する方法は以下の通り。<br>
まず、以下のファイルを準備する。</p>
<pre tabindex="0"><code class="language-csv:user-details.csv" data-lang="csv:user-details.csv"># Password,UserName,UserID
password123,user1,u0001
password123,user2,u0002
password123,user3,u0003
</code></pre><p>そして、上記のファイルを <code>kube-apiserver.service</code> の起動オプション <code>--basic-auth-file</code> に指定する。<br>
また、以下のように 4 項目目にグループを指定することもできるし、パスワードではなくトークンでもいい。（トークンファイルの場合は <code>--token-auth-file</code> オプションで指定 ）</p>
<pre tabindex="0"><code class="language-csv:user-token-details.csv" data-lang="csv:user-token-details.csv"># Password,UserName,UserID,GroupID
token123,user1,u0001,group1
token123,user2,u0002,group1
token123,user3,u0003,group2
</code></pre><p>しかし、この方法は推奨されておらず、 <strong>Deprecated</strong> である。</p>
<h4 ref="412-証明書認証" >4.1.2. 証明書認証</h4><a class="anchor" id="412-証明書認証"></a>
<p>まずは、 SSL/TSL 証明書まわりの復習。</p>
<ul>
<li>SSL/TLS Certificates まわりの登場人物
<ul>
<li>秘密鍵： <code>openssl genrsa 1024 -out server.key</code> （ <code>.key</code> や <code>-key.pem</code> の形式が多い）</li>
<li>公開鍵： <code>openssl rsa -in server.key -pubout &gt; server.pem</code> （ <code>.pem</code> や <code>.crt</code> の形式が多い）</li>
<li>証明書署名要求(CSR / Certificate Signing Request)： <code>openssl req -new -key server.key &gt; server.csr</code> （ <code>.csr</code> の形式が多い）</li>
<li>証明書： <code>openssl x509 -req -days 3650 -signkey server.key &lt; server.csr &gt; server.crt</code> （ <code>.crt</code> や <code>.pem</code> の形式が多い）</li>
</ul>
</li>
<li>証明書の種類
<ul>
<li>サーバ証明書
<ul>
<li>サーバ側が提示する証明書、Webサイトの身分証</li>
<li>サーバ証明書は 認証局/CA が管理する</li>
<li>暗号化に必要な公開鍵が含まれる</li>
</ul>
</li>
<li>クライアント証明書
<ul>
<li>クライアント側が提示する証明書、クライアントの身分証</li>
</ul>
</li>
<li>ルート証明書
<ul>
<li>認証局/CA 自体の正当性をチェックする</li>
<li>サーバ証明書の検証のために使用する証明書</li>
</ul>
</li>
<li>自己証明証明書（オレオレ証明書）
<ul>
<li>正式な認証局ベンダーでなく、個人で構築した認証局などで発行したルート証明書</li>
</ul>
</li>
</ul>
</li>
<li>サーバ証明書
<ul>
<li>「SSL/TSL による通信の暗号化」と「サーバ証明書による本人確認」を実施できる</li>
<li>鍵の送受信は以下のステップ
<ul>
<li>ユーザは「▲公開鍵」「▼秘密鍵」「■サーバ証明書」を作成して、「▲公開鍵」「■サーバ証明書」をサーバに送付</li>
<li>サーバは「■サーバ証明書」を検証し、「●共通鍵」を生成して、「▲公開鍵」により暗号化した「●共通鍵」をユーザに送付</li>
<li>ユーザは受け取った「●共通鍵」を「▼秘密鍵」で復号化</li>
<li>以降、データの送受信を行う際は「●共通鍵」で暗号化・復号化を行う</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>上記の証明書は以下のように利用される。</p>
<ul>
<li><code>kube-apiserver</code> 、 <code>etcd</code> 、 <code>kubelet</code> はサーバ証明書を利用</li>
<li><code>kube-apiserver</code> にアクセスする admin ユーザ、 <code>kube-scheduler</code> 、 <code>kube-controller-manager</code> 、 <code>kube-proxy</code> 、 <code>kubelet</code> はクライアント証明書を利用</li>
<li><code>kubelet</code> 、 <code>etcd</code> にアクセスする <code>kube-apiserver</code> はクライアント証明書を利用</li>
</ul>
<h4 ref="413-鍵証明書の作成方法" >4.1.3. 鍵・証明書の作成方法</h4><a class="anchor" id="413-鍵証明書の作成方法"></a>
<p>上記の通り、サーバ・クライアント証明書が必要な訳だが、それらを管理する認証局/CA を Kubernetes クラスタに作成する必要がある。<br>
まずは、 CA の準備をする。</p>
<ul>
<li>CA の秘密鍵の作成： <code>openssl genrsa 2048 -out ca.key</code></li>
<li>CA の CSR の作成： <code>openssl req -new -key ca.key -subj &quot;/CN=KUBERNETES-CA&quot; -out ca.csr</code></li>
<li>CA の ルート証明書の作成： <code>openssl x509 -req -in ca.csr -signkey ca.key -out ca.crt</code>
<ul>
<li>CA 自身が署名する自己証明書となる</li>
</ul>
</li>
</ul>
<p>なお、 <code>etcd</code> には別途 CA が必要であるため注意が必要。<br>
次に admin ユーザのクライアント証明書を作成する。</p>
<ul>
<li>admin ユーザの秘密鍵の作成： <code>openssl genrsa 2048 -out admin.key</code></li>
<li>admin ユーザの CSR の作成： <code>openssl req -new -key admin.key -subj &quot;/CN=kube-admin/O=system:masters&quot; -out admin.csr</code>
<ul>
<li><code>system:masters</code> の権限で <code>kube-admin</code> アカウントの要求になる</li>
</ul>
</li>
<li>admin ユーザのクライアント証明書の作成： <code>openssl x509 -req -in admin.csr -CA ca.crt -CAkey ca.key -out admin.crt</code>
<ul>
<li>CA に署名してもらう</li>
</ul>
</li>
</ul>
<p>上記の要領で他のクライアント証明書も作成する。<br>
なお、以上で作成した鍵・証明書を用いて kube-admin が <code>kube-apiserver</code> にアクセスする際は以下のようになる。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl https://kube-apiserver:6443/api/v1/pods <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --key admin.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --cert admin.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --cacert ca.crt
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml:kube-config.yaml" data-lang="yaml:kube-config.yaml"><span style="display:flex;"><span><span style="color:#75715e"># kubectl を使う場合の kube-config.yaml の設定例</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">clusters</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">cluster</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">certificate-authority</span>: <span style="color:#ae81ff">ca.crt</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span>: <span style="color:#ae81ff">https://kube-apiserver:6443</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubernetes</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Config</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">users</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubernetes-admin</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">user</span>: 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">client-certificate</span>: <span style="color:#ae81ff">admin.crt</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">client-key</span>: <span style="color:#ae81ff">admin.key</span>
</span></span></code></pre></div><p>次に <code>kube-apiserver</code> のサーバ証明書を作成する。<br>
（あまり知られていないが <code>kube-apiserver</code> のホスト名は <code>kubernetes</code>）<br>
（つまり、 <code>kubernetes</code> 、 <code>kubernetes.default</code> 、 <code>kubernetes.defalt.svc.cluster.local</code> のような感じで扱われる）</p>
<ul>
<li><code>kube-apiserver</code> の秘密鍵の作成： <code>openssl genrsa 2048 -out apiserver.key</code></li>
<li><code>kube-apiserver</code> の CSR の作成： <code>openssl req -new -key apiserver.key -subj &quot;/CN=kube-apiserver&quot; -out apiserver.csr</code></li>
<li><code>kube-apiserver</code> の サーバ証明書の作成： <code>openssl x509 -req -in apiserver.csr -CA ca.crt -CAkey ca.key -out apiserver.crt</code>
<ul>
<li>CA に署名してもらう</li>
</ul>
</li>
</ul>
<p>なお、<code>kube-apiserver</code> でサーバ証明書を作成する際は <code>openssl.cnf</code> ファイルで以下のように設定しておく必要がある。（ <code>alt_names</code> に注目 ）</p>
<pre tabindex="0"><code class="language-txt:openssl.cnf" data-lang="txt:openssl.cnf">[req]
req_extensions = v3_req
[ v3_req ]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation,
subjectAltName = @alt_names
[alt_names]
DNS.1 = kubernetes
DNS.2 = kubernetes.default
DNS.3 = kubernetes.default.svc
DNS.4 = kubernetes.default.svc.cluster.local
IP.1 = 10.96.0.1   # GlobalIP
IP.2 = 172.17.0.87 # PriveteIP
</code></pre><p>以上のように作成した鍵・証明書を <code>apiserver.service</code> の起動オプションに付与する必要がある。<br>
他のサーバ証明書も同じ要領で作る。</p>
<h4 ref="414-鍵証明書情報の確認方法" >4.1.4. 鍵・証明書情報の確認方法</h4><a class="anchor" id="414-鍵証明書情報の確認方法"></a>
<p>上記のような鍵・証明書を含めた Master/Worker Nodes の構築をスクラッチで行うのは所謂 <strong>The Hard Way</strong> 。<br>
ここでは、 <code>kubeadm</code> を用いて作成した場合の鍵・証明書情報の確認方法について見てみる。</p>
<ul>
<li><code>etc/kubernetes/manifests/</code> 配下に Static Pod として作成されたコンポーネントのマニフェストがある
<ul>
<li>kube-apiserver.yaml 、など</li>
<li>上記の yaml ファイルを確認すれば <code>spec.containers.command</code> に起動コマンドのオプションがあるので、そこで鍵・証明書のパスを確認できる</li>
</ul>
</li>
<li><code>openssl x509 -in /etc/kubernetes/pki/apiserver.crt -txt -noout</code> コマンドで中身が確認できる</li>
<li>以下に各コンポーネントの鍵・証明書の配置や発行者などを一覧化した Excel がある
<ul>
<li><a href="https://github.com/mmumshad/kubernetes-the-hard-way/tree/master/tools">https://github.com/mmumshad/kubernetes-the-hard-way/tree/master/tools</a></li>
</ul>
</li>
</ul>
<h4 ref="415-certificate-api" >4.1.5. Certificate API</h4><a class="anchor" id="415-certificate-api"></a>
<p>jane というユーザが新規に admin ユーザになる場合を想定する。</p>
<ul>
<li>jane の秘密鍵を作成する： <code>openssl genrsa 2048 -out jane.key</code></li>
<li>jane の CSR を作成する： <code>openssl req -new -key jane.key -subj &quot;/CN=jane&quot; -out jane.csr</code></li>
<li>jane の CertificateSigningRequest を作成する： <code>kubectl apply -f jane-csr.yaml</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml:jane-csr.yaml" data-lang="yaml:jane-csr.yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">certificates.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">CertificateSigningRequest</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jane</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">signerName</span>: <span style="color:#ae81ff">kubernetes.io/kube-apiserver-client</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">groups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">system:authenticated</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">usages</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">digital signature</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">key encipherment</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">server auth</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">request</span>: [ <span style="color:#ae81ff">cat jane.csr | base64 の結果 ]</span>
</span></span></code></pre></div><p>参考： <a href="https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/#kubernetes-signers">Kubernetes signers</a></p>
<ul>
<li><code>kubectl get csr</code>
<ul>
<li>Pendding の jane を確認</li>
</ul>
</li>
<li><code>kubectl certificate approve jane</code> ：承認
<ul>
<li>ちなみに <code>kubectl certificate deny jane</code> で却下できる</li>
</ul>
</li>
<li><code>kubectl get csr jane -o yaml</code> ：クライアント証明書の取得</li>
<li>クライアント証明書は Base64 になっているので <code>echo &lt;cert_base64&gt; | base64 --decode</code> でデコード</li>
</ul>
<p>なお、上記の Certificate API は <code>kube-controller-manager</code> によって管理されているので、<code>kube-controller-manager</code> の起動オプション <code>--cluster-signing-cert-file</code> および <code>--cluster-signing-key-file</code> にそれぞれ CA のルート証明書と秘密鍵を設定しておく必要がある。</p>
<h3 ref="42-kubeconfig" >4.2. KubeConfig</h3><a class="anchor" id="42-kubeconfig"></a>
<p>デフォルトでは <code>$HOME/.kube/config</code> にある。<br>
内容は大きく <code>clusters</code> 、 <code>users</code> 、 <code>contexts</code> の 3 領域ある。</p>
<ul>
<li><code>clusters</code> ：アクセス先のクラスタ情報
<ul>
<li>エンドポイントなどの情報はここ</li>
</ul>
</li>
<li><code>users</code> ：アクセス先クラスタのユーザ情報
<ul>
<li>鍵・証明書などの情報はここ</li>
</ul>
</li>
<li><code>contexts</code> ： <code>clusters</code> と <code>users</code> の組合せ</li>
</ul>
<pre tabindex="0"><code class="language-yaml:config" data-lang="yaml:config">apiVersion: v1
kind: Config
current-context: ...

clusters:
- name: my-kube-playgroud # ▲
  cluster:
    certificate-authority: /path/to/ca.crt # certificate-authority-data: でベタ貼りもおk
    server: https://my-kube-playgroud:6443
users:
- name: my-kube-admin # ●
  user:
    client-certificate: /path/to/admin.crt
    client-key: /path/to/admin.key

- name: my-kube-admin@my-kube-playground
  context:
    cluster: my-kube-playgroud # ▲
    user: my-kube-admin        # ●
    namespace: ...
</code></pre><ul>
<li><code>kubectl config view</code> コマンドで KubeConfig 情報を閲覧できる</li>
<li><code>kubectl config user-context &lt;context&gt;</code> で current-context の変更</li>
</ul>
<h3 ref="43-rbac" >4.3. RBAC</h3><a class="anchor" id="43-rbac"></a>
<h4 ref="431-role-と-rolebinding" >4.3.1. Role と RoleBinding</h4><a class="anchor" id="431-role-と-rolebinding"></a>
<p>以下のマニフェストで <code>Role</code> を作成できる。（ <code>kubectl apply -f developer-role.yaml</code> ）</p>
<pre tabindex="0"><code class="language-yaml:" data-lang="yaml:">apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: developer
  namespace: default
rules:
- apiGroups: [&#34;&#34;]
  resources: [&#34;pods&#34;]
  verbs: [&#34;list&#34;, &#34;get&#34;, &#34;create&#34;, &#34;update&#34;, &#34;delete&#34;]
- apiGroups: [&#34;&#34;]
  resources: [&#34;ConfigMap&#34;]
  verbs: [&#34;create&#34;]
</code></pre><p><code>Role</code> は <code>namespace</code> 毎に有効となる。<br>
次に上記で作成した <code>Role</code> を <code>User</code> に紐づけるための <code>RoleBinding</code> を作成する。（ <code>kubectl apply -f devuser-developer-binding.yaml</code> ）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml:devuser-developer-binding.yaml" data-lang="yaml:devuser-developer-binding.yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">RoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">devuser-developer-binding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">User</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dev-user</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">developer</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span></code></pre></div><p>以上で <code>Role</code> および <code>RoleBinding</code> は作成できる。<br>
なお、繰り返しになるが、 <code>Role</code> は <code>namespace</code> 毎に有効となるため、 <code>pods</code> や <code>services</code> などの <code>namespace</code> を指定して作成するオブジェクトが対象となる。<br>
これらは以下のコマンドで確認する。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Role の確認</span>
</span></span><span style="display:flex;"><span>$ kubectl get roles
</span></span><span style="display:flex;"><span>$ kubectl describe role developer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># RoleBinding の確認</span>
</span></span><span style="display:flex;"><span>$ kubectl get rolebindings
</span></span><span style="display:flex;"><span>$ kubectl describe rolebinding devuser-developer-binding
</span></span></code></pre></div><p>なお、各ユーザは自分の権限を以下のコマンドで確認できる。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl auth can-i create deployments
</span></span><span style="display:flex;"><span>yes
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>$ kubectl auth can-i delete nodes
</span></span><span style="display:flex;"><span>no
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>$ kubectl auth can-i create deployments --as dev-user
</span></span><span style="display:flex;"><span>no
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>$ kubectl auth can-i create pods --as dev-user
</span></span><span style="display:flex;"><span>yes
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>$ kubectl auth can-i create pods --as dev-user --namespace test
</span></span><span style="display:flex;"><span>no
</span></span></code></pre></div><p>なお、 <code>kubectl api-resources</code> コマンドを利用するとリソースの一覧が取得できる。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl api-resources
</span></span><span style="display:flex;"><span>NAME                              SHORTNAMES   APIVERSION                             NAMESPACED   KIND
</span></span><span style="display:flex;"><span>bindings                                       v1                                     true         Binding
</span></span><span style="display:flex;"><span>componentstatuses                 cs           v1                                     false        ComponentStatus
</span></span><span style="display:flex;"><span>configmaps                        cm           v1                                     true         ConfigMap
</span></span><span style="display:flex;"><span>endpoints                         ep           v1                                     true         Endpoints
</span></span><span style="display:flex;"><span>events                            ev           v1                                     true         Event
</span></span><span style="display:flex;"><span>limitranges                       limits       v1                                     true         LimitRange
</span></span><span style="display:flex;"><span>namespaces                        ns           v1                                     false        Namespace
</span></span><span style="display:flex;"><span>（省略）
</span></span></code></pre></div><h4 ref="432-clusterrole-と-clusterrolebinding" >4.3.2. ClusterRole と ClusterRoleBinding</h4><a class="anchor" id="432-clusterrole-と-clusterrolebinding"></a>
<p><code>namespace</code> 毎に作成するオブジェクトに対して指定する <code>Role</code> に対して、 <code>ClusterRole</code> はクラスタ横断（ <code>namespace</code> 横断）のオブジェクトに対して指定する。<br>
<code>nodes</code> や <code>PV</code> などである。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml:cluster-admin-role.yaml" data-lang="yaml:cluster-admin-role.yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-administrator</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;nodes&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;create&#34;</span>, <span style="color:#e6db74">&#34;delete&#34;</span>]
</span></span></code></pre></div><p>次に上記で作成した <code>ClusterRole</code> を <code>User</code> に紐づけるための <code>ClusterRoleBinding</code> を作成する。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml:cluster-admin-role-binding.yaml" data-lang="yaml:cluster-admin-role-binding.yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-admin-role-binding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">User</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-admin</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-administrator</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span></code></pre></div><h3 ref="44-image-security" >4.4. Image Security</h3><a class="anchor" id="44-image-security"></a>
<p>普段マニフェストに記載している <code>image: nginx</code> は省略系で、フルで記載すると <code>image: docker.io/nginx/nginx</code> となる。（なお、 <code>docker.io</code> は Docker Hub の URL）<br>
フォーマットとは <code>image: &lt;Registry&gt;/&lt;User Account&gt;/&lt;Image Repository&gt;</code> で <code>nginx</code> は <code>&lt;Image Repository&gt;</code> のみ記載している。<br>
Private Registory を利用する場合、認証が必要になるが、その際はどうするのか？<br>
以下の通り <code>Secret</code> を利用することになる。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Private Registory 認証用の Secret 作成</span>
</span></span><span style="display:flex;"><span>$ kubectl create secret docker-registry regcred <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --docker-server<span style="color:#f92672">=</span>private-registry.io <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --docker-username<span style="color:#f92672">=</span>registry-user <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --docker-password<span style="color:#f92672">=</span>registry-password <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --docker-email<span style="color:#f92672">=</span>registry-user@org.com
</span></span></code></pre></div><p>上記の Secret を Pod のマニフェストの <code>spec.imagePullSecrets</code> に指定する。</p>
<h3 ref="45-security-context" >4.5. Security Context</h3><a class="anchor" id="45-security-context"></a>
<p>Pod マニフェストの <code>securityContext</code> 項目を設定することにより、コンテナで実行されるプロセスの実行ユーザなどを指定することができる。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">runAsUser</span>: <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">runAsGroup</span>: <span style="color:#ae81ff">3000</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">fsGroup</span>: <span style="color:#ae81ff">2000</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">fsGroupChangePolicy</span>: <span style="color:#e6db74">&#34;OnRootMismatch&#34;</span>
</span></span></code></pre></div><p>なお、ユーザを指定しない場合は <code>root</code> ユーザとなる。</p>
<h3 ref="46-network-policy" >4.6. Network Policy</h3><a class="anchor" id="46-network-policy"></a>
<p>NetworkPolicy を適用すれば、 Pod に対して Inress / Egress のトラフィックを制限することができる。<br>
なお、 NetworkPolicy を適用しない場合、全てのトラフィックが許可される。</p>
<ul>
<li>Ingress
<ul>
<li>自分から見て、リクエストを送信するトラフィック</li>
<li>Egress に対するレスポンスは Ingress でないことに注意</li>
</ul>
</li>
<li>Egress
<ul>
<li>自分から見て、リクエストを送信するトラフィック</li>
<li>Ingress に対するレスポンスは Egress でないことに注意</li>
</ul>
</li>
</ul>
<p>例えば、以下の NetworkPolicy は Port 3306 の DB サーバに対して、 api-server からのトラフィックを許可し、その他は遮断するポリシー。<br>
（バックアップ用に DB から cidr:192.168.5.10/32 帯にある Port 80 にアクセスできるようにしている。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">NetworkPolicy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">db-policy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podSelector</span>:     <span style="color:#75715e"># policy を適用する Pod の選択</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">role</span>: <span style="color:#ae81ff">db</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">policyTypes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">Egress</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ingress</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">from</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">podSelector</span>: <span style="color:#75715e"># Ingress を許可する Pod の選択</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">api-pod</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">namespaceSelector</span>: <span style="color:#75715e"># 「-」を見れば分かるがこのルールは上記の PodSelector と and 条件</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">prod</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">ipBlock</span>: <span style="color:#75715e"># これは or 条件</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cidr</span>: <span style="color:#ae81ff">192.168.5.10</span><span style="color:#ae81ff">/32</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:          <span style="color:#75715e"># Ingress を許可する Port</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">3306</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">egress</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">to</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">ipBlock</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cidr</span>: <span style="color:#ae81ff">192.168.5.10</span><span style="color:#ae81ff">/32</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><p>ネットワークソリューションによっては NetworkPolicy をサポートしていないものがあるので注意。（例えば、 Flannel ）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl get networkpolicies
</span></span></code></pre></div>
		</div>






	
	

      </section>

      
      
    </article>
    
    
    <footer>
      

		
	
			
		
	    	
	  	
	
    </footer>
    



  </body>
</html>
