

<!DOCTYPE html>
<html>
  <head>
    <title>
	マニフェスト :: テックまとめ
</title>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="revised" content="2021-06-28T23:13:04 JST">
<meta name="description" content="備忘録用メモサイト">



<title>マニフェスト :: テックまとめ</title>

<link rel="shortcut icon" href='/images/favicon.png' type="image/x-icon" />

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css">

<script src='https://code.jquery.com/jquery-3.5.1.min.js'></script>

<link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel="stylesheet">



<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/layout.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/css/style.main.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/css/style.menu.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/notice.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/tabs.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/panel.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/columns.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/children.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/attachments.css'>
<link rel="stylesheet" type="text/css" href='https://tanakakns.github.io/sass/shortcodes/alert.css'>
<link rel="stylesheet" type="text/css" href='/css/docport.css'>

<script src='/js/docport.js'></script>
<script type="text/javascript">
      var baseurl = "https:\/\/tanakakns.github.io\/";
</script>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-42388425-3', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
  </head>

  <body data-url="/kubernetes/manifest/"

  class="hidetoc hidenextpage ">

<style type="text/css">
  #debug{
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    line-height: 3.5rem;
    margin-bottom: .35rem;
    padding: 0 2rem;
    position: fixed;
    left: 0;      right: 0;     top: 0;
   
    top:0px;
    
    min-height: 150px;

    background-color: white;
    border: 3px solid red;
    z-index: 10000 ;
    word-wrap: all;
    overflow: auto;
  }
</style>
 


    
    
    <header style="">
        <div>
    
    <div class="burger ">
        <a href="javascript:void(0);" style="font-size:15px;" onclick="$('article > aside').toggleClass('responsive')">&#9776;</a>
    </div>
    

    <div>

		
	
			
		
	    	<a class='baselink' href='https://tanakakns.github.io/'>テックまとめ</a>
	  	
	</div>

</div>
    </header>
    

    <article>
      
      <aside class="">
        

		
	
			
		
	    	
	  	
	<div id="close_menu">
  <a href="javascript:void(0);" style="font-size:15px;" onclick="$('article > aside').toggleClass('responsive')">
      <i class="fa fa-lg fa-times"></i>
  </a>
</div>

<ul class="menu">

    <li data-nav-id="https://tanakakns.github.io/design/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/design/">設計</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/design/architecture/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/design/architecture/">アーキテクチャ</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/mac/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/mac/">Mac開発環境</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/mac/os-settings/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/mac/os-settings/">OSの設定</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/mac/homebrew/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/mac/homebrew/">Homebrew</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/mac/asdf/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/mac/asdf/">asdf</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/git/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/git/">Git</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/git/initial-setting/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/git/initial-setting/">初期設定</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/go/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/go/">Go言語</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/go/initial-setting/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/go/initial-setting/">初期設定</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/go/grammar/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/go/grammar/">文法</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/go/naming/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/go/naming/">命名規則</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/go/pattern/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/go/pattern/">パターン</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/database/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/database/">Database</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/database/rdb/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/database/rdb/">RDB</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/aws/" class="dd-item
        item_level_$level
        ">

      
      
      
      
        
      
          <a href="/aws/">AWS</a>
      
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/gcp/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/gcp/">GCP</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/gcp-aws/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/gcp-aws/">GCP と AWS の比較</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/monitoring/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/monitoring/">監視</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/tools/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/tools/">ツール</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/tools/management-tools/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/tools/management-tools/">管理ツール</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/tools/dev-tools/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/tools/dev-tools/">開発ツール</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/access-control-and-security/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/access-control-and-security/">アクセス制御とセキュリティ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/">コンピューティングとホスティング</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/compute-engine/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/compute-engine/">Compute Engine</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/kubernetes-engine/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/kubernetes-engine/">Google Kubernetes Engine</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/app-engine/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/app-engine/">App Engine</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/computing-hosting/cloud-functions/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/computing-hosting/cloud-functions/">Cloud Functions</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/storage/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/storage/">ストレージ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/">データベース</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/bigquery/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/bigquery/">BigQuery</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/sql/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/sql/">Cloud SQL</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/memorystore/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/memorystore/">Memorystore</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/databases/spanner/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/databases/spanner/">Cloud Spanner</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/">ネットワーキング</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/vpc/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/vpc/">VPC</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/load-balancing/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/load-balancing/">Cloud Load Balancing</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/iap/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/iap/">Identity-Aware Proxy</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/networking/interconnect/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/networking/interconnect/">Cloud Interconnect</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/big-data/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/big-data/">ビッグデータ</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/big-data/pubsub/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/big-data/pubsub/">Cloud Pub/Sub</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/big-data/dataflow/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/big-data/dataflow/">Dataflow</a>
      
        
      
    </li>
        </ul>
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/gcp/machine-learning/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/gcp/machine-learning/">機械学習</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/terraform/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/terraform/">Terraform</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/terraform/basic/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/terraform/basic/">入門</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/docker/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/docker/">Docker</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/docker/basic/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/docker/basic/">入門</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/kubernetes/" class="dd-item parent haschildren
        item_level_$level
        ">

      
      
      
      
          <i class="fas fa-chevron-down ddexp"></i>
        
      
          <a href="/kubernetes/">Kubernetes</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/concept/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/concept/">概念整理</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/architecture/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/architecture/">アーキテクチャ</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/kubectl-plugin/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/kubectl-plugin/">kubectl plugin と Krew</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/command/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/command/">コマンド</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/manifest/" class="dd-item parent active
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/manifest/">マニフェスト</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/kubernetes/administration/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/kubernetes/administration/">クラスタ管理</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://tanakakns.github.io/istio/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/istio/">Istio</a>
      
        <ul>
              

    <li data-nav-id="https://tanakakns.github.io/istio/basic/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/istio/basic/">入門</a>
      
        
      
    </li>
              

    <li data-nav-id="https://tanakakns.github.io/istio/concept/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/istio/concept/">概念整理</a>
      
        
      
    </li>
        </ul>
    </li>
    



</ul>

		
	
			
		
	    	
	  	
	
      </aside>
      

      <section class="page ">
      
	
		
    
    
    <nav id="ariane" aria-label="breadcrumb">
      <ol class="ariane">
        
  
  	
		
  
  	
	<li >
      <a class="text-link" href="https://tanakakns.github.io/">
        
      </a>
    </li>
	
  
    <li class="">
      <a class="text-link" href="/kubernetes/">
        Kubernetes
      </a>
    </li>
	
  	
  
    <li class="active">
      
        マニフェスト
      
    </li>

      </ol>
    </nav>
    
    

    
		
        
		
		
		
		
		
		
		

		
			<h1>マニフェスト</h1>
        

		
										
		

		
	

	
	
	






	<div class="content">
	    <p>kubernetes では <code>kubectl</code> に様々コマンドがあるが、基本的には <code>kubectl create/delete/apply</code> コマンドと <strong>マニフェスト</strong> とよぶ YAML/JSON ファイルを使用することで、リソースの作成/削除/更新できる。</p>
<ol>
<li><a href="#1-%E3%83%9E%E3%83%8B%E3%83%95%E3%82%A7%E3%82%B9%E3%83%88%E9%9B%9B%E5%BD%A2">マニフェストの雛形</a></li>
<li><a href="#2-%E3%83%9E%E3%83%8B%E3%83%95%E3%82%A7%E3%82%B9%E3%83%88%E7%90%86%E8%A7%A3">マニフェストの理解</a></li>
<li>その他のリソース</li>
</ol>
<ul>
<li><a href="https://kubernetes.io/ja/docs/reference/">Kubernetes リファレンス</a></li>
<li><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/">マニフェスト リファリンス</a></li>
</ul>
<h2 ref="1-マニフェストの雛形" >1. マニフェストの雛形</h2><a class="anchor" id="1-マニフェストの雛形"></a>
<p>ドライラン（ <code>kubectl run/create --dry-run=client</code> ）と yaml 表示（ <code>-o yaml</code> / <code>--output=yaml</code> を）組み合わせるとマニフェストの雛形を標準出力できる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#ae81ff">$ kubectl run sample --image=nginx --dry-run=client -o yaml</span>

<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">creationTimestamp</span>: <span style="color:#66d9ef">null</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">run</span>: <span style="color:#ae81ff">sample</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sample</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">run</span>: <span style="color:#ae81ff">sample</span>
  <span style="color:#f92672">strategy</span>: {}
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">creationTimestamp</span>: <span style="color:#66d9ef">null</span>
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">run</span>: <span style="color:#ae81ff">sample</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx</span>
        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sample</span>
        <span style="color:#f92672">resources</span>: {}
<span style="color:#f92672">status</span>: {}
</code></pre></div><ul>
<li>pod
<ul>
<li><code>kubectl run mypod --image=nginx --labels=app=mypod --output=yaml --dry-run=client</code>
<ul>
<li><code>--restart=Never</code> を付けなくても Pod になるっぽい</li>
<li><code>--expose</code> オプションをつけると ClusterIP も作成される</li>
</ul>
</li>
</ul>
</li>
<li>deployment
<ul>
<li><code>kubectl create deployment mydeploy --image=nginx --replicas=4 --output=yaml --dry-run=client</code></li>
</ul>
</li>
<li>job
<ul>
<li><code>--restart=OnFailure</code> を付けると Job になる</li>
<li><code>kubectl run myjob --restart=OnFailure --image=ubuntu --output=yaml --dry-run=client -- echo hello</code></li>
</ul>
</li>
<li>cronjob
<ul>
<li><code>--schedule</code> を付けると CronJob になる</li>
<li><code>kubectl run mycron --schedule &quot;1 * * * *&quot; --image=nginx --output=yaml --dry-run=client</code></li>
</ul>
</li>
<li>service / clusterIP
<ul>
<li><code>kubectl create svc clusterip myapp --tcp=80 --output=yaml --dry-run=client</code>
<ul>
<li>これだと <code>selector</code> は作成されない</li>
</ul>
</li>
<li><code>kubectl expose pod redis --port=6379 --name redis-service --dry-run=client -o yaml</code>
<ul>
<li>こうすると <code>selector</code> も勝手に作成してくれる</li>
</ul>
</li>
</ul>
</li>
<li>configmap
<ul>
<li><code>kubectl create cm mycm --from-literal mykey=myval --output=yaml --dry-run=client</code></li>
<li><code>--from-file</code> でファイルを指定した場合ちゃんとインデントしてくれる</li>
<li><code>kubectl create cm mycm --from-file myfile.yaml --output=yaml --dry-run=client</code></li>
</ul>
</li>
<li>secret
<ul>
<li>値は base64 エンコードされているので編集に注意</li>
<li><code>kubectl create secret generic mysecret --from-literal mykey=myval --output=yaml --dry-run=client</code></li>
</ul>
</li>
<li>serviceaccount
<ul>
<li><code>kubectl create serviceaccount mysc --output=yaml --dry-run=client</code></li>
</ul>
</li>
<li>clusterrolebinding
<ul>
<li><code>kubectl create clusterrolebinding myclusterrolebinding --clusterrole=edit --serviceaccount default:mysc --output=yaml --dry-run=client</code></li>
</ul>
</li>
<li>rolebinding
<ul>
<li><code>kubectl create rolebinding cluster-admin-binding --role=edit --serviceaccount default:mysc --output=yaml --dry-run=client</code></li>
</ul>
</li>
<li>poddisruptionbudget
<ul>
<li><code>kubectl create pdb my-pdb --selector=app=nginx --min-available=1 --output=yaml --dry-run=client</code></li>
</ul>
</li>
</ul>
<h2 ref="2-マニフェストの理解" >2. マニフェストの理解</h2><a class="anchor" id="2-マニフェストの理解"></a>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml:sample-pod.yml" data-lang="yaml:sample-pod.yml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sample-pod</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">containers</span>:
    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
      <span style="color:#f92672">imege</span>: <span style="color:#ae81ff">nginx:1.7.9</span>
      <span style="color:#f92672">ports</span>:
        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</code></pre></div><p>全てのマニフェストには以下の項目が含まれる。</p>
<ul>
<li>apiVersion
<ul>
<li>API のバージョン</li>
</ul>
</li>
<li>kind
<ul>
<li>リソースの種類</li>
</ul>
</li>
<li>metadata
<ul>
<li>リソースのメタデータ</li>
</ul>
</li>
</ul>
<p>Pod の場合は <code>spec</code> 以下に Pod の内容を定義する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl create -f sample-pod.yaml
pod <span style="color:#e6db74">&#34;sample-pod&#34;</span> created

$ kubectl apply -f sample-pod.yaml
pod <span style="color:#e6db74">&#34;sample-pod&#34;</span> configured

$ kubectl delete -f sample-pod.yaml
pod <span style="color:#e6db74">&#34;sample-pod&#34;</span> deleted
</code></pre></div><p><code>kubectl apply</code> は <strong>マニフェストに変更がある場合のみ変更処理を行う</strong> 。<br>
削除済みのマニフェストに対しても差分を検出するため、新規作成でも <code>apply</code> を使用するほうがよい。<br>
また、マニフェストには複数のリソースを同時に記述することができ、 <strong><code>---</code></strong> で区切る。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml:sample-pod.yml" data-lang="yaml:sample-pod.yml">---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sample-pod</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">containers</span>:
    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
      <span style="color:#f92672">imege</span>: <span style="color:#ae81ff">nginx:1.7.9</span>
      <span style="color:#f92672">ports</span>:
        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#75715e"># LBの追加など</span>
</code></pre></div><p>また、複数のマニフェストファイルを一気に適用したい場合は、ディレクトリにまとめ <code>-f</code> で指定して実行することができる。<br>
その際、ファイル名辞書順で実行されることに注意。</p>
<h3 ref="21-label-と-annotation" >2.1. Label と Annotation</h3><a class="anchor" id="21-label-と-annotation"></a>
<p>両者とも key-value 形式（ <code>key: value</code> ）でデータを保持する仕組みであるが、用途が異なる。</p>
<h4 ref="211-label" >2.1.1. Label</h4><a class="anchor" id="211-label"></a>
<ul>
<li>各リソースの <code>metadata</code> で設定する</li>
<li>あるリソースが 1 つ以上のリソースを管理する場合、 <code>selector</code> にて Label を指定することにより対象リソースを発見する
<ul>
<li>ReplicaSet が Pod を管理する場合</li>
<li>Deployment が ReplicaSet を管理する場合</li>
<li>Service が受けた通信の転送先 Pod を指定する場合、など</li>
</ul>
</li>
</ul>
<h4 ref="212-annotation" >2.1.2. Annotation</h4><a class="anchor" id="212-annotation"></a>
<ul>
<li>リソースオブジェクトに関する不特定の情報を保存する方法
<ul>
<li>オブジェクトの変更理由の記録</li>
<li>特別なスケジューラへの、特別なスケジュールポリシーの伝達</li>
<li>リソースを更新したツールと、それがどのように更新したかの情報の付加</li>
<li>他のツールからの更新検知などのため</li>
<li>Deployment オブジェクトによるロールアウトのための、ReplicaSet の追跡情報の保存、など</li>
</ul>
</li>
</ul>
<h3 ref="22-namespace" >2.2. namespace</h3><a class="anchor" id="22-namespace"></a>
<p>namespace は k8s クラスタ上で論理的にシステムを分割する仕組み。<br>
namespace リソース（ <code>kind: Namespace</code> ）を作成し、各リソースの <code>metadata</code> にラベル付け（ <code>namespace: test</code> ）して利用する。</p>
<h3 ref="23-deployment" >2.3. Deployment</h3><a class="anchor" id="23-deployment"></a>
<p>リソースには色々あるが、理解すべきリソースは少ない。そのうちの一つ。<br>
（その他は、Service、DaemonSet、CronJobくらい？）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">app/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>: <span style="color:#75715e"># https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#objectmeta-v1-meta</span>
  <span style="color:#f92672">annotations</span>:                <span style="color:#75715e"># 任意のメタデータを保存および取得する。外部ツールなどによって設定・変更・保存される箇所でもある。</span>
    <span style="color:#f92672">key</span>: <span style="color:#ae81ff">value</span>
  <span style="color:#f92672">clusterName</span>: <span style="color:#ae81ff">string        </span> <span style="color:#75715e"># オブジェクトが所属するクラスタ名。異なるクラスターで同じ名前と名前空間を持つリソースを区別するために使用。使わない。</span>
  <span style="color:#f92672">creationTimestamp</span>:          <span style="color:#75715e"># このオブジェクトが作成されたサーバ時間。変更できない。</span>
  <span style="color:#f92672">deletionGracePeriodSeconds</span>: <span style="color:#75715e"># オブジェクトの正常終了までの時間。読み取り専用。</span>
  <span style="color:#f92672">deletionTimestamp</span>:          <span style="color:#75715e"># オブジェクトが削除される時間。読み取り専用。</span>
  <span style="color:#f92672">finalizers</span>:                 <span style="color:#75715e"># リストからエントリを削除する責任のあるコンポーネントの識別子。削除のみ可能。</span>
  <span style="color:#f92672">generateName</span>:               <span style="color:#75715e"># name が設定されていない場合にのみオプションで設定される名前。</span>
  <span style="color:#f92672">generation</span>:                 <span style="color:#75715e"># 状態の世代を表す。読み取り専用。</span>
  <span style="color:#f92672">initializers</span>:               <span style="color:#75715e"># オブジェクトの作成時にシステムの不変条件を強制するコントローラー。DEPRECATED。</span>
  <span style="color:#f92672">labels</span>:                     <span style="color:#75715e"># ReplicaSet、Service の selector で利用。</span>
    <span style="color:#f92672">key</span>: <span style="color:#ae81ff">value</span>
  <span style="color:#f92672">managedFields</span>:              <span style="color:#75715e"># 内部のワークフロー用でユーザは設定・理解の必要はない。</span>
  <span style="color:#f92672">name</span>:                       <span style="color:#75715e"># namespace 内で一意なオブジェクトの名前。</span>
  <span style="color:#f92672">namespace</span>:                  <span style="color:#75715e"># 名前空間名。空は default と同じ。 DNS_LABEL である必要があり、変更できない。</span>
  <span style="color:#f92672">ownerReferences</span>:            <span style="color:#75715e"># このオブジェクトに依存するオブジェクトのリスト。コントローラにより管理される。</span>
  <span style="color:#f92672">resourceVersion</span>:            <span style="color:#75715e"># オブジェクトがいつ変更されたかを判断するためにクライアントが使用できるこのオブジェクトの内部バージョン。読み取り専用。</span>
  <span style="color:#f92672">selfLink</span>:                   <span style="color:#75715e"># このオブジェクトを表すURL。読み取り専用。</span>
  <span style="color:#f92672">uid</span>:                        <span style="color:#75715e"># このオブジェクトの一意な ID 。システムにより管理される。</span>
<span style="color:#f92672">spec</span>: <span style="color:#75715e"># https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#deploymentspec-v1-apps</span>
  <span style="color:#f92672">minReadySeconds</span>:         <span style="color:#75715e"># コンテナがクラッシュすることなく、新しく作成されたポッドの準備が整うまでの最小秒数。デフォルト 0 。</span>
  <span style="color:#f92672">paused</span>: <span style="color:#ae81ff">bool            </span> <span style="color:#75715e"># 展開が一時停止されていることを示す。</span>
  <span style="color:#f92672">progressDeadlineSeconds</span>: <span style="color:#75715e"># 展開が失敗したと見なされるまで最大秒数。</span>
  <span style="color:#f92672">replicas</span>:                <span style="color:#75715e"># Pod のリプリケーション数。</span>
  <span style="color:#f92672">revisionHistoryLimit</span>:    <span style="color:#75715e"># ロールバックを許可するReplicaSetの世代数。デフォルト 10 。</span>
  <span style="color:#f92672">selector</span>: <span style="color:#75715e"># https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#labelselector-v1-meta</span>
            <span style="color:#75715e"># ReplicaSet が Pod を選択するための Label Selector 。</span>
    <span style="color:#f92672">matchExpressions</span>: <span style="color:#75715e"># https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#labelselectorrequirement-v1-meta</span>
                      <span style="color:#75715e"># Label Selector のリスト。 AND で評価される。</span>
    <span style="color:#f92672">matchLabels</span>:      <span style="color:#75715e"># key-value 形式の Label Selector のリスト。 AND で評価される。matchExpressions の方が複雑な表現が可能。</span>
  <span style="color:#f92672">strategy</span>: <span style="color:#75715e"># https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#deploymentstrategy-v1-apps</span>
            <span style="color:#75715e"># 新しいポッドに置き換えるため展開戦略。現状は単純な再配置とローリングアップデートのみ。</span>
    <span style="color:#f92672">rollingUpdate</span>: <span style="color:#75715e"># https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#rollingupdatedeployment-v1-apps</span>
      <span style="color:#f92672">maxSurge</span>:       <span style="color:#75715e"># Pod のレプリケーション数を超えて作成できるコンテナの最大数。数か割合で表現。</span>
      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#75715e"># Pod のレプリケーション数を下回って利用できなくする最大数。数か割合で表現。</span>
    <span style="color:#f92672">type</span>: <span style="color:#75715e"># Recreate か RollingUpdate 。デフォルト RollingUpdate 。</span>
  <span style="color:#f92672">template</span>: <span style="color:#75715e"># https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#podtemplatespec-v1-core</span>
            <span style="color:#75715e"># 作成する Pod の定義</span>
    <span style="color:#f92672">metadata</span>: <span style="color:#75715e"># 先の metadata に同じ。</span>
    <span style="color:#f92672">spec</span>: <span style="color:#75715e"># https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#podspec-v1-core</span>
      <span style="color:#f92672">activeDeadlineSeconds</span>: <span style="color:#75715e"># Pod が非アクティブになってから強制終了されるまでの秒数。</span>
      <span style="color:#f92672">affinity</span>: <span style="color:#75715e"># https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#affinity-v1-core</span>
                <span style="color:#75715e"># Pod をスケジューリングする際の制約。</span>
      <span style="color:#f92672">automountServiceAccountToken</span>: <span style="color:#75715e"># サービスアカウントトークンを自動的にマウントする必要があるかどうかを示す。</span>
      <span style="color:#f92672">containers</span>: <span style="color:#75715e"># https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#container-v1-core</span>
                  <span style="color:#75715e"># Pod に属するコンテナのリスト。</span>
        <span style="color:#f92672">args</span>:                     <span style="color:#75715e"># ENTRYPOINT へ引数。</span>
        <span style="color:#f92672">command</span>:                  <span style="color:#75715e"># ENTRYPOINT 配列。</span>
        <span style="color:#f92672">env</span>:                      <span style="color:#75715e"># 環境変数のリスト。</span>
        <span style="color:#f92672">envFrom</span>:                  <span style="color:#75715e"># 環境変数を設定するソースのリスト。</span>
        <span style="color:#f92672">image</span>:                    <span style="color:#75715e"># Docker イメージ名。</span>
        <span style="color:#f92672">imagePullPolicy</span>:          <span style="color:#75715e"># Docker イメージの pull ポリシー。 Always, Never, IfNotPresent のいずれか。</span>
        <span style="color:#f92672">lifecycle</span>:                <span style="color:#75715e"># コンテナのライフサイクルイベントに応じて管理システムが実行するアクション。</span>
        <span style="color:#f92672">livenessProbe</span>:            <span style="color:#75715e"># コンテナ死活の定期的な調査。</span>
        <span style="color:#f92672">name</span>:                     <span style="color:#75715e"># コンテナ名。DNS_LABEL となる。</span>
        <span style="color:#f92672">ports</span>:                    <span style="color:#75715e"># コンテナの公開ポートのリスト。</span>
        <span style="color:#f92672">readinessProbe</span>:           <span style="color:#75715e"># コンテナサービスの準備状況の定期的な調査。</span>
        <span style="color:#f92672">resources</span>:                <span style="color:#75715e"># コンテナが利用するコンピュートリソース。</span>
        <span style="color:#f92672">securityContext</span>:          <span style="color:#75715e"># Pod を実行するセキュリティオプション。</span>
        <span style="color:#f92672">stdin</span>:                    <span style="color:#75715e"># コンテナがコンテナーランタイムで標準入力にバッファーを割り当てるかどうか。デフォルト false は EOF になる。</span>
        <span style="color:#f92672">stdinOnce</span>:                <span style="color:#75715e"># 単一の接続によって開かれた後に、コンテナランタイムがstdinチャネルを閉じるかどうか。デフォルト false 。</span>
        <span style="color:#f92672">terminationMessagePath</span>:   <span style="color:#75715e"># オプション：コンテナの終了メッセージが書き込まれるファイルがコンテナのファイルシステムにマウントされるパス。</span>
        <span style="color:#f92672">terminationMessagePolicy</span>: <span style="color:#75715e"># 終了メッセージの入力方法。</span>
        <span style="color:#f92672">tty</span>:                      <span style="color:#75715e"># コンテナに TTY を割り当てるか否か。デフォルト false 。</span>
        <span style="color:#f92672">volumeDevices</span>:            <span style="color:#75715e"># コンテナが使用するブロックデバイスのリスト。</span>
        <span style="color:#f92672">volumeMounts</span>:             <span style="color:#75715e"># コンテナのファイルシステムにマウントするポッドボリューム。</span>
        <span style="color:#f92672">workingDir</span>:               <span style="color:#75715e"># コンテナの作業ディレクトリ。</span>
      <span style="color:#f92672">dnsConfig</span>: <span style="color:#75715e"># https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#poddnsconfig-v1-core</span>
        <span style="color:#f92672">nameservers</span>: <span style="color:#75715e"># DNSネームサーバーのIPアドレスのリスト。</span>
        <span style="color:#f92672">options</span>:     <span style="color:#75715e"># DNSリゾルバーオプションのリスト。</span>
        <span style="color:#f92672">searches</span>:    <span style="color:#75715e"># ホスト名検索用のDNS検索ドメインのリスト。</span>
      <span style="color:#f92672">dnsPolicy</span>:   <span style="color:#75715e"># Pod の DNS ポリシー。ClusterFirstWithHostNet, ClusterFirst（デフォルト）, Default, None 。</span>
      <span style="color:#f92672">enableServiceLinks</span>: <span style="color:#75715e"># サービスに関する情報をDockerリンクの構文と一致する Pod の環境変数に注入するか否か。デフォルト true 。</span>
      <span style="color:#f92672">hostAliases</span>: <span style="color:#75715e"># https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#hostalias-v1-core</span>
                   <span style="color:#75715e"># Pod の hosts ファイルへの追加設定。</span>
      <span style="color:#f92672">hostIPC</span>:     <span style="color:#75715e"># ホストの IPC 名前空間を使うか否か。デフォルト false 。</span>
      <span style="color:#f92672">hostNetwork</span>: <span style="color:#75715e"># Pod に要求されたホストネットワーキング。ホストのネットワーク名前空間を使用。デフォルト false 。</span>
      <span style="color:#f92672">hostPID</span>:     <span style="color:#75715e"># ホストの PID 名前空間を利用するか否か。デフォルト false 。</span>
      <span style="color:#f92672">hostname</span>:    <span style="color:#75715e"># Pod のホスト名。指定しない場合システムが付与。</span>
      <span style="color:#f92672">imagePullSecrets</span>: <span style="color:#75715e"># https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#localobjectreference-v1-core</span>
                        <span style="color:#75715e"># Docker イメージを Pull する際のシークレット。</span>
      <span style="color:#f92672">initContainers</span>:    <span style="color:#75715e"># Pod に属する初期化コンテナのリスト。コンテナが開始される前に順番に実行される。</span>
      <span style="color:#f92672">nodeName</span>:          <span style="color:#75715e"># Pod を特定のノードへスケジューリングする。</span>
      <span style="color:#f92672">nodeSelector</span>:      <span style="color:#75715e"># Pod を配置するノードのセレクタ。</span>
      <span style="color:#f92672">overhead</span>:          <span style="color:#75715e"># 特定の RuntimeClass の Pod の実行に関連するリソースオーバーヘッドを表す。コントローラにより自動入力される。</span>
      <span style="color:#f92672">preemptionPolicy</span>:  <span style="color:#75715e"># 優先度の低い Pod を先取りするポリシー。</span>
      <span style="color:#f92672">priority</span>:          <span style="color:#75715e"># 優先度の値。値が大きいほど優先度が高い。</span>
      <span style="color:#f92672">priorityClassName</span>: <span style="color:#75715e"># Pod の優先順位を示す。</span>
      <span style="color:#f92672">readinessGates</span>: <span style="color:#75715e"># https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#podreadinessgate-v1-core</span>
                      <span style="color:#75715e"># Pod の準備状況を評価する。</span>
      <span style="color:#f92672">restartPolicy</span>:    <span style="color:#75715e"># Pod 内の全てのコンテナの再起動ポリシー。</span>
      <span style="color:#f92672">runtimeClassName</span>: <span style="color:#75715e"># Pod 実行に使用する RuntimeClass オブジェクト。</span>
      <span style="color:#f92672">schedulerName</span>:    <span style="color:#75715e"># Pod を管理するスケジューラ。</span>
      <span style="color:#f92672">securityContext</span>: <span style="color:#75715e"># https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#podsecuritycontext-v1-core</span>
                       <span style="color:#75715e"># Pod レベルのセキュリティ属性。</span>
      <span style="color:#f92672">serviceAccount</span>:                <span style="color:#75715e"># Deprecated</span>
      <span style="color:#f92672">serviceAccountName</span>:            <span style="color:#75715e"># Pod の実行に使用する ServiceAccount 名。</span>
      <span style="color:#f92672">shareProcessNamespace</span>:         <span style="color:#75715e"># Pod 内の全てのコンテナ間で PID 空間を共有する。デフォルト false 。</span>
      <span style="color:#f92672">subdomain</span>:                     <span style="color:#75715e"># サブドメインを指定する。&#34;&lt;hostname&gt;.&lt;subdomain&gt;.&lt;pod namespace&gt;.svc.&lt;cluster domain&gt;&#34; 。</span>
      <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#75715e"># Pod が Graceful Stop するのに要する秒数。デフォルト 30 秒。</span>
      <span style="color:#f92672">tolerations</span>: <span style="color:#75715e"># https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#toleration-v1-core</span>
                   <span style="color:#75715e"># Pod を特定のノードに配置する際に利用。 nodeSelector の方が古い。</span>
      <span style="color:#f92672">volumes</span>: <span style="color:#75715e"># https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#volume-v1-core</span>
               <span style="color:#75715e"># マウントできるボリュームのリスト。</span>
</code></pre></div><p>上記、すごい量だが、必要最低限は。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">app/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">&lt;key&gt;</span>: <span style="color:#ae81ff">&lt;value&gt;</span>
  <span style="color:#f92672">labels</span>:                  <span style="color:#75715e"># Deployment の Label</span>
    <span style="color:#f92672">&lt;key&gt;</span>: <span style="color:#ae81ff">&lt;value&gt;</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">&lt;string&gt;          </span> <span style="color:#75715e"># Deployment 名</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">&lt;string&gt;     </span> <span style="color:#75715e"># Deployment の namespace</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">&lt;integer&gt;     </span> <span style="color:#75715e"># ReplicaSet のレプリカ数。</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">&lt;key1&gt;</span>: <span style="color:#ae81ff">&lt;value1&gt;    </span> <span style="color:#75715e"># ReplicaSet の対象セレクタ。以下の Pod 定義 の Label に一致させる。</span>
  <span style="color:#f92672">template</span>:                <span style="color:#75715e"># Pod 定義</span>
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:              <span style="color:#75715e"># Pod の Label</span>
        <span style="color:#f92672">&lt;key1&gt;</span>: <span style="color:#ae81ff">&lt;value1&gt;</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">&lt;string&gt;   </span> <span style="color:#75715e"># Pod に利用するコンテナイメージ</span>
        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">&lt;string&gt;    </span> <span style="color:#75715e"># Pod 名</span>
        <span style="color:#f92672">ports</span>:
        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">&lt;string&gt;</span> <span style="color:#75715e"># Docker イメージの pull ポリシー。 Always（常にpull）, Never（ローカルのみ）, IfNotPresent（ローカルに無ければpull）</span>
        <span style="color:#f92672">livenessProbe</span>:            <span style="color:#75715e"># コンテナ死活の定期的な調査。</span>
        <span style="color:#f92672">readinessProbe</span>:           <span style="color:#75715e"># コンテナサービスの準備状況の定期的な調査。</span>
        <span style="color:#f92672">resources</span>: {}
</code></pre></div><p>ケースによっては追加で以下を意識する必要がある。</p>
<ul>
<li>spec.strategy</li>
<li>spec.template.spec.affinity : <a href="https://qiita.com/sheepland/items/ed12b3dc4a8f1df7c4ec">参考</a></li>
</ul>
<p><code>livenessProbe</code>、<code>readinessProbe</code> については <a href="https://kubernetes.io/ja/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/">こちら</a> 。</p>
<p>また、 Pod の <code>spec.nodeName</code> を指定することで、スケジューラに任せず手動で Pod の配置ノードを指定することができる。</p>
<h3 ref="24-pod" >2.4. Pod</h3><a class="anchor" id="24-pod"></a>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">core/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
<span style="color:#f92672">metadata</span>: <span style="color:#75715e"># 先の metadata に同じ。</span>
<span style="color:#f92672">spec</span>:     <span style="color:#75715e"># 先の Deployment の spec.template.spec に同じ。</span>
<span style="color:#f92672">status</span>:   <span style="color:#75715e"># https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#podstatus-v1-core</span>
</code></pre></div><p>pod のマニフェストに以下を足したものが ReplicaSet 。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">spec</span>:
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">&lt;integer&gt;</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">&lt;key1&gt;</span>: <span style="color:#ae81ff">&lt;value1&gt;</span>
  <span style="color:#f92672">template</span>:
      <span style="color:#ae81ff">&lt;podの定義に同じ&gt;</span>
</code></pre></div><p>なお、 ReplicaSet はマニフェスト上はほぼ Deployment に同じ。</p>
<h4 ref="241-taints-tolerations" >2.4.1. Taints, Tolerations</h4><a class="anchor" id="241-taints-tolerations"></a>
<p>Taints / Tolerations は Node Affinity と逆の機能。<br>
<strong>Taints</strong> は「汚れ」、 <strong>Tolerations</strong> は「寛容」といった意味になる。<br>
Taints は Node に付与し、 Tolerations は Pod に付与する。<br>
つまり、 Nodeに「汚れ」をつければ、それに「寛容」な Pod しかスケジュールされないということ。<br>
注意したいのは、スケジュールされることを <strong>許容するだけで引きつけるわけではない</strong> ということ。<br>
Taints / Tolerations は以下の項目で設定できる。</p>
<ul>
<li>Key-Value
<ul>
<li>Labels と同様</li>
</ul>
</li>
<li>Effect
<ul>
<li>以下のような効果がある
<ul>
<li><code>NoSchedule</code> ：TaintとTolerationがマッチした場合にのみに、PodがNodeにスケジューリングされる。</li>
<li><code>PreferNoSchedule</code> ： <code>NoSchedule</code> の緩いバージョン。どうしても行き場のなくなった Pod は受け入れる。</li>
<li><code>NoExecute</code> ：基本的に <code>NoSchedule</code> と同じだが、条件に合わない Pod がすでに実行中の場合は追い出す。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Node に Taints を付与する場合は以下のコマンドを実行する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl taint nodes node1 key1<span style="color:#f92672">=</span>value1:NoSchedule

<span style="color:#75715e"># ちなみに最後に（ - ）をつけるとその taint を削除できる</span>
$ kubectl taint nodes node1 key1<span style="color:#f92672">=</span>value1:NoSchedule-
</code></pre></div><p>Pod に Tolerations を付与する場合はマニフェストの <code>spec.tolerations</code> に以下を記述する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">tolerations</span>:
- <span style="color:#f92672">key</span>: <span style="color:#e6db74">&#34;key1&#34;</span>
  <span style="color:#f92672">operator</span>: <span style="color:#e6db74">&#34;Equal&#34;</span>
  <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;value1&#34;</span>
  <span style="color:#f92672">effect</span>: <span style="color:#e6db74">&#34;NoSchedule&#34;</span>
</code></pre></div><h4 ref="242-node-selectors" >2.4.2. Node Selectors</h4><a class="anchor" id="242-node-selectors"></a>
<p>Pod を特定の Node にスケジュールしたい場合 <strong>Node Selectors</strong> を利用する。<br>
Node に Labels を付与し、 Pod の <code>nodeSelector</code> にその Labels を付与することで設定できる。<br>
Node に Labels を付与するコマンドは以下の通り。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># USAGE: kubectl label nodes &lt;node-name&gt; &lt;label-key&gt;=&lt;label-value&gt;</span>
$ kubectl label nodes node-1 size<span style="color:#f92672">=</span>Large
</code></pre></div><p>また、 Pod のマニフェストの <code>spec.nodeSelector</code> に以下を設定する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">nodeSelector</span>:
  <span style="color:#f92672">size</span>: <span style="color:#ae81ff">Large</span>
</code></pre></div><p>Node Selectors は <code>size=Large</code> もしくは <code>size=Middle</code> のどちらか、といった柔軟性のあるスケジュールはできない。<br>
こういう場合は Node Affinity を使う。</p>
<h4 ref="243-node-affinity" >2.4.3. Node Affinity</h4><a class="anchor" id="243-node-affinity"></a>
<p><strong>Node Affinity</strong> は Pod に対して設定し、 Node Selector と同様 Node に付与された Labels を見る。<br>
Pod のマニフェストの <code>spec.affinity</code> に以下の設定をする。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">affinity</span>:
  <span style="color:#f92672">nodeAffinity</span>:
    <span style="color:#f92672">requiredDuringSchedulingIgnoredDuringExecution</span>:
      <span style="color:#f92672">nodeSelectorTerms</span>:
      - <span style="color:#f92672">matchExpressions</span>:
        - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">size</span>
          <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
          <span style="color:#f92672">values</span>:
          - <span style="color:#ae81ff">Large</span>
</code></pre></div><p>3 行目の長ったらしいのは <strong>NodeAffinityType</strong>。以下の種類がある。<br>
（ <code>DuringScheduling</code> と <code>DuringExecution</code> に <code>required</code> / <code>preferred</code> / <code>Ignored</code> が修飾されていることに注目。）</p>
<ul>
<li>requiredDuringSchedulingIgnoredDuringExecution
<ul>
<li>必ず Affinity の通りにスケジュールされるが、すでに実行中のものは再スケジュールされない</li>
</ul>
</li>
<li>preferredDuringSchedulingIgnoredDuringExecution
<ul>
<li>できるだけ Affinity の通りにスケジュールされるが、すでに実行中のものは再スケジュールされない</li>
</ul>
</li>
<li>requiredDuringSchedulingRequiredDuringExecution
<ul>
<li>必ず Affinity の通りにスケジュールされ、さらに、すでに実行中のものは再スケジュールされる</li>
</ul>
</li>
</ul>
<h4 ref="244-resource-requirements" >2.4.4. Resource Requirements</h4><a class="anchor" id="244-resource-requirements"></a>
<p><code>spec.containers.resources</code> を設定することで、 Pod に割り当てるリソース（ CPU/Mem/Disk ）の要求について記載することができる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">resources</span>:
  <span style="color:#f92672">requests</span>:
    <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
    <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">64Mi</span>
  <span style="color:#f92672">limits</span>:
    <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">2</span>
    <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">1Gi</span>
</code></pre></div><p><code>resuests</code> は下限、 <code>limits</code> は上限と理解すればいい。<br>
なお、デフォルトでは、 <code>requests</code> は <code>CPU=0.5</code> / <code>Mem=256Mi</code> 、 <code>limits</code> は <code>CPU=1</code> / <code>Mem=512Mi</code> となる。
<code>CPU=1</code> は 1 vCPU や 1 core や 1 Hyperthread を意味し、 <code>CPU=1=1000m</code> となる。<br>
また、 Mem については以下の通り。</p>
<ul>
<li>1G = 1,000,000,000 bytes</li>
<li>1M = 1,000,000 bytes</li>
<li>1K = 1,000 bytes</li>
<li>1Gi = 1,073,741,824 bytes</li>
<li>1Mi = 1,048,576 bytes</li>
<li>1Ki = 1,024 bytes</li>
</ul>
<h4 ref="245-static-pod" >2.4.5. Static Pod</h4><a class="anchor" id="245-static-pod"></a>
<p>Kubernetes の Master Nodes の機能がなかった場合でも、 <code>kubelet</code> は単独で Pod を起動することができる。（ DaemonSet や Service など Pod 以外は出来ない）<br>
この Pod を <strong>Static Pod</strong> と呼ぶ。
Static Pod の作成方法は以下の通り。</p>
<ul>
<li><code>kubelet.service</code> プロセス実行時のオプションに <code>--pod-manifest-path</code> というオプションがあり、このパスに Pod のマニフェストを配置することにより Static Pod を実行することができる。
<ul>
<li><code>/etc/Kubernetes/manifest</code> あたり</li>
</ul>
</li>
<li>もしくは、<code>kubelet.service</code> プロセス実行時のオプションに <code>--config</code> オプションがあり、ここで指定された設定の yaml ファイルの中の <code>staticPodPath</code> という設定項目になる</li>
<li>上記で確認した Path にマニフェストファイルを配置すれば自動で作成される（作成されなければ <code>systemctl restart kubelet</code> で再起動）</li>
<li>作成された Static Pod は「<!-- raw HTML omitted -->-<!-- raw HTML omitted -->」というふうに suffix にノード名が付与される</li>
</ul>
<p>Master Nodes が機能している場合、 <code>kubelet</code> は自動的に各 Static Pod に対応する mirror pod を <code>kube-apiserver</code> 上に作成するため、 <code>kubectl get</code> などでも見ることができる。<br>
Master Nodes が機能していない場合、作成された Static Pod は <code>docker ps</code> コマンドで確認できる。<br>
Master Nodes が機能している・いないにかかわらず、 Static Pod に対する変更は各 Static Pod が配置されている Node のマニフェストファイルを変更する他ない。<br>
<code>kube-apiserver</code> に何らかの問題が発生しても機能継続できるように、 Master Nodes のコンポーネントで Static Pod により構成されているものがある。</p>
<h4 ref="246-multiple-scheduler" >2.4.6. Multiple Scheduler</h4><a class="anchor" id="246-multiple-scheduler"></a>
<p><code>kube-scheduler</code> は複数起動することができる。<br>
複数のスケジューラがある場合、 Pod のマニフェストにて <code>spec.schedulerName</code> でスケジューラ名を指定することにより目的のスケジューラによって処理させることができる。<br>
スケジューラを起動する際、以下のオプションを指定することで、スケジューラに命名およびリーダーの選出が可能になる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-second-scheduler</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">gcr.io/my-gcp-project/my-kube-scheduler:1.0</span>
        <span style="color:#f92672">command</span>:
        - <span style="color:#ae81ff">/usr/local/bin/kube-scheduler</span>
        - --<span style="color:#ae81ff">address=0.0.0.0</span>
        - --<span style="color:#ae81ff">leader-elect=false         </span> <span style="color:#75715e"># リーダー選出対象外</span>
        - --<span style="color:#ae81ff">scheduler-name=my-scheduler</span> <span style="color:#75715e"># スケジューラの命名</span>
</code></pre></div><h4 ref="247-lifecycle--lifecycle-events--lifecycle-handler" >2.4.7. Lifecycle / Lifecycle Events / Lifecycle Handler</h4><a class="anchor" id="247-lifecycle--lifecycle-events--lifecycle-handler"></a>
<p>Pod には <a href="https://kubernetes.io/ja/docs/concepts/workloads/pods/pod-lifecycle/">のライフサイクル</a> がり、 <code>status.phase</code> は Pod のライフサイクルにおけるフェーズを表しており、 Pod の状態を確認する上で重要となる。</p>
<table>
<thead>
<tr>
<th style="text-align:left">値</th>
<th style="text-align:left">概要</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Pending</td>
<td style="text-align:left">PodがKubernetesシステムによって承認されが、コンテナの作成が完了していない状態。スケジュール・イメージダウンロード中などの状態。</td>
</tr>
<tr>
<td style="text-align:left">Running</td>
<td style="text-align:left">PodがNodeにバインドされ、少なくとも 1 つのコンテナが作成され、開始・実行・再起動中の状態。</td>
</tr>
<tr>
<td style="text-align:left">Succeeded</td>
<td style="text-align:left">JobなどのPod内のすべてのコンテナが正常に終了し、再起動も発生していない状態。</td>
</tr>
<tr>
<td style="text-align:left">Failed</td>
<td style="text-align:left">Pod内のすべてのコンテナが終了し、少なくとも1つのコンテナが異常終了した状態。コンテナはゼロ以外のステータスで終了したか、システムによって終了された状態。</td>
</tr>
<tr>
<td style="text-align:left">Unknown</td>
<td style="text-align:left">何らかの理由により、通常はPodのホストとの通信にエラーが発生したために、Podの状態を取得できなかった。</td>
</tr>
</tbody>
</table>
<p>上記のようなフェーズを決定するために、 Kubernetes では以下の 2 種類の <strong>ヘルスチェック</strong> がある。</p>
<ul>
<li>Liveness Probe
<ul>
<li>Pod が正常に動作しているかの確認</li>
<li>失敗した場合、 Pod は再起動される</li>
</ul>
</li>
<li>Readiness Probe
<ul>
<li>Pod がサービスインする準備が出来ているかの確認</li>
<li>失敗した場合、 Pod にトラフィックが流れず、再起動されることもない（サービスインされるまで待つ）</li>
</ul>
</li>
</ul>
<p>上記の設定はデフォルトではされておらず、通常は Service/LoadBalancer から Node への ICMP による簡易的なチェックしか実施されていない。<br>
そのため、 Pod の状態に応じたサービスの健全性を保つために上記の設定が必要になる。<br>
Liveness/Readiness Probe の双方で以下の 3 種類のヘルスチェックを設定できる。<br>
ヘルスチェックは kubelet からコンテナ毎に行われ、どれか 1 つのコンテナでも失敗した場合には Pod 全体が失敗とみなされる。</p>
<ul>
<li>exec
<ul>
<li>コマンドを実行し、終了コードが 0 でなければ失敗</li>
<li>例</li>
</ul>
<pre><code>livenessProbe:
  exec:
    command: [&quot;ls&quot;, &quot;/usr/sbin/nginx&quot;]
</code></pre></li>
<li>httpGet
<ul>
<li>HTTP GET リクエストを実行し、 Status Code が 200 〜 300 でなければ失敗</li>
<li>例</li>
</ul>
<pre><code>libenessProbe:
  httpGet:
    path: /health
    port: 80
    scheme: HTTP
    host: web.example.com
    httpHeaders:
    - name: Authorization
      value: Bearer TOKEN
</code></pre></li>
<li>tcpSocket
<ul>
<li>TCP セッションが確立できなければ失敗</li>
<li>例</li>
</ul>
<pre><code>linenessProbe:
  tcpSocket:
    port: 80
</code></pre></li>
</ul>
<p>また、コンテナが開始された際とPodが削除される際にHookして任意の処理を実行することが出来る以下の Lifecycle Events がある。</p>
<ul>
<li>postStart
<ul>
<li>コンテナが作成された後、即座に実行される</li>
<li>このHandlerが失敗した場合終了させ、 restartPolicy に従い再起動させる</li>
</ul>
</li>
<li>preStop
<ul>
<li>コンテナが終了される前に実行される</li>
<li>コンテナのルートプロセスに対して SIGTERM が送出される前にこのHandlerが実行される</li>
</ul>
</li>
</ul>
<p>postStart や preStop に指定できる Lifecycle Handler の種類は以下の通り。</p>
<ul>
<li>exec : コンテナ内でコマンドを実行</li>
<li>httpGet : HTTPのGETリクエストを発行</li>
</ul>
<p>先の probe と同様だ。</p>
<h3 ref="25-service" >2.5. Service</h3><a class="anchor" id="25-service"></a>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">metadata</span>: <span style="color:#75715e"># 先の metadata に同じ。</span>
<span style="color:#f92672">spec</span>: <span style="color:#75715e"># https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#servicespec-v1-core</span>
  <span style="color:#f92672">clusterIP</span>:
  <span style="color:#f92672">externalIPs</span>:
  <span style="color:#f92672">externalName</span>:
  <span style="color:#f92672">externalTrafficPolicy</span>:
  <span style="color:#f92672">healthCheckNodePort</span>:
  <span style="color:#f92672">loadBalancerIP</span>:
  <span style="color:#f92672">loadBalancerSourceRanges</span>:
  <span style="color:#f92672">ports</span>:
  <span style="color:#f92672">publishNotReadyAddresses</span>:
  <span style="color:#f92672">selector</span>:
  <span style="color:#f92672">sessionAffinity</span>:
  <span style="color:#f92672">sessionAffinityConfig</span>:
  <span style="color:#f92672">type</span>: <span style="color:#75715e"># ExternalName 、 ClusterIP （デフォルト）、 NodePort 、および LoadBalancer 。</span>
</code></pre></div><p>色々設定があるが、 ClusterIP の場合は以下くらいでいい。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">&lt;key&gt;</span>: <span style="color:#ae81ff">&lt;value&gt;</span>
  <span style="color:#f92672">labels</span>:             <span style="color:#75715e"># Service の Label</span>
    <span style="color:#f92672">&lt;key&gt;</span>: <span style="color:#ae81ff">&lt;value&gt;</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">&lt;string&gt;     </span> <span style="color:#75715e"># Service 名</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">&lt;string&gt;</span> <span style="color:#75715e"># Service の namespace</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">&lt;key&gt;</span>: <span style="color:#ae81ff">&lt;value&gt;   </span> <span style="color:#75715e"># 通信を流す Pod の Label をセレクタで指定</span>
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP    </span> <span style="color:#75715e"># Service が受信するプロトコルとポートマッピング</span>
    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>          <span style="color:#75715e"># Service が受信 Port</span>
    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">9376</span>  <span style="color:#75715e"># Pod の Port</span>
</code></pre></div><p>Service の <code>selector</code> の設定が正しく Pod を捉えているかどうかは <code>kubectl get pods --selector=&quot;app=monolith,secure=enabled&quot;</code> などのコマンドで対象の Pod を取得できるか、で検査できる。</p>
<h3 ref="26-daemonset" >2.6. DaemonSet</h3><a class="anchor" id="26-daemonset"></a>
<p>各 Node に 1 Pod ずつ配置する。<br>
Monitoring/Logging Agent などを仕込むのに最適。（ <code>kube-proxy</code> は DaemonSet で配置されているものもある）<br>
DaemonSet のマニフェストは ReplicaSet のそれに酷似している。<br>
なお、 DaemonSet や ReplicaSet は <code>kubectl create</code> コマンドでは作成できないので、下記のような Deployment 作成コマンドでマニフェストの雛形を作成し、その後 <code>kind</code> を修正するなどして DaemonSet のマニフェストを作成してから apply するとよい。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl create deployment elasticsearch --image<span style="color:#f92672">=</span>k8s.gcr.io/fluentd-elasticsearch:1.20 --namespace<span style="color:#f92672">=</span>kube-system --dry-run<span style="color:#f92672">=</span>client -o yaml &gt; fluent.yaml
</code></pre></div><h3 ref="27-configmap-secrets" >2.7. ConfigMap /Secrets</h3><a class="anchor" id="27-configmap-secrets"></a>
<h4 ref="configmap" >ConfigMap</h4><a class="anchor" id="configmap"></a>
<p>ConfigMap は以下の通りコマンドで作成するか、マニフェストを作成する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># コマンドのみで作成</span>
<span style="color:#75715e"># USAGE: kubectl create configmap &lt;config-name&gt; --from-literal=&lt;key&gt;=&lt;value&gt;</span>
$ kubectl create configmap app-config --from-literal<span style="color:#f92672">=</span>APP_COLOR<span style="color:#f92672">=</span>blue --from-literal<span style="color:#f92672">=</span>APP_MOD<span style="color:#f92672">=</span>prod

<span style="color:#75715e"># マニフェストファイルを利用する場合</span>
<span style="color:#75715e"># USAGE: kubectl create configmap &lt;config-name&gt; --from-file=&lt;file-name&gt;</span>
$ kubectl create configmap app-config --from-file<span style="color:#f92672">=</span>app_config.properties
</code></pre></div><pre><code class="language-txt:app_config.properties" data-lang="txt:app_config.properties">APP_COLOR: blue
APP_MOD: prod
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml:app-config.yaml" data-lang="yaml:app-config.yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">app-config</span>
<span style="color:#f92672">data</span>:
  <span style="color:#f92672">APP_COLOR</span>: <span style="color:#ae81ff">blue</span>
  <span style="color:#f92672">APP_MOD</span>: <span style="color:#ae81ff">prod</span>
</code></pre></div><p>Pod のマニフェストからは以下のように参照する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">spec</span>:
  <span style="color:#f92672">containers</span>:
  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">hoge</span>
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">hoge</span>
    <span style="color:#f92672">envFrom</span>:
    - <span style="color:#f92672">configMapRef</span>:
        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">app-config</span>
</code></pre></div><h4 ref="secret" >Secret</h4><a class="anchor" id="secret"></a>
<p>Secret は以下の通りコマンドで作成するか、マニフェストを作成する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># コマンドのみで作成</span>
<span style="color:#75715e"># USAGE: kubectl create secret generic &lt;secret-name&gt; --from-literal=&lt;key&gt;=&lt;value&gt;</span>
$ kubectl create secret generic app-secret --from-literal<span style="color:#f92672">=</span>APP_COLOR<span style="color:#f92672">=</span>blue --from-literal<span style="color:#f92672">=</span>APP_MOD<span style="color:#f92672">=</span>prod

<span style="color:#75715e"># マニフェストファイルを利用する場合</span>
<span style="color:#75715e"># USAGE: kubectl create secret generic &lt;secret-name&gt; --from-file=&lt;file-name&gt;</span>
$ kubectl create secret generic app-secret --from-file<span style="color:#f92672">=</span>app_secret.properties
</code></pre></div><pre><code class="language-txt:app_secret.properties" data-lang="txt:app_secret.properties">APP_COLOR: blue
APP_MOD: prod
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml:app-secret.yaml" data-lang="yaml:app-secret.yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Secret</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">app-secret</span>
<span style="color:#f92672">data</span>:
  <span style="color:#f92672">APP_COLOR</span>: <span style="color:#ae81ff">blue</span>
  <span style="color:#f92672">APP_MOD</span>: <span style="color:#ae81ff">prod</span>
</code></pre></div><p>ただし、マニフェストファイルに環境変数を記載する際は、 value 値を <code>base64</code> コマンドなどで Base64 化する必要がある。（デコードは <code>base64 --decode</code> ）<br>
Pod のマニフェストからは以下のように参照する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">spec</span>:
  <span style="color:#f92672">containers</span>:
  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">hoge</span>
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">hoge</span>
    <span style="color:#f92672">envFrom</span>:
    - <span style="color:#f92672">secretRef</span>:
        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">app-secret</span>
</code></pre></div><h2 ref="3-その他のリソース" >3. その他のリソース</h2><a class="anchor" id="3-その他のリソース"></a>
<p>基本的なリソース以外に以下について記載する。</p>
<ul>
<li><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/">HPA（HorizontalPodAutoscaler）</a></li>
<li><a href="https://kubernetes.io/docs/tasks/run-application/configure-pdb/">PBD（PodDisruptionBudget）</a></li>
</ul>
<h3 ref="31-hpahorizontalpodautoscaler" >3.1. HPA（HorizontalPodAutoscaler）</h3><a class="anchor" id="31-hpahorizontalpodautoscaler"></a>
<p>HPA は pod の負荷に応じて自動的に pod の数を水平スケールさせるリソース。<br>
Deployment, ReplicaSet, ReplicationController, StatefulSetはscaled resource objectと呼ばれ、これらがauto scalingの対象リソースとなる。</p>
<pre><code class="language-apiVersion:" data-lang="apiVersion:">kind: HorizontalPodAutoscaler
metadata:
  name: php-hpa
  namespace: default
spec:
  scaleTargetRef: # ここでautoscale対象となる`scaled resource object`を指定
    apiVersion: apps/v1
    kind: Deployment
    name: php-deploy
  minReplicas: 1 # 最小レプリカ数
  maxReplicas: 5 # 最大レプリカ数
  metrics:
  - type: Resource
    resource:
      name: cpu
      targetAverageUtilization: 50 # CPU使用率が常に50%になるように指定
</code></pre><p><a href="https://qiita.com/sheepland/items/37ea0b77df9a4b4c9d80">参考</a></p>
<h3 ref="32-pbdpoddisruptionbudget" >3.2. PBD（PodDisruptionBudget）</h3><a class="anchor" id="32-pbdpoddisruptionbudget"></a>
<ul>
<li><code>kubectl drain</code> によって対象 Node から Pod を退去でき、以降も Pod がスケジューリングされないように出来る
<ul>
<li>Node のメンテナンス(reboot)などを行う必要がある場合に kubectl drainを行うと Node で動いている Pod について gracefully に terminate される。また、ReplicaSet を使っていれば別の Node で Pod が自動的に起動される。メンテナンス完了後、kubectl uncordonを行うことで再度 Pod がスケジューリングされる状態になる。</li>
</ul>
</li>
<li>注意点として上記だけでは対象 Node 上で起動している Pod は一度に evicted され、一度に退去させられる可能性がある。例えば ReplicaSet 2 で drain 対象の Node に 2つの Pod が起動していた場合、両方の Pod に対して evicted され、一つも Pod が起動していない時間帯がある可能性が出来てしまう</li>
<li>PodDisruptionBudget(PDB)を定義することで上記を防ぐことが出来る</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">policy/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PodDisruptionBudget</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myapp</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
<span style="color:#f92672">run</span>: <span style="color:#ae81ff">myapp</span>
</code></pre></div><p><a href="https://qiita.com/toshihirock/items/5adaece0206127121551">参考</a></p>
<h2 ref="参考" >参考</h2><a class="anchor" id="参考"></a>
<ul>
<li><a href="https://qiita.com/tkusumi/items/4f63cea4c4d910b368c4">Kubernetes Tips: kubectl でマニフェストの雛形を作る</a></li>
<li><a href="https://qiita.com/bgpat/items/173f33ae2a9e21b24487">Kubernetes流YAML職人になるために</a></li>
</ul>
		</div>






	
	

      </section>

      
      
    </article>
    
    
    <footer>
      

		
	
			
		
	    	
	  	
	
    </footer>
    



  </body>
</html>
